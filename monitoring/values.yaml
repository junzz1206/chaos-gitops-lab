kube-prometheus-stack:
  grafana:
    service:
      type: NodePort
      nodePort: 32000
    sidecar:
      datasources:
        enabled: true
        defaultDatasourceEnabled: true
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki:3100
        access: proxy

# --- Loki 2.9 충돌 해결 설정 ---
loki:
  # [핵심] 모드를 'SingleBinary'로 명확히 지정
  deploymentMode: SingleBinary
  
  # 1. SingleBinary만 1개 띄움
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 10Gi

  # [에러 해결] 충돌나는 다른 모드(Scalable)는 전부 0개로 설정
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0
  ingester:
    replicas: 0
  querier:
    replicas: 0
  queryFrontend:
    replicas: 0
  queryScheduler:
    replicas: 0
  distributor:
    replicas: 0
  compactor:
    replicas: 0
  indexGateway:
    replicas: 0
  bloomCompactor:
    replicas: 0
  bloomGateway:
    replicas: 0

  # 권한 설정 (User 10001)
  podSecurityContext:
    runAsGroup: 10001
    runAsUser: 10001
    fsGroup: 10001
  
  containerSecurityContext:
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop: ["ALL"]
      
  # 기타 잡다한 기능 끄기
  lokiCanary:
    enabled: false
  test:
    enabled: false
  monitoring:
    selfMonitoring:
      enabled: false

promtail:
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
