# --- Kube-Prometheus-Stack ---
kube-prometheus-stack:
  grafana:
    service:
      type: NodePort
      nodePort: 32000
    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
      datasources:
        enabled: true
        defaultDatasourceEnabled: true
    additionalDataSources:
      - name: Loki
        type: loki
        uid: Loki
        url: http://loki:3100
        access: proxy
        jsonData:
          maxLines: 1000
  prometheus:
    service:
      type: NodePort
      nodePort: 32001
  alertmanager:
    service:
      type: NodePort
      nodePort: 32002

# --- Loki (Version 2.9.x Correct Config) ---
loki:
  # 1. Root 권한 제거 -> Loki 전용 유저(10001) 사용
  podSecurityContext:
    runAsGroup: 10001
    runAsUser: 10001
    fsGroup: 10001
  
  containerSecurityContext:
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop: ["ALL"]

  # 2. 불필요한 카나리(Canary) 파드 비활성화
  lokiCanary:
    enabled: false
  
  # 3. 데이터 저장소 설정 (2.9 버전 방식)
  persistence:
    enabled: true
    size: 10Gi
  
  # 4. Loki 설정
  config:
    auth_enabled: false
    common:
      path_prefix: /var/loki
      replication_factor: 1
    storage_config:
      boltdb_shipper:
        active_index_directory: /var/loki/index
        cache_location: /var/loki/index_cache
        shared_store: filesystem
      filesystem:
        directory: /var/loki/chunks
    schema_config:
      configs:
        - from: "2024-01-01"
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: loki_index_
            period: 24h

# --- Promtail ---
promtail:
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
