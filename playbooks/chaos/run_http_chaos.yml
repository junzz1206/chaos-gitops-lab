# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      # íŒŒì¼ êµ¬ë¶„ì„ : ì‹œê°ì  ê°€ë…ì„± í–¥ìƒ
# íŒŒì¼: playbooks/chaos/run_http_chaos.yml                            # íŒŒì¼ ê²½ë¡œ ë° ëª©ì  í‘œì‹œ
# ëª©ì :                                                               # í”Œë ˆì´ë¶ì˜ ì£¼ ëª©ì  ëª…ì‹œ
#   - Chaos Mesh HTTPChaos ë¦¬ì†ŒìŠ¤ë¥¼ í†µí•´ L7(HTTP) íŠ¸ë˜í”½ ì¥ì•  ì£¼ì…   # L7 ë ˆë²¨ Chaos í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
#   - í•˜ë“œì½”ë”© ì™„ì „ ì œê±°: ëª¨ë“  ê°’ì€ í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” ë³€ìˆ˜ë¡œë¶€í„° ìœ ë„   # ì™¸ë¶€ ì œì–´ ê¸°ë°˜ ë™ì  êµ¬ì„±
#   - CI/CD(GitLab, Jenkins, ArgoCD ë“±) í™˜ê²½ì—ì„œ ì™„ì „ ìë™í™” ì‹¤í–‰     # íŒŒì´í”„ë¼ì¸ í†µí•© ê°€ëŠ¥
#   - Chaos Mesh duration ë§Œë£Œ ì‹œ ìë™ ë³µêµ¬                           # Chaos Mesh ìì²´ íƒ€ì´ë¨¸ ë³µêµ¬ ê¸°ëŠ¥ í™œìš©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      # ì‹œê°ì  êµ¬ë¶„ì„  ì¢…ë£Œ

- name: Run HTTP Chaos via Chaos Mesh (Fully Dynamic)                # í”Œë ˆì´ë¶ ì´ë¦„: Chaos Mesh ê¸°ë°˜ HTTPChaos ì‹¤í–‰
  hosts: "{{ lookup('env','TARGET_HOSTS') | default('k3s_master', true) }}"  # ì‹¤í–‰ ëŒ€ìƒ í˜¸ìŠ¤íŠ¸ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¡œë“œ(ê¸°ë³¸ê°’ k3s_master)
  become: yes                                                        # root ê¶Œí•œ ìƒìŠ¹ í•„ìš” (kubectl ë“± ì‹œìŠ¤í…œ ëª…ë ¹ ì‹¤í–‰ìš©)
  vars:                                                              # ë³€ìˆ˜ ì •ì˜ ì‹œì‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • ì•ˆë‚´
    # í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ë™ì  ì„¤ì • (ëª¨ë‘ ì™¸ë¶€ì—ì„œ ì£¼ì…)                 # CI/CDì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ëª¨ë“  ì œì–´ ê°€ëŠ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    target_namespace: "{{ lookup('env','TARGET_NAMESPACE') | default('app', true) }}"  # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ê¸°ë³¸ app)
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default('60s', true) }}"      # Chaos ìœ ì§€ ì‹œê°„ (ì˜ˆ: 60s, 1m)
    http_delay_ms: "{{ lookup('env','HTTP_DELAY_MS') | default('2000', true) }}"       # HTTP ìš”ì²­ ì§€ì—°ì‹œê°„(ms)
    http_abort_percent: "{{ lookup('env','HTTP_ABORT_PERCENT') | default('0', true) }}"# HTTP ì‹¤íŒ¨ìœ¨(%)
    http_port: "{{ lookup('env','HTTP_PORT') | default('8080', true) }}"               # ì„œë¹„ìŠ¤ í¬íŠ¸ ë²ˆí˜¸
    target_services: "{{ lookup('env','TARGET_SERVICES') | default('frontend,checkoutservice', true) }}"  # Chaos ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡(ì½¤ë§ˆ êµ¬ë¶„)
    chaos_log_path: "{{ lookup('env','CHAOS_LOG_PATH') | default('/var/log/chaos_test.log', true) }}"      # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
    chaos_manifest_dir: "{{ lookup('env','CHAOS_MANIFEST_DIR') | default('/tmp/chaos-httpchaos-' ~ lookup('pipe','date +%s'), true) }}" # ë™ì  manifest ë””ë ‰í† ë¦¬ ìƒì„± (timestamp ê¸°ë°˜)
    allowed_namespaces: "{{ lookup('env','ALLOWED_NAMESPACES') | default('app,online-boutique', true) }}"  # í—ˆìš©ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ëª©ë¡(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)

  tasks:                                                             # Ansible ì‹¤í–‰ íƒœìŠ¤í¬ ì„¹ì…˜ ì‹œì‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    # 1ï¸âƒ£ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì „ê²€ì‚¬ (Whitelist)                         # ì•ˆì „í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì œí•œ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Parse allowed namespaces                                 # í—ˆìš© ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
      set_fact:
        allowed_namespace_list: "{{ allowed_namespaces.split(',') | map('trim') | list }}"  # ì½¤ë§ˆ ë¶„ë¦¬ í›„ ê³µë°± ì œê±°
      changed_when: false                                            # ìƒíƒœ ë³€í™”ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ

    - name: Validate target namespace                                # ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ í—ˆìš© ë¦¬ìŠ¤íŠ¸ ë‚´ì¸ì§€ ê²€ì‚¬
      ansible.builtin.assert:
        that:
          - target_namespace in allowed_namespace_list               # target_namespaceê°€ í—ˆìš© ë¦¬ìŠ¤íŠ¸ ë‚´ ì¡´ì¬í•´ì•¼ í•¨
        fail_msg: "âŒ namespace {{ target_namespace }} is not allowed. Allowed: {{ allowed_namespace_list | join(', ') }}"  # ì‹¤íŒ¨ ì‹œ ì¶œë ¥
        success_msg: "âœ… namespace {{ target_namespace }} validated" # ì„±ê³µ ì‹œ ì¶œë ¥

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: ì„œë¹„ìŠ¤ ëª©ë¡ íŒŒì‹±
    # 2ï¸âƒ£ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡ íŒŒì‹±                                      # ì½¤ë§ˆ ë¶„ë¦¬ ë° ë¦¬ìŠ¤íŠ¸í™”
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Parse target services                                    # ì„œë¹„ìŠ¤ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
      ansible.builtin.set_fact:
        target_service_list: "{{ target_services.split(',') | map('trim') | list }}"  # ì½¤ë§ˆë¡œ ë¶„ë¦¬ í›„ ê³µë°± ì œê±°
      changed_when: false                                            # ë³€ê²½ ì—†ìŒ í‘œì‹œ

    - name: Show target services                                     # ë³€í™˜ëœ ì„œë¹„ìŠ¤ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
      ansible.builtin.debug:
        msg: "ğŸ¯ Target Services: {{ target_service_list | join(', ') }}"  # ë¦¬ìŠ¤íŠ¸ë¥¼ ë¬¸ìì—´ë¡œ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: manifest ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
    # 3ï¸âƒ£ Chaos manifest ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±                          # manifest ì €ì¥ìš© ë””ë ‰í† ë¦¬ ë³´ì¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Ensure chaos manifest directory exists                   # chaos manifest ì €ì¥ ë””ë ‰í† ë¦¬ ìƒì„±
      ansible.builtin.file:
        path: "{{ chaos_manifest_dir }}"                             # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê²½ë¡œ
        state: directory                                             # ë””ë ‰í† ë¦¬ í˜•íƒœ ìœ ì§€
        mode: '0755'                                                 # ì½ê¸°/ì‹¤í–‰/ì“°ê¸° ê¶Œí•œ ì§€ì •

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: HTTPChaos manifest ìƒì„±
    # 4ï¸âƒ£ Chaos Mesh HTTPChaos manifest ìƒì„± (ì„œë¹„ìŠ¤ë³„)              # ê° ì„œë¹„ìŠ¤ë³„ë¡œ ê°œë³„ manifest ì‘ì„±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Render HTTPChaos manifests per service                   # ê° ì„œë¹„ìŠ¤ë³„ í…œí”Œë¦¿ ë Œë”ë§
      ansible.builtin.template:
        src: "roles/chaos_network/templates/httpchaos.yml.j2"        # í…œí”Œë¦¿ íŒŒì¼ ê²½ë¡œ
        dest: "{{ chaos_manifest_dir }}/httpchaos-{{ item }}.yml"    # ë Œë”ë§ëœ manifest ì €ì¥ ê²½ë¡œ
      loop: "{{ target_service_list }}"                              # ê° ì„œë¹„ìŠ¤ ì´ë¦„ ë°˜ë³µ
      loop_control:
        loop_var: item                                               # ë£¨í”„ ë³€ìˆ˜ëª… ì„¤ì •
      vars:                                                          # í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤
        namespace: "{{ target_namespace }}"                          # ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì „ë‹¬
        service_name: "{{ item }}"                                   # ì„œë¹„ìŠ¤ëª… ì „ë‹¬
        delay_ms: "{{ http_delay_ms }}"                              # HTTP ì§€ì—°(ms)
        abort_percent: "{{ http_abort_percent }}"                    # HTTP abort ë¹„ìœ¨(%)
        duration: "{{ chaos_duration }}"                             # Chaos ìœ ì§€ ì‹œê°„
        port: "{{ http_port }}"                                      # í¬íŠ¸ ë²ˆí˜¸
        run_id: "{{ lookup('pipe','date +%s') }}"                    # íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ê³ ìœ  ID

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: Chaos Mesh ë¦¬ì†ŒìŠ¤ ì ìš©
    # 5ï¸âƒ£ Chaos Mesh ë¦¬ì†ŒìŠ¤ ì ìš©                                    # ìƒì„±ëœ manifestë¥¼ ì‹¤ì œ í´ëŸ¬ìŠ¤í„°ì— ì ìš©
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Apply HTTPChaos manifests (safe)                         # ì•ˆì „í•˜ê²Œ HTTPChaos ë¦¬ì†ŒìŠ¤ ì ìš©
      ansible.builtin.shell: |                                       # ì…¸ ëª…ë ¹ ì‹¤í–‰ ë¸”ë¡
        files=$(ls {{ chaos_manifest_dir }}/httpchaos-*.yml 2>/dev/null || true)  # manifest íŒŒì¼ ëª©ë¡ í™•ì¸
        if [ -z "$files" ]; then                                     # íŒŒì¼ì´ ì—†ìœ¼ë©´
          echo "No manifests found in {{ chaos_manifest_dir }}"      # ê²½ê³  ì¶œë ¥
          exit 0                                                     # ì •ìƒ ì¢…ë£Œ
        fi
        for f in $files; do                                          # íŒŒì¼ ë°˜ë³µ ì²˜ë¦¬
          echo "[APPLY] $f"                                          # ì ìš© ëŒ€ìƒ ì¶œë ¥
          kubectl apply -f "$f" --namespace {{ target_namespace }}   # Chaos Mesh ë¦¬ì†ŒìŠ¤ ì ìš©
        done
      register: chaos_apply_result                                   # ì‹¤í–‰ ê²°ê³¼ ë“±ë¡
      changed_when: "'No manifests found' not in chaos_apply_result.stdout"  # ë³€ê²½ íŒë‹¨ ì¡°ê±´ ì„¤ì •

    - name: Show apply results                                       # ì ìš© ê²°ê³¼ í‘œì‹œ
      ansible.builtin.debug:
        msg: "{{ chaos_apply_result.stdout_lines | default(['Applied successfully']) }}"  # ê²°ê³¼ ì¶œë ¥

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: ì§€ì†ì‹œê°„ ë³€í™˜ ë¡œì§
    # 6ï¸âƒ£ chaos_duration í¬ë§· ë³€í™˜ (ì´ˆ ë‹¨ìœ„ ê³„ì‚°)                   # ë‹¤ì–‘í•œ ì‹œê°„ ë‹¨ìœ„ ì§€ì›(s/m/h)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Convert chaos_duration to seconds                        # Chaos ì§€ì†ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
      set_fact:
        chaos_seconds: >-                                            # Jinja2 ì¡°ê±´ì‹ ì‚¬ìš©
          {% set d = chaos_duration %}
          {% if d is match('^\\d+s$') %}                             # ì˜ˆ: 60s â†’ 60
            {{ (d | regex_replace('s$','') | int) }}
          {% elif d is match('^\\d+m$') %}                           # ì˜ˆ: 1m â†’ 60
            {{ (d | regex_replace('m$','') | int) * 60 }}
          {% elif d is match('^\\d+h$') %}                           # ì˜ˆ: 1h â†’ 3600
            {{ (d | regex_replace('h$','') | int) * 3600 }}
          {% elif d is match('^\\d+$') %}                            # ìˆ«ìë§Œ ìˆì„ ê²½ìš° ê·¸ëŒ€ë¡œ ì´ˆë¡œ ê°„ì£¼
            {{ d | int }}
          {% else %}                                                 # ì˜ˆì™¸ ì‹œ ê¸°ë³¸ê°’ 60ì´ˆ
            60
          {% endif %}

    - name: Wait for chaos duration                                  # Chaos ìœ ì§€ì‹œê°„ ë™ì•ˆ ëŒ€ê¸°
      ansible.builtin.pause:
        seconds: "{{ chaos_seconds }}"                               # ë³€í™˜ëœ ì´ˆ ë‹¨ìœ„ ì‹œê°„ ì‚¬ìš©

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: Chaos ë¦¬ì†ŒìŠ¤ ì‚­ì œ
    # 7ï¸âƒ£ Chaos Mesh ë¦¬ì†ŒìŠ¤ ì‚­ì œ (ìë™ ë³µêµ¬)                        # HTTPChaos ë¦¬ì†ŒìŠ¤ ì‚­ì œë¡œ ë³µêµ¬ ìˆ˜í–‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Cleanup HTTPChaos resources (safe)                       # HTTPChaos ë¦¬ì†ŒìŠ¤ ì •ë¦¬
      ansible.builtin.shell: |                                       # ì…¸ ëª…ë ¹ ì‹¤í–‰ ë¸”ë¡
        files=$(ls {{ chaos_manifest_dir }}/httpchaos-*.yml 2>/dev/null || true)  # manifest ëª©ë¡ í™•ì¸
        if [ -n "$files" ]; then                                     # íŒŒì¼ ì¡´ì¬ ì‹œ
          for f in $files; do                                        # ë°˜ë³µ ì²˜ë¦¬
            echo "[DELETE] $f"                                       # ì‚­ì œ ëŒ€ìƒ í‘œì‹œ
            kubectl delete -f "$f" --namespace {{ target_namespace }} || true  # ì‚­ì œ ì‹¤íŒ¨ ë¬´ì‹œ
          done
        else
          echo "No manifests to delete"                              # íŒŒì¼ ì—†ì„ ì‹œ ë©”ì‹œì§€ ì¶œë ¥
        fi
      changed_when: true                                             # í•­ìƒ ë³€ê²½ ë°œìƒìœ¼ë¡œ ì²˜ë¦¬

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: Chaos ì‹¤í–‰ ë¡œê·¸ ê¸°ë¡
    # 8ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡                                           # Chaos ì‹¤í–‰ ì´ë ¥ì„ íŒŒì¼ë¡œ ì €ì¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Record chaos execution log                               # Chaos ì‹¤í–‰ ë¡œê·¸ íŒŒì¼ ê¸°ë¡
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"                                 # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
        create: true                                                 # íŒŒì¼ ì—†ì„ ì‹œ ìƒì„±
        line: |                                                      # ë¡œê·¸ ë¼ì¸ ì‘ì„±
          [{{ lookup('pipe','date -Iseconds') }}] HTTPChaos(ns={{ target_namespace }}, duration={{ chaos_duration }}, delay={{ http_delay_ms }}ms, abort={{ http_abort_percent }}%, port={{ http_port }}, targets={{ target_service_list | join(', ') }})
      become: yes                                                    # ë¡œê·¸ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ í™•ë³´

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì£¼ì„ ë¸”ë¡: ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    # 9ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥                                           # ì‹¤í–‰ í›„ ê²°ê³¼ ìš”ì•½ í‘œì‹œ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  # ì‹œê°ì  êµ¬ë¶„

    - name: Final summary                                            # ìš”ì•½ ì¶œë ¥
      ansible.builtin.debug:
        msg: |                                                       # ë‹¤ì¤‘ë¼ì¸ ì¶œë ¥
          âœ… HTTP Chaos Injection Completed                          # ì‹¤í–‰ ì™„ë£Œ í‘œì‹œ
          - Hosts: {{ lookup('env','TARGET_HOSTS') | default('k3s_master', true) }}  # ì‹¤í–‰ ëŒ€ìƒ í˜¸ìŠ¤íŠ¸ í‘œì‹œ
          - Namespace: {{ target_namespace }}                        # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶œë ¥
          - Duration: {{ chaos_duration }} ({{ chaos_seconds }}s)    # Chaos ì§€ì†ì‹œê°„ í‘œì‹œ
          - Delay: {{ http_delay_ms }}ms                             # HTTP ì§€ì—° í‘œì‹œ
          - Abort: {{ http_abort_percent }}%                         # HTTP ì‹¤íŒ¨ìœ¨ í‘œì‹œ
          - Port: {{ http_port }}                                    # í¬íŠ¸ í‘œì‹œ
          - Targets: {{ target_service_list | join(', ') }}          # ì„œë¹„ìŠ¤ ëª©ë¡ í‘œì‹œ
          - Manifest Dir: {{ chaos_manifest_dir }}                   # manifest ê²½ë¡œ í‘œì‹œ
          - Log: {{ chaos_log_path }}                                # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ í‘œì‹œ
