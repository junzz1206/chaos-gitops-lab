# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_chaos_test.yml  # íŒŒì¼ ê²½ë¡œ
# ëª©ì :
#   - Pod, Network, CPU, Service Chaos ë³‘ë ¬ ì‹¤í–‰ (ê° 100ì´ˆ)
#   - internal / external ëª¨ë“œ ëª¨ë‘ ì§€ì›
#   - ë³µêµ¬ ë‹¨ê³„ ì œì™¸ (Chaosë§Œ ìˆ˜í–‰)
#   - CI/CD (ArgoCD, GitLab ë“±) í™˜ê²½ì—ì„œ ì¦‰ì‹œ ì¤‘ë‹¨ ê°€ëŠ¥
#   - í‘œì¤€ ë³€ìˆ˜ëª… ë° ë¡œê·¸ í¬ë§· í†µì¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Execute Full Chaos Workflow (Parallel, CI/CD-safe)  # ë©”ì¸ í”Œë ˆì´ ì´ë¦„
  hosts: k3s_master  # ë§ˆìŠ¤í„° ë…¸ë“œ íƒ€ê²Ÿ
  become: yes  # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
  strategy: free  # ë³‘ë ¬ ì‹¤í–‰ í—ˆìš©

  vars:  # ì£¼ìš” ë³€ìˆ˜ ì •ì˜
    target_namespace: "app"  # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(100, true) | int }}"  # Chaos ìœ ì§€ ì‹œê°„ (ì´ˆ)
    chaos_mode: "{{ lookup('env','CHAOS_MODE') | default('internal', true) }}"  # internal/external ëª¨ë“œ
    network_delay_ms: 300  # ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì‹œê°„ (ms)
    chaos_log_path: "{{ lookup('env','CHAOS_LOG_PATH') | default('/var/log/chaos_test.log', true) }}"  # Chaos ë¡œê·¸ ê²½ë¡œ

  tasks:  # ì‘ì—… ëª©ë¡ ì‹œì‘

    # Step 1ï¸âƒ£: Chaos í…ŒìŠ¤íŠ¸ ì‹œì‘ ì•Œë¦¼
    - name: Announce chaos workflow start  # ì‹œì‘ ë‹¨ê³„ ì•ˆë‚´
      ansible.builtin.debug:
        msg: |  # ë©€í‹°ë¼ì¸ ë©”ì‹œì§€
          === Chaos ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===
          - Namespace: {{ target_namespace }}
          - Duration: {{ chaos_duration }}ì´ˆ
          - Mode: {{ chaos_mode }}
          - Recovery ë‹¨ê³„: ë¹„í™œì„±í™”ë¨ (ìë™ ë³µêµ¬ ì—†ìŒ)

    # Step 2ï¸âƒ£: ë³‘ë ¬ Chaos ì£¼ì… (async â†’ cancel-safe)
    - name: Launch Pod Kill Chaos  # Pod Kill Chaos ì‹¤í–‰
      ansible.builtin.shell: >  # ì…¸ ëª…ë ¹ ì‹¤í–‰
        ansible-playbook {{ playbook_dir }}/run_pod_kill.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "external_mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
        --forks 1
      async: "{{ chaos_duration + 30 }}"  # ë¹„ë™ê¸° ì‹¤í–‰ (duration+30ì´ˆ íƒ€ì„ì•„ì›ƒ)
      poll: 0  # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
      register: pod_job  # ì‘ì—… ID ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ

    - name: Launch Network Chaos  # ë„¤íŠ¸ì›Œí¬ Chaos ì‹¤í–‰
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_network_chaos.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "net_mode={{ chaos_mode }}"
        -e "network_delay_ms={{ network_delay_ms }}"
        -e "target_namespace={{ target_namespace }}"
        --forks 1
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: net_job
      ignore_errors: yes

    - name: Launch CPU Stress Chaos  # CPU ë¶€í•˜ Chaos ì‹¤í–‰
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_cpu_stress.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "stress_mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
        --forks 1
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: cpu_job
      ignore_errors: yes

    - name: Launch Service Kill Chaos  # Service Kill Chaos ì‹¤í–‰
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_service_kill.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
        --forks 1
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: svc_job
      ignore_errors: yes

    # Step 3ï¸âƒ£: CI/CD ì·¨ì†Œ ì‹ í˜¸ ê°ì§€ ë¸”ë¡
    - name: Wait for chaos duration (cancel-safe)  # Chaos ìœ ì§€ ëŒ€ê¸°
      block:  # ë©”ì¸ ë¸”ë¡
        - ansible.builtin.pause:  # ë‹¨ìˆœ ëŒ€ê¸°
            seconds: "{{ chaos_duration }}"  # ì§€ì •ëœ Chaos ìœ ì§€ ì‹œê°„ ë™ì•ˆ ëŒ€ê¸°
      rescue:  # CI/CD ìˆ˜ë™ ì·¨ì†Œ ê°ì§€ ì‹œ
        - name: Handle CI/CD manual cancellation  # ì¤‘ë‹¨ ë¡œê·¸
          ansible.builtin.debug:
            msg: "ğŸ›‘ CI/CD ì¤‘ë‹¨ ê°ì§€ë¨ â€” Chaos í…ŒìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•©ë‹ˆë‹¤."

        - name: Kill background chaos processes  # ë°±ê·¸ë¼ìš´ë“œ ansible-playbook ì¢…ë£Œ
          ansible.builtin.shell: |
            pkill -f "ansible-playbook.*run_(pod|cpu|network|service)_chaos.yml" || true  # í•´ë‹¹ chaos í”Œë ˆì´ë¶ë§Œ ì¢…ë£Œ
          ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ

        - name: Log CI/CD stop event  # ì¤‘ë‹¨ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path | default('/tmp/chaos_test.log') }}"  # ì ‘ê·¼ ë¶ˆê°€ ëŒ€ë¹„ /tmp fallback
            create: yes
            line: "[{{ ansible_date_time.iso8601 }}] ChaosTest Aborted (manual cancel detected)"
          become: yes
          failed_when: false  # rescue ë‚´ ì˜¤ë¥˜ ë°©ì§€

        - name: Announce chaos termination complete  # ì¤‘ë‹¨ ì™„ë£Œ ì•ˆë‚´
          ansible.builtin.debug:
            msg: "âœ… ëª¨ë“  Chaos í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"

        - ansible.builtin.meta: end_play  # ì´í›„ task ì¤‘ë‹¨ (CI/CD-safe ì¢…ë£Œ)

    # Step 4ï¸âƒ£: Chaos ì™„ë£Œ ë¡œê·¸ ê¸°ë¡
    - name: Write chaos workflow completion log  # Chaos ì™„ë£Œ ë¡œê·¸ ì‘ì„±
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path | default('/tmp/chaos_test.log') }}"  # ê¸°ë³¸ ê²½ë¡œ + fallback
        create: yes  # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
        line: |
          [{{ ansible_date_time.iso8601 }}] ChaosTest Completed (mode={{ chaos_mode }}, duration={{ chaos_duration }}s)
      become: true  # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ê¸°ë¡
      ignore_errors: yes  # ê¶Œí•œ ë¬¸ì œ ë°œìƒ ì‹œ ë¬´ì‹œ

    # Step 5ï¸âƒ£: Chaos ì‹¤í–‰ ì™„ë£Œ ìš”ì•½ ì¶œë ¥
    - name: Display chaos completion summary  # ì‹¤í–‰ ìš”ì•½
      ansible.builtin.debug:
        msg: |  # ë©€í‹°ë¼ì¸ ë©”ì‹œì§€
          âœ… Chaos Workflow Completed
          - Namespace: {{ target_namespace }}
          - Mode: {{ chaos_mode }}
          - Duration: {{ chaos_duration }}ì´ˆ
          - Recovery ë‹¨ê³„: ì œì™¸ë¨
