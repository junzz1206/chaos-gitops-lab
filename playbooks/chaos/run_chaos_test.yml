# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: playbooks/chaos/run_chaos_test.yml
# ëª©ì :
#   - "ì˜êµ¬ ì¥ì•  ìœ ì§€í˜•" Chaos ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
#   - ArgoCD selfHeal ë¹„í™œì„±í™”ë¡œ ìë™ ë³µêµ¬ ì°¨ë‹¨
#   - ì§€ì • ì„œë¹„ìŠ¤ Deploymentë¥¼ scale=0ìœ¼ë¡œ ë‚´ë ¤ OutOfSync ìœ ì§€ â†’ Alertmanager ê°ì§€
#   - run_pod_kill.ymlì€ ë¶€ê°€(ì˜µì…˜). í•µì‹¬ ì¥ì• ëŠ” scale=0
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Chaos Injection (Persistent Failure)
  hosts: k3s_master
  become: true

  vars:
    # âœ… ê³ ì •ê°’ (ì›í•˜ë©´ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
    target_namespace: "app"
    chaos_duration: 90   # seconds
    argocd_ns: "argocd"
    argocd_app: "chaos-engineering"

    # ì˜êµ¬ ì¥ì• ë¡œ ë§Œë“¤ ì„œë¹„ìŠ¤ (ì›í•˜ë©´ ì¶”ê°€/ì‚­ì œ)
    persistent_outage_services:
      - cartservice
      - frontend
      - paymentservice

    # PodKillë„ ê°™ì´ ëŒë¦´ì§€ ì—¬ë¶€ (ì›í•˜ë©´ false)
    run_pod_kill: true

  tasks:
    # 1) ì•ˆì „ ê²€ì‚¬
    - name: Safety Check - namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # 2) ArgoCD Self-Heal OFF (ìë™ ë³µêµ¬ ì°¨ë‹¨)
    - name: Disable ArgoCD self-heal (prevent auto recovery)
      ansible.builtin.shell: |
        set -e
        echo "[ARGOCD] Disable selfHeal for app={{ argocd_app }}"
        kubectl -n {{ argocd_ns }} patch application {{ argocd_app }} --type merge -p '{
          "spec": {
            "syncPolicy": {
              "automated": {
                "selfHeal": false,
                "prune": true
              }
            }
          }
        }'
      changed_when: true

    # 3) ì‹œì‘ ì•ˆë‚´
    - name: Announce chaos start
      ansible.builtin.debug:
        msg: |
          ğŸš€ Chaos Test ì‹œì‘
          - Namespace: {{ target_namespace }}
          - Duration: {{ chaos_duration }}s
          - Mode: Persistent Failure (No Self-Healing)
          - ArgoCD: selfHeal=false
          - Persistent Outage Services: {{ persistent_outage_services | join(', ') }}
          - Recovery: restore_all.yml only

    # 4) (ì˜µì…˜) Pod Kill ì‹¤í–‰
    - name: Run Pod Kill Chaos (optional)
      when: run_pod_kill | bool
      ansible.builtin.command:
        cmd: ansible-playbook {{ playbook_dir }}/run_pod_kill.yml
      register: pod_kill_result
      ignore_errors: true
      changed_when: true

    # 5) ğŸ”¥ ì˜êµ¬ ì¥ì•  ì£¼ì…: Deployment scale=0
    - name: Force persistent service outage (scale=0)
      ansible.builtin.shell: |
        set -e
        echo "[CHAOS] Scaling down deployments to 0 (persistent outage)"
        for svc in {{ persistent_outage_services | join(' ') }}; do
          if kubectl -n {{ target_namespace }} get deploy "$svc" >/dev/null 2>&1; then
            echo "  - scale deploy/$svc -> 0"
            kubectl -n {{ target_namespace }} scale deploy "$svc" --replicas=0
          else
            echo "  - WARN: deploy/$svc not found (skip)"
          fi
        done
      changed_when: true

    # 6) ìƒíƒœ ì¶œë ¥
    - name: Show deployment state after chaos
      ansible.builtin.shell: |
        kubectl get deploy -n {{ target_namespace }}
      register: deploy_state
      changed_when: false

    - name: Injection summary
      ansible.builtin.debug:
        msg: |
          ğŸ”¥ Chaos Injected (Persistent)
          {{ deploy_state.stdout }}

- name: Hold Chaos Window (Controller Only)
  hosts: localhost
  gather_facts: false
  vars:
    chaos_duration: 90   # âœ… ìœ„ì™€ ë™ì¼í•˜ê²Œ ë§ì¶°ë‘  (ì›í•˜ë©´ ê°™ì´ ìˆ˜ì •)
  tasks:
    - name: Hold failure window for Alertmanager
      ansible.builtin.pause:
        seconds: "{{ chaos_duration }}"

