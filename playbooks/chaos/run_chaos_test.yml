# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_chaos_test.yml
# ëª©ì :
#   - Pod, Network, CPU, Service Chaos ë³‘ë ¬ ì‹¤í–‰ (ê° 100ì´ˆ)
#   - internal / external ëª¨ë“œ ëª¨ë‘ ì§€ì›
#   - ë³µêµ¬ ë‹¨ê³„ ì œì™¸ (Chaosë§Œ ìˆ˜í–‰)
#   - CI/CD (ArgoCD, GitLab ë“±) í™˜ê²½ì—ì„œ ì¦‰ì‹œ ì¤‘ë‹¨ ê°€ëŠ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Execute Full Chaos Workflow (Parallel, CI/CD-safe)
  hosts: k3s_master
  become: yes
  strategy: free
  vars:
    target_namespace: "app"
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(100, true) | int }}"
    chaos_mode: "{{ lookup('env','CHAOS_MODE') | default('internal', true) }}"
    network_delay_ms: 300
    chaos_log_path: "/var/log/chaos_test.log"

  tasks:
    # Step 1ï¸âƒ£: ì‹œì‘ ë¡œê·¸
    - name: Announce chaos workflow start
      ansible.builtin.debug:
        msg: |
          ğŸš€ Chaos ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹œì‘
          - namespace: {{ target_namespace }}
          - duration: {{ chaos_duration }}ì´ˆ
          - mode: {{ chaos_mode }}
          - recovery: ë¹„í™œì„±í™”ë¨ (ìë™ ë³µêµ¬ ì—†ìŒ)

    # Step 2ï¸âƒ£: ë³‘ë ¬ Chaos ì£¼ì… (async â†’ CI/CD cancel ì‹œ ì¦‰ì‹œ ì¤‘ì§€)
    - name: Launch Pod Kill Chaos
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_pod_kill.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "external_mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: pod_job
      ignore_errors: yes

    - name: Launch Network Chaos
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_network_chaos.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "net_mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: net_job
      ignore_errors: yes

    - name: Launch CPU Stress Chaos
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_cpu_stress.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "stress_mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: cpu_job
      ignore_errors: yes

    - name: Launch Service Kill Chaos
      ansible.builtin.shell: >
        ansible-playbook {{ playbook_dir }}/run_service_kill.yml
        -e "chaos_duration={{ chaos_duration }}"
        -e "mode={{ chaos_mode }}"
        -e "target_namespace={{ target_namespace }}"
      async: "{{ chaos_duration + 30 }}"
      poll: 0
      register: svc_job
      ignore_errors: yes

    # Step 3ï¸âƒ£: CI/CD í™˜ê²½ ëŒ€ì‘ ëŒ€ê¸° (ì·¨ì†Œ ì‹ í˜¸ ê°ì§€ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ)
    - name: Wait for chaos duration (cancel-safe)
      block:
        - ansible.builtin.pause:
            seconds: "{{ chaos_duration }}"
      rescue:
        - name: Handle CI/CD manual cancellation
          ansible.builtin.debug:
            msg: "ğŸ›‘ CI/CD ì·¨ì†Œ ê°ì§€ë¨. Chaos ì‹¤í—˜ ì¤‘ë‹¨ ë° ì •ë¦¬ ì¤‘..."
        - ansible.builtin.shell: |
            pkill -f "ansible-playbook.*run_.*_chaos.yml" || true
          ignore_errors: yes
        - ansible.builtin.debug:
            msg: "âœ… ëª¨ë“  í•˜ìœ„ Chaos í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"

    # Step 4ï¸âƒ£: Chaos ì™„ë£Œ ë¡œê·¸
    - name: Write chaos workflow completion log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] ChaosTest Completed (mode={{ chaos_mode }}, duration={{ chaos_duration }}s)
      become: true

    - name: Display chaos completion summary
      ansible.builtin.debug:
        msg: |
          âœ… Chaos Workflow Completed
          - namespace: {{ target_namespace }}
          - mode: {{ chaos_mode }}
          - duration: {{ chaos_duration }}ì´ˆ
          - ë³µêµ¬ ë‹¨ê³„: ì œì™¸ë¨

