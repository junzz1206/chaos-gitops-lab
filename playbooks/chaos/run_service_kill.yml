# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_service_kill.yml
# ëª©ì :
#   - ì—¬ëŸ¬ ì„œë¹„ìŠ¤(cart, payment, redis-cart ë“±)ì— ë³‘ë ¬ë¡œ Chaos Kill ì£¼ì…
#   - í™˜ê²½ë³€ìˆ˜(TARGET_SERVICES) ë˜ëŠ” vars.yml ê¸°ë°˜ ì§€ì • ê°€ëŠ¥
#   - Deployment, ReplicaSet, StatefulSet ìë™ë³µêµ¬ ì™„ì „ ì°¨ë‹¨
#   - wrapperë‚˜ include_role ì—†ì´ ê·¸ëŒ€ë¡œ ë³‘ë ¬ async ì‹¤í–‰
#   - ArgoCD / GitLab CI/CD ì—°ë™ ì§€ì›
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Execute Targeted Service Kill Chaos
  hosts: k3s_master
  become: yes

  vars:
    target_namespace: "app"
    chaos_log_path: "/var/log/chaos_test.log"
    recovery_wait: 120
    service_targets: []   # ê¸°ë³¸ê°’ (ì—†ìœ¼ë©´ ENV â†’ fallback)

  tasks:
    # Step 1ï¸âƒ£: ENV ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¡œë“œ
    - name: Resolve target services from environment variable (TARGET_SERVICES)
      vars:
        env_services: "{{ lookup('env', 'TARGET_SERVICES') | default('', true) }}"
      ansible.builtin.set_fact:
        effective_services: >-
          {{
            (env_services.split(',') | map('trim') | list)
            if env_services | length > 0
            else (service_targets | default([]))
          }}
      changed_when: false

    - name: Show resolved services
      ansible.builtin.debug:
        msg: |
          ğŸ¯ Chaos ëŒ€ìƒ ì„œë¹„ìŠ¤ ê²°ì •
          - ENV(TARGET_SERVICES): {{ lookup('env', 'TARGET_SERVICES') | default('N/A') }}
          - Local vars(service_targets): {{ service_targets | default([]) }}
          - Effective services: {{ effective_services | default([]) }}

    # Step 2ï¸âƒ£: Safety Check
    - name: Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # Step 3ï¸âƒ£: ì‹œì‘ ë¡œê·¸
    - name: Announce service kill chaos
      ansible.builtin.debug:
        msg: |
          ğŸ’¥ ì„œë¹„ìŠ¤ Kill Chaos ì‹œì‘
          - ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ëŒ€ìƒ ì„œë¹„ìŠ¤: {{ effective_services | join(', ') if effective_services | length > 0 else 'ëœë¤ ëª¨ë“œ' }}
          - ìë™ë³µêµ¬: ì™„ì „ ì°¨ë‹¨

    # Step 4ï¸âƒ£: ìë™ë³µêµ¬ ì°¨ë‹¨ + Pod Kill (ë³‘ë ¬ async)
    - name: Kill and disable autorecover for each service (parallel)
      when: effective_services | length > 0
      ansible.builtin.shell: |
        echo "[CHAOS] Killing and disabling autorecover for {{ item }}..."

        # 1. Deployment scale down
        kubectl get deploy -n {{ target_namespace }} -l app={{ item }} -o name | \
          xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true

        # 2. ReplicaSet scale down
        kubectl get rs -n {{ target_namespace }} -l app={{ item }} -o name | \
          xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true

        # 3. StatefulSet scale down
        kubectl get sts -n {{ target_namespace }} -l app={{ item }} -o name | \
          xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true

        # 4. Pod ê°•ì œ ì‚­ì œ
        echo "[KILL] Deleting pods of {{ item }}"
        kubectl get pods -n {{ target_namespace }} -l app={{ item }} -o name | \
          xargs -r -I{} kubectl delete {} -n {{ target_namespace }} --grace-period=0 --force

        echo "[OK] {{ item }} chaos complete."
      async: 90
      poll: 0
      loop: "{{ effective_services }}"
      register: async_jobs
      ignore_errors: yes

    # Step 5ï¸âƒ£: ë³‘ë ¬ ì‘ì—… ëª¨ë‹ˆí„°ë§
    - name: Monitor async chaos job statuses
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      register: chaos_status
      until: chaos_status.finished
      retries: 20
      delay: 3
      loop: "{{ async_jobs.results }}"
      ignore_errors: yes

    # Step 6ï¸âƒ£: ì•ˆì •í™” ëŒ€ê¸°
    - name: Wait before verifying service recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 7ï¸âƒ£: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
    - name: Check current service pod states
      ansible.builtin.shell: |
        echo "[STATUS] Checking pods for {{ effective_services | join(', ') }}"
        kubectl get pods -n {{ target_namespace }} \
          -l "app in ({{ effective_services | join(',') }})" \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_status
      changed_when: false
      ignore_errors: yes

    # Step 8ï¸âƒ£: ê²°ê³¼ ì¶œë ¥
    - name: Print service kill results
      ansible.builtin.debug:
        msg: |
          ğŸ“‹ ì„œë¹„ìŠ¤ Kill Chaos ê²°ê³¼
          {{ pod_status.stdout | default('ì •ë³´ ì—†ìŒ') }}

    # Step 9ï¸âƒ£: Chaos ë¡œê·¸ ê¸°ë¡
    - name: Write chaos summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] ServiceKill ns={{ target_namespace }} \
          targets={{ effective_services | join(',') }} \
          result="{{ pod_status.stdout | replace('\n','; ') }}"
      become: true

    # Step ğŸ”Ÿ: ìµœì¢… ìš”ì•½
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Chaos Service Kill ì™„ë£Œ
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ëŒ€ìƒ ì„œë¹„ìŠ¤: {{ effective_services | join(', ') if effective_services | length > 0 else 'ëœë¤' }}
          - ë³µêµ¬ ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ
          - ë¡œê·¸ íŒŒì¼: {{ chaos_log_path }}

