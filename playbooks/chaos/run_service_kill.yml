# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_service_kill.yml
# ëª©ì : ì£¼ìš” ì„œë¹„ìŠ¤(cart, payment, redis-cart) Pod ê°•ì œ ì¢…ë£Œ (Service Chaos)
# ì„¤ëª…:
#   - cartservice, paymentservice, redis-cart ë“± ì£¼ìš” ë°±ì—”ë“œ ì„œë¹„ìŠ¤ì˜ Podë¥¼ ì¢…ë£Œ
#   - Chaos Monkey ìŠ¤íƒ€ì¼ë¡œ ìˆœì°¨ ë˜ëŠ” ë³‘ë ¬ ì‹¤í–‰ ê°€ëŠ¥
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, chaos_log_path, recovery_wait
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ’¥ Execute Targeted Service Kill Chaos
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    chaos_log_path: "/var/log/chaos_test.log"
    recovery_wait: 10
    service_targets:
      - cartservice
      - paymentservice
      - redis-cart

  tasks:
    # Step 1ï¸âƒ£: Safety Check
    - name: ğŸ§© Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # Step 2ï¸âƒ£: Log start
    - name: ğŸ§¾ Announce service kill chaos
      ansible.builtin.debug:
        msg: |
          ğŸ’¥ ì„œë¹„ìŠ¤ Kill Chaos ì‹œì‘
          - ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ëŒ€ìƒ ì„œë¹„ìŠ¤: {{ service_targets | join(', ') }}

    # Step 3ï¸âƒ£: Iterate service kills
    - name: ğŸ” Execute chaos_kill role for each target
      ansible.builtin.include_role:
        name: chaos_kill
      vars:
        target_app_label: "{{ item }}"
      loop: "{{ service_targets }}"
      ignore_errors: yes
      register: service_kill_results

    # Step 4ï¸âƒ£: Pause for stabilization
    - name: â³ Wait before verifying service recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 5ï¸âƒ£: Verify service status
    - name: ğŸ” Check current service pod states
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -l "app in ({{ service_targets | join(',') }})" \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_status
      changed_when: false
      ignore_errors: yes

    # Step 6ï¸âƒ£: Display results
    - name: ğŸ§¾ Print service kill results
      ansible.builtin.debug:
        msg: |
          ğŸ“‹ ì„œë¹„ìŠ¤ Kill Chaos ê²°ê³¼
          {{ pod_status.stdout | default('ì •ë³´ ì—†ìŒ') }}

    # Step 7ï¸âƒ£: Log results to chaos log
    - name: ğŸª¶ Write service chaos summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] ServiceKill: ns={{ target_namespace }} targets={{ service_targets | join(',') }} result="{{ pod_status.stdout | replace('\n','; ') }}"
      become: true

