# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_service_kill.yml
# ëª©ì :
#   - ì—¬ëŸ¬ ì„œë¹„ìŠ¤(cart, payment, redis-cart ë“±)ì— ë³‘ë ¬ Chaos Kill ì£¼ìž…
#   - Internal ì‹¤íŒ¨ ì‹œ External ëª¨ë“œë¡œ ìžë™ ì „í™˜
#   - GitLab / ArgoCD í™˜ê²½ë³€ìˆ˜(TARGET_SERVICES) ê¸°ë°˜ ì§€ì • ê°€ëŠ¥
#   - CLIì—ì„œëŠ” vars.yml(service_targets) ê¸°ë°˜ fallback
#   - Deployment, ReplicaSet, StatefulSet ìžë™ë³µêµ¬ ì™„ì „ ì°¨ë‹¨
#   - wrapper ì—†ì´ async ë³‘ë ¬ ì‹¤í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ðŸ’¥ Execute Targeted Service Kill Chaos (Internal / External Auto-Fallback)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    chaos_log_path: "/var/log/chaos_test.log"
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(60, true) | int }}"
    service_targets: []  # CLI fallbackìš©
    kill_mode: "{{ lookup('env','SERVICE_MODE') | default('internal', true) }}"  # internal / external
    disable_autorecover: "{{ lookup('env','DISABLE_AUTORECOVER') | default(true, true) | bool }}"
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(30, true) | int }}"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ENV / CLI ì„œë¹„ìŠ¤ ë¡œë“œ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Resolve target services dynamically
      vars:
        env_services: "{{ lookup('env', 'TARGET_SERVICES') | default('', true) }}"
      ansible.builtin.set_fact:
        effective_services: >-
          {{
            (env_services.split(',') | map('trim') | list)
            if env_services | length > 0
            else (service_targets | default([]))
          }}
      changed_when: false

    - name: Show resolved service list
      ansible.builtin.debug:
        msg: |
          ðŸŽ¯ Chaos ëŒ€ìƒ ì„œë¹„ìŠ¤:
          - ENV(TARGET_SERVICES): {{ lookup('env','TARGET_SERVICES') | default('N/A') }}
          - Local(vars): {{ service_targets | default([]) }}
          - Effective: {{ effective_services | join(', ') if effective_services | length > 0 else 'ëžœë¤' }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ Safety Check
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ§© Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Internal Kill Mode - Pod ì‚­ì œ ë° AutoRecover ì°¨ë‹¨
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ’€ Perform internal service kill
      when: kill_mode == "internal"
      ansible.builtin.shell: |
        failed_svcs=""
        for svc in {{ effective_services | join(' ') }}; do
          echo "[INTERNAL] $svc: scaling down and deleting pods..."
          kubectl get deploy -n {{ target_namespace }} -l app=$svc -o name | \
            xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
          kubectl get rs -n {{ target_namespace }} -l app=$svc -o name | \
            xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
          kubectl get sts -n {{ target_namespace }} -l app=$svc -o name | \
            xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true

          PODS=$(kubectl get pods -n {{ target_namespace }} -l app=$svc -o name)
          if [ -z "$PODS" ]; then
            echo "[WARN] No running pods for $svc."
            failed_svcs="$failed_svcs $svc"
            continue
          fi
          kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true
        done

        if [ -n "$failed_svcs" ]; then
          echo "[WARN] Internal kill failed for:$failed_svcs"
          exit 99
        fi
      register: internal_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Fallback ê°ì§€ (Internal â†’ External)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect internal failure and switch mode
      when:
        - kill_mode == "internal"
        - internal_result.rc is defined
        - internal_result.rc != 0
      ansible.builtin.set_fact:
        kill_mode: "external"
      changed_when: true

    - name: âš ï¸ Announce fallback activation
      when: kill_mode == "external"
      ansible.builtin.debug:
        msg: "âš ï¸ Internal ì‹¤íŒ¨ â†’ External Chaos Pod ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤."

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ External Mode - ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ§¨ Launch chaos pods for external deletion
      when: kill_mode == "external"
      ansible.builtin.shell: |
        for svc in {{ effective_services | join(' ') }}; do
          echo "[EXTERNAL] Launching chaos pod for $svc..."
          kubectl run svc-chaos-$svc --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "svc-chaos",
                  "image": "nicolaka/netshoot:latest",
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "echo \"[CHAOS] Deleting pods for $svc...\"; \
                     kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true; \
                     echo \"[WAIT] Keeping service offline for {{ chaos_duration }}s...\"; \
                     sleep {{ chaos_duration }}; \
                     echo \"[DONE] $svc external chaos complete.\";"
                  ]
                }]
              }
            }' || true
        done
      register: external_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ ì•ˆì •í™” ëŒ€ê¸°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â³ Wait for recovery_wait seconds
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ í˜„ìž¬ ìƒíƒœ ì ê²€
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ”Ž Verify current pod states
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      ignore_errors: yes
      changed_when: false

    - name: ðŸ“Š Display pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Service Kill Chaos ì™„ë£Œ
          {{ pod_state.stdout | default('âš ï¸ Pod ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸªµ Write chaos summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] ServiceKill ns={{ target_namespace }} mode={{ kill_mode }} targets={{ effective_services | join(', ') }} result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9ï¸âƒ£ ìµœì¢… ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Service Kill Chaos Completed
          - Namespace: {{ target_namespace }}
          - Mode: {{ kill_mode }}
          - Targets: {{ effective_services | join(', ') if effective_services | length > 0 else 'N/A' }}
          - Duration: {{ chaos_duration }}ì´ˆ
          - Recovery Wait: {{ recovery_wait }}ì´ˆ
          - Log: {{ chaos_log_path }}
