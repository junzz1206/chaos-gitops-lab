# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_service_kill.yml
# ëª©ì :
#   - Internal ë°©ì‹ Service Kill Chaos
#   - ENV â†’ íŒŒì¼ â†’ ì „ì—­ë³€ìˆ˜ fallback
#   - GitOps/ArgoCD ë³µêµ¬ ì „ì œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Service Kill Chaos (Internal Only, ENVâ†’File Fallback, Global Vars First)
  hosts: k3s_master
  become: yes

  vars:
    # âš ï¸ ê³„ì‚° ê¸ˆì§€ ì˜ì—­ (ìƒìˆ˜ë§Œ)
    target_namespace_effective: "{{ target_namespace | default('app') }}"
    chaos_log_path_effective: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"

    service_kill_duration_fallback: 30   # ì´ˆ
    recovery_wait_fallback: 5
    scale_down_enabled_fallback: true

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 0ï¸âƒ£ Safety Check
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Safety Check - namespace
      ansible.builtin.assert:
        that:
          - target_namespace_effective == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ scale_down_enabled ê³„ì‚°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Resolve scale_down_enabled (ENV â†’ Global â†’ Default)
      ansible.builtin.set_fact:
        scale_down_enabled: >-
          {{
            (lookup('env','SCALE_DOWN_ENABLED') | default('', true)) | length > 0
            | ternary(
                lookup('env','SCALE_DOWN_ENABLED') | bool,
                (scale_down_enabled | default(scale_down_enabled_fallback) | bool)
              )
          }}
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ Chaos Duration ê³„ì‚°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Resolve service_kill_duration (ENV â†’ Global â†’ Fallback)
      ansible.builtin.set_fact:
        service_kill_duration: >-
          {{
            (lookup('env','CHAOS_DURATION') | default('', true)) | length > 0
            | ternary(
                lookup('env','CHAOS_DURATION') | int,
                (chaos_duration | default(service_kill_duration_fallback) | int)
              )
          }}
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Recovery Wait ê³„ì‚°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Resolve recovery_wait_seconds
      ansible.builtin.set_fact:
        recovery_wait_seconds: >-
          {{
            (lookup('env','RECOVERY_WAIT') | default('', true)) | length > 0
            | ternary(
                lookup('env','RECOVERY_WAIT') | int,
                (recovery_wait | default(recovery_wait_fallback) | int)
              )
          }}
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Service Target ë¡œë”©
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Init fallback dict
      ansible.builtin.set_fact:
        service_kill_targets: []
      changed_when: false

    - name: Check service_kill_targets.yml exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../service_kill_targets.yml"
      register: svc_file

    - name: Include service_kill_targets.yml
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../service_kill_targets.yml"
      when: svc_file.stat.exists

    - name: Apply fallback list
      ansible.builtin.set_fact:
        effective_services: >-
           {{
             (
               (lookup('env','TARGET_SERVICES') | default('', true)) | length > 0
             )
             | ternary(
                 lookup('env','TARGET_SERVICES').split(',') | map('trim') | list,
                 service_kill_targets | default([])
               )    
           }}
      changed_when: false

    - name: Display effective target list
      ansible.builtin.debug:
        msg: |
          ğŸ¯ Service Kill Chaos ì„¤ì •
          - Namespace: {{ target_namespace_effective }}
          - Targets: {{ effective_services | join(', ') }}
          - Duration: {{ service_kill_duration }}s
          - Scale Down: {{ scale_down_enabled }}
          - Recovery Wait: {{ recovery_wait_seconds }}s

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Internal Service Kill
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Scale down target deployments
      when: scale_down_enabled
      ansible.builtin.shell: |
        for svc in {{ effective_services | join(' ') }}; do
          echo "[CHAOS] Scaling down $svc"
          kubectl scale deploy "$svc" -n {{ target_namespace_effective }} --replicas=0 || true
        done
      changed_when: true

    - name: Hold chaos duration
      ansible.builtin.pause:
        seconds: "{{ service_kill_duration }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ ìƒíƒœ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Get deployment state
      ansible.builtin.shell: |
        kubectl get deploy -n {{ target_namespace_effective }} \
          -o custom-columns="NAME:.metadata.name,READY:.status.readyReplicas,DESIRED:.spec.replicas" --no-headers
      register: deploy_state
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write chaos log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_effective }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] ServiceKill ns={{ target_namespace_effective }} targets={{ effective_services | join(',') }} duration={{ service_kill_duration }}s scale_down={{ scale_down_enabled }} deploy="{{ deploy_state.stdout | replace('\n','; ') }}"
      become: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ ìµœì¢… ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Service Kill Chaos ì™„ë£Œ
          - Namespace: {{ target_namespace_effective }}
          - Targets: {{ effective_services | join(', ') }}
          - Duration: {{ service_kill_duration }}s
          - Recovery: restore_all.yml (ArgoCD GitOps)
          - Log: {{ chaos_log_path_effective }}

