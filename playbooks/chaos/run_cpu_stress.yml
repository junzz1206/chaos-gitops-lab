# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_cpu_stress.yml
# ëª©ì :
#   - internal ëª¨ë“œ: ì§€ì •ëœ ì„œë¹„ìŠ¤ë“¤ì— CPU ë¶€í•˜ ì£¼ì…
#   - external ëª¨ë“œ: ëª¨ë“  Podì— stress-ng ë¶€í•˜ ì£¼ì… (foreground ì‹¤í–‰)
#   - ë³µêµ¬ ë° í—¬ìŠ¤ì²´í¬ëŠ” ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ (restore_all.ymlì—ì„œ ì¼ê´„ ì²˜ë¦¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ’¥ CPU Chaos Test (Internal or External)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"                     # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_duration: 120                         # ë¶€í•˜ ì§€ì† ì‹œê°„(ì´ˆ)
    chaos_log_path: "/var/log/chaos_test.log"   # Chaos ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
    target_app_labels: "checkoutservice"        # internal ëª¨ë“œì‹œ ëŒ€ìƒ ì„œë¹„ìŠ¤ (ì‰¼í‘œë¡œ êµ¬ë¶„)

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ stress_mode ê¸°ë³¸ê°’ ì„¤ì •
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§© Set stress_mode safely (prevent recursion)
      ansible.builtin.set_fact:
        effective_stress_mode: "{{ stress_mode | default('internal') }}"  # ì§€ì • ì—†ìœ¼ë©´ internalë¡œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ target_namespace ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§© Validate target_namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"           # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì™¸ ê¸ˆì§€
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ External ëª¨ë“œ - ì „ì²´ Podì— stress-ng ë¶€í•˜ ì£¼ì… (foreground)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§  External cluster-wide CPU stress injection (foreground)
      when: effective_stress_mode == "external"
      ansible.builtin.shell: |
        echo "[INFO] Injecting stress-ng load into ALL pods under namespace {{ target_namespace }} ..."
        ALL_PODS=$(kubectl get pods -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}')
        for POD in $ALL_PODS; do
          echo "[TARGET] $POD"
          kubectl run cpu-stress-$POD \
            --image=alpine:3.19 \
            --restart=Never -n {{ target_namespace }} \
            --command -- sh -c "
              set -eux;
              apk add --no-cache stress-ng >/dev/null;
              echo '[INFO] ğŸ”¥ Starting TOTAL LOAD for {{ chaos_duration }}s on $POD ...';
              stress-ng -c 0 -l 100 --matrix 64 --vm 8 --vm-bytes 80% \
                --hdd 4 --timeout {{ chaos_duration }}s --metrics-brief;
              echo '[OK] âœ… Stress complete for $POD';
              sleep 1;
            " || true
        done
      register: external_result
      ignore_errors: yes
      changed_when: true

    - name: âœ… External stress result summary
      when: effective_stress_mode == "external"
      ansible.builtin.debug:
        msg: |
          âœ… External stress pods launched (foreground mode)
          RC={{ external_result.rc }}
          STDOUT:
          {{ external_result.stdout | default('N/A') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Internal ëª¨ë“œ - ì§€ì •ëœ ì„œë¹„ìŠ¤ë³„ ë¶€í•˜ ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Split target_app_labels into list
      when: effective_stress_mode != "external"
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}"

    - name: ğŸ’ª Inject CPU stress into specified services (internal mode)
      when: effective_stress_mode != "external"
      ansible.builtin.shell: |
        for svc in {{ target_services | join(' ') }}; do
          echo "[INFO] Target service: $svc"
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            echo "[CHAOS] Injecting CPU stress into $svc ($POD) for {{ chaos_duration }}s"
            kubectl exec -n {{ target_namespace }} $POD -- sh -c '
              if command -v yes >/dev/null 2>&1; then
                yes > /dev/null &
                PID=$!
                sleep {{ chaos_duration }}
                kill $PID 2>/dev/null || true
                echo "[DONE] CPU stress completed for $svc"
              else
                echo "[WARN] yes command not found in container for $svc"
              fi
            '
          else
            echo "[SKIP] No pod found for $svc"
          fi
        done
      register: internal_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡ (ë³µêµ¬ ì—†ìŒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸª¶ Write chaos log entry
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] ChaosCPU(ns={{ target_namespace }}) mode={{ effective_stress_mode }} duration={{ chaos_duration }} targets={{ target_app_labels }}
      become: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ ê²°ê³¼ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Final chaos summary message
      ansible.builtin.debug:
        msg: |
          âœ… CPU Chaos Injection Completed
          - Mode: {{ effective_stress_mode }}
          - Duration: {{ chaos_duration }}s
          - Namespace: {{ target_namespace }}
          - Target Services: {{ target_app_labels }}
          - Note: íšŒë³µ ë° ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

