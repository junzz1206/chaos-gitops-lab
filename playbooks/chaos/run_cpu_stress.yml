# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: playbooks/chaos/run_cpu_stress.yml
# ëª©ì :
#   - internal ëª¨ë“œ: íŠ¹ì • ì„œë¹„ìŠ¤ Pod ë‚´ë¶€ì— CPU ë¶€í•˜ ì£¼ì…
#   - external ëª¨ë“œ: ëª¨ë“  Podì— stress-ng ë¶€í•˜ ì£¼ì… (foreground)
#   - ìë™ ë³µêµ¬ëŠ” ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ (restore_all.ymlì—ì„œ ì¼ê´„ ë³µêµ¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run CPU Chaos Test (Internal / External)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"                     # Chaosë¥¼ ì ìš©í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(120, true) | int }}" # ë¶€í•˜ ìœ ì§€ì‹œê°„(ì´ˆ)
    chaos_log_path: "/var/log/chaos_test.log"   # Chaos ë¡œê·¸ ê²½ë¡œ
    target_app_labels: "{{ lookup('env','TARGET_SERVICES') | default('checkoutservice', true) }}" # internal ëª¨ë“œ íƒ€ê²Ÿ ì„œë¹„ìŠ¤
    effective_stress_mode: "{{ lookup('env','STRESS_MODE') | default('internal', true) }}"  # stress ëª¨ë“œ (internal / external)

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"           # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì™¸ ì‹¤í–‰ ê¸ˆì§€
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ëª¨ë“œ ë° íƒ€ê²Ÿ ì„œë¹„ìŠ¤ ì •ë³´ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Show chaos configuration
      ansible.builtin.debug:
        msg: |
          âš™ï¸ CPU Chaos Configuration
          - Mode: {{ effective_stress_mode }}
          - Duration: {{ chaos_duration }}s
          - Namespace: {{ target_namespace }}
          - Target Services: {{ target_app_labels }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ External ëª¨ë“œ - ì „ì²´ Podì— stress-ng ë¶€í•˜ ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Apply external CPU stress to all pods
      when: effective_stress_mode == "external"
      ansible.builtin.shell: |
        echo "[INFO] Injecting stress-ng load across ALL pods..."
        ALL_PODS=$(kubectl get pods -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}')
        for POD in $ALL_PODS; do
          echo "[TARGET] $POD"
          SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # UUID ì ‘ë¯¸ì‚¬ë¡œ ì´ë¦„ ì¶©ëŒ ë°©ì§€
          kubectl run cpu-stress-$SUFFIX \
            --image=alpine:3.19 --restart=Never -n {{ target_namespace }} \
            --command -- sh -c "
              set -eux;
              apk add --no-cache stress-ng >/dev/null 2>&1 || true;
              echo '[INFO] ğŸ”¥ Starting stress-ng for {{ chaos_duration }}s ...';
              stress-ng -c 0 -l 100 --matrix 64 --vm 8 --vm-bytes 80% \
                --hdd 4 --timeout {{ chaos_duration }}s --metrics-brief || true;
              echo '[OK] âœ… Stress complete for $POD';
            " || true
        done
      register: external_result
      ignore_errors: yes                  # ì¼ë¶€ Pod ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
      changed_when: true

    - name: Show external stress summary
      when: effective_stress_mode == "external"
      ansible.builtin.debug:
        msg: |
          âœ… External Stress Complete
          - RC: {{ external_result.rc }}
          - Output:
          {{ external_result.stdout | default('No output recorded') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Internal ëª¨ë“œ - ì„œë¹„ìŠ¤ë³„ ë¶€í•˜ ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Split target_app_labels into list
      when: effective_stress_mode != "external"
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}" # ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì„œë¹„ìŠ¤ ì´ë¦„ ë¶„ë¦¬

    - name: Inject CPU stress into target services
      when: effective_stress_mode != "external"
      ansible.builtin.shell: |
        for svc in {{ target_services | join(' ') | default('') }}; do
          echo "[INFO] Target service: $svc"
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -z "$POD" ]; then
            echo "[SKIP] No running pod for $svc"
            continue
          fi

          # stress-ng ë˜ëŠ” yes ëª…ë ¹ì–´ ìœ ë¬´ì— ë”°ë¼ ë™ì  ë¶„ê¸°
          if kubectl exec -n {{ target_namespace }} $POD -- sh -c "command -v stress-ng" >/dev/null 2>&1; then
            echo "[CHAOS] Using stress-ng inside $svc ($POD)"
            kubectl exec -n {{ target_namespace }} $POD -- sh -c "stress-ng -c 2 -l 90 --timeout {{ chaos_duration }}s --metrics-brief"
          elif kubectl exec -n {{ target_namespace }} $POD -- sh -c "command -v yes" >/dev/null 2>&1; then
            echo "[CHAOS] Fallback: Using yes command inside $svc ($POD)"
            kubectl exec -n {{ target_namespace }} $POD -- sh -c '
              yes > /dev/null &
              PID=$!
              sleep {{ chaos_duration }}
              kill $PID 2>/dev/null || true
            '
          else
            echo "[WARN] No stress tools found in $svc ($POD)"
          fi
        done
      register: internal_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡ (ë³µêµ¬ ì—†ìŒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write chaos log entry
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: true
        line: |
          [{{ lookup('pipe','date -Iseconds') }}] CPUChaos(ns={{ target_namespace }}) mode={{ effective_stress_mode }} duration={{ chaos_duration }} targets={{ target_app_labels }}
      become: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final chaos summary
      ansible.builtin.debug:
        msg: |
          âœ… CPU Chaos Completed
          - Mode: {{ effective_stress_mode }}
          - Duration: {{ chaos_duration }}s
          - Namespace: {{ target_namespace }}
          - Targets: {{ target_app_labels }}
          - Log File: {{ chaos_log_path }}
          - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.
