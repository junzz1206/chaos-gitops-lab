# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_network_chaos.yml
# ëª©ì :
#   - internal: ì§€ì •ëœ ì„œë¹„ìŠ¤ Pod ë‚´ë¶€ì— ë„¤íŠ¸ì›Œí¬ ì§€ì—°/ì†ì‹¤/ì†ìƒ ì£¼ì…
#   - external: ë…¸ë“œ NIC(ens160 ë“±)ì— ì§ì ‘ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - Chaos ì‹¤í—˜ í›„ ìƒíƒœ ê²€ì¦ ë° ë³µêµ¬/ë¡œê·¸ ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, net_mode, network_delay_ms,
#   packet_loss_percent, packet_corrupt_percent,
#   recovery_wait, chaos_log_path, target_services
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸŒ Run Network Chaos
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    net_mode: "{{ net_mode | default('internal') }}"
    network_delay_ms: "{{ network_delay_ms | default(3000) }}"
    packet_loss_percent: "{{ packet_loss_percent | default(5) }}"
    packet_corrupt_percent: "{{ packet_corrupt_percent | default(0) }}"
    recovery_wait: "{{ recovery_wait | default(60) }}"
    chaos_log_path: "/var/log/chaos_test.log"
    target_services: "{{ (target_services | default('redis-cart')).split(',') | map('trim') | list }}"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ Safety Check
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§© Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ Internal Mode - ë‹¤ì¤‘ ì„œë¹„ìŠ¤ netem ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ’£ Inject network chaos inside target pods (internal)
      when: net_mode == "internal"
      block:
        - name: ğŸš« Fail if no target services specified
          when: target_services | length == 0
          ansible.builtin.fail:
            msg: "internal ëª¨ë“œì—ì„œëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ target_servicesê°€ í•„ìš”í•©ë‹ˆë‹¤."

        - name: ğŸ” Apply netem to each service pod
          ansible.builtin.shell: |
            set -eux
            for svc in {{ target_services | join(' ') }}; do
              echo "[INFO] ì„œë¹„ìŠ¤: $svc â†’ Pod ì¡°íšŒ ì¤‘..."
              POD_NAME=$(kubectl get pod -n {{ target_namespace }} -l app=$svc -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
              if [ -z "$POD_NAME" ]; then
                echo "[SKIP] $svc ì„œë¹„ìŠ¤ì— ì‹¤í–‰ ì¤‘ì¸ Podì´ ì—†ìŠµë‹ˆë‹¤."
                continue
              fi

              echo "[ACTION] $svc ($POD_NAME)ì— ë„¤íŠ¸ì›Œí¬ Chaos ì£¼ì… ì¤‘..."
              kubectl exec -n {{ target_namespace }} $POD_NAME -- tc qdisc del dev eth0 root || true
              kubectl exec -n {{ target_namespace }} $POD_NAME -- \
                tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%

              echo "[OK] $svc ($POD_NAME)ì— {{ network_delay_ms }}ms ì§€ì—°, {{ packet_loss_percent }}% ì†ì‹¤, {{ packet_corrupt_percent }}% ì†ìƒ ì ìš© ì™„ë£Œ."
            done
          register: internal_netem_result
          ignore_errors: yes
          changed_when: true

        - name: ğŸ§¾ Log internal chaos injection
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"
            create: yes
            line: |
              [{{ ansible_date_time.iso8601 }}] NetworkChaos(INTERNAL): targets={{ target_services | join(', ') }} delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}%
          become: true

        - name: â³ Wait for network chaos effect
          ansible.builtin.pause:
            seconds: "{{ recovery_wait }}"

        - name: ğŸ§¹ Restore normal network (internal)
          ansible.builtin.shell: |
            set -eux
            for svc in {{ target_services | join(' ') }}; do
              POD_NAME=$(kubectl get pod -n {{ target_namespace }} -l app=$svc -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
              [ -z "$POD_NAME" ] && continue
              echo "[RESTORE] $svc ($POD_NAME) ë³µì› ì¤‘..."
              kubectl exec -n {{ target_namespace }} $POD_NAME -- tc qdisc del dev eth0 root || true
            done
          ignore_errors: yes

        - name: ğŸª¶ Log internal recovery
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"
            create: yes
            line: |
              [{{ ansible_date_time.iso8601 }}] NetworkChaos(INTERNAL): targets={{ target_services | join(', ') }} restored
          become: true

        - name: âœ… Internal recovery complete
          ansible.builtin.debug:
            msg: "[Internal Mode] {{ target_services | join(', ') }} ë„¤íŠ¸ì›Œí¬ ì •ìƒ ë³µì› ì™„ë£Œ."

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ External Mode - í˜¸ìŠ¤íŠ¸ NIC ìˆ˜ì¤€ netem ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ Inject host-level network chaos (external)
      when: net_mode == "external"
      block:
        - name: ğŸŒ Announce external chaos start
          ansible.builtin.debug:
            msg: |
              [External Mode] ë…¸ë“œ ì „ì²´ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì… ì‹œì‘:
              - delay={{ network_delay_ms }}ms
              - loss={{ packet_loss_percent }}%
              - corrupt={{ packet_corrupt_percent }}%
              - duration={{ recovery_wait }}s

        - name: âš™ï¸ Apply tc qdisc on host NIC (ens160)
          ansible.builtin.shell: |
            tc qdisc del dev ens160 root || true
            tc qdisc add dev ens160 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%
          ignore_errors: yes
          changed_when: true

        - name: ğŸ§¾ Log external chaos injection
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"
            create: yes
            line: |
              [{{ ansible_date_time.iso8601 }}] NetworkChaos(EXTERNAL): delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}%
          become: true

        - name: â³ Wait for chaos duration
          ansible.builtin.pause:
            seconds: "{{ recovery_wait }}"

        - name: ğŸ§¹ Remove tc qdisc from host NIC
          ansible.builtin.shell: |
            tc qdisc del dev ens160 root || true
          ignore_errors: yes

        - name: ğŸª¶ Log external recovery
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"
            create: yes
            line: |
              [{{ ansible_date_time.iso8601 }}] NetworkChaos(EXTERNAL): restored to normal state
          become: true

        - name: âœ… Log external recovery completion
          ansible.builtin.debug:
            msg: "[External Mode] í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì •ìƒ ë³µì› ì™„ë£Œ."

