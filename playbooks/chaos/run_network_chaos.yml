# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: playbooks/chaos/run_network_chaos.yml     # íŒŒì¼ ê²½ë¡œ
# ëª©ì :
#   - internal: ê° ì„œë¹„ìŠ¤ Pod ë‚´ë¶€ì— tc netemìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - external: Chaos Pod ìƒì„± í›„ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ external ì „í™˜ (Auto-Fallback)
#   - GitLab/ArgoCD í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ì§€ì • ì§€ì›
#   - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ì¼ê´„ ìˆ˜í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Network Chaos (Internal â†’ External Auto-Fallback)  # í”Œë ˆì´ë¶ ì œëª©
  hosts: k3s_master                     # ChaosëŠ” ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰
  become: yes                           # root ê¶Œí•œ í•„ìš” (kubectl, tc ì‚¬ìš©)
  vars:
    target_namespace: "app"             # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ê¸°ë³¸ê°’ app)
    chaos_log_path: "/var/log/chaos_test.log"    # Chaos ë¡œê·¸ íŒŒì¼ ê²½ë¡œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # CI/CD í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • (GitLab / ArgoCD ë“± ì™„ì „ ì§€ì›)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    net_mode: "{{ lookup('env','NET_MODE') | default('internal', true) }}"                 # ì´ˆê¸° ëª¨ë“œ (internal)
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(3000, true) }}"       # ì§€ì—° ì‹œê°„(ms)
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(5, true) }}"    # ì†ì‹¤ë¥ (%)
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(0, true) }}" # ì†ìƒë¥ (%)
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(60, true) }}"             # Chaos ìœ ì§€ ì‹œê°„(ì´ˆ)
    target_app_labels: "{{ lookup('env','TARGET_SERVICES') | default('redis-cart', true) }}" # ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡ (ì‰¼í‘œ êµ¬ë¶„)

  tasks:  # ì‹¤í–‰ ë‹¨ê³„ ì‹œì‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ì•ˆì „ê²€ì‚¬ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate target namespace                # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì „ì„± í™•ì¸
      ansible.builtin.assert:                        # assertë¡œ ì¡°ê±´ ê²€ì¦
        that:                                        # ì¡°ê±´ ì •ì˜
          - target_namespace == "app"                # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ í—ˆìš©
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."  # ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')" # ì„±ê³µ ì‹œ ë©”ì‹œì§€

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ì„œë¹„ìŠ¤ ëª©ë¡ íŒŒì‹±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Parse target services list                # ì‰¼í‘œ êµ¬ë¶„ëœ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}"  # trimìœ¼ë¡œ ê³µë°± ì œê±°
      changed_when: false                             # ë‹¨ìˆœ ë³€ìˆ˜ ì„¤ì •, ë³€ê²½ ì—†ìŒìœ¼ë¡œ í‘œì‹œ

    - name: Show parsed services                      # íŒŒì‹±ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ì¶œë ¥
      ansible.builtin.debug:
        msg: "ğŸ¯ Target services: {{ target_services | join(', ') | default('none') }}"  # ëª©ë¡ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Internal ëª¨ë“œ - Pod ë‚´ë¶€ netem ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Apply internal network chaos              # internal ëª¨ë“œ ì‹¤í–‰
      when: net_mode == "internal"                    # ì¡°ê±´: internal ëª¨ë“œì¼ ë•Œ
      ansible.builtin.shell: |                        # ì…¸ ëª…ë ¹ ì‹¤í–‰
        failed_services=""                            # ì‹¤íŒ¨ ì„œë¹„ìŠ¤ ëª©ë¡ ì´ˆê¸°í™”
        for svc in {{ target_services | join(' ') | default('') }}; do  # ëŒ€ìƒ ì„œë¹„ìŠ¤ ë°˜ë³µ
          echo "[INFO] Testing internal mode for $svc ..."               # ì§„í–‰ ë¡œê·¸
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true) # ì„œë¹„ìŠ¤ì˜ ì²« ë²ˆì§¸ Pod ì¶”ì¶œ
          if [ -z "$POD" ]; then                                        # Pod ì—†ìœ¼ë©´
            echo "[SKIP] No running Pod for $svc"                       # ìŠ¤í‚µ ë©”ì‹œì§€
            continue                                                    # ë‹¤ìŒ ì„œë¹„ìŠ¤ë¡œ ì´ë™
          fi
          # tc ëª…ë ¹ì–´ ìœ ë¬´ í™•ì¸
          if ! kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1; then
            echo "[WARN] tc not available in $svc"                      # netem ë¶ˆê°€ëŠ¥
            failed_services="$failed_services $svc"                     # ì‹¤íŒ¨ ëª©ë¡ ì¶”ê°€
            continue                                                    # ë‹¤ìŒ ì„œë¹„ìŠ¤ë¡œ ì´ë™
          fi
          # ê¸°ì¡´ qdisc ì œê±° ë° netem ì£¼ì…
          echo "[CHAOS] Injecting netem into $svc ($POD)"               # Chaos ì‹œì‘ ë¡œê·¸
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true  # ê¸°ì¡´ ì„¤ì • ì œê±°
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
            delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% {{ 'corrupt ' + packet_corrupt_percent + '%' if packet_corrupt_percent | int > 0 else '' }}  # netem ì¶”ê°€
        done                                                            # forë¬¸ ì¢…ë£Œ
        # ì‹¤íŒ¨ ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ ë¹„ì •ìƒ ì¢…ë£Œ ì½”ë“œ ë°˜í™˜ (fallback íŠ¸ë¦¬ê±°)
        if [ -n "$failed_services" ]; then
          echo "[WARN] Internal failed for:$failed_services"            # ì‹¤íŒ¨ ë¡œê·¸ ì¶œë ¥
          exit 99                                                       # ì¢…ë£Œ ì½”ë“œ 99 (fallback ì‹ í˜¸)
        fi
      register: internal_netem_result                                   # ê²°ê³¼ ì €ì¥
      ignore_errors: yes                                                # ì‹¤íŒ¨ í—ˆìš©
      changed_when: true                                                # ìƒíƒœ ë³€ê²½ìœ¼ë¡œ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ ì‹¤íŒ¨ ê°ì§€ í›„ Externalë¡œ ìë™ ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect internal failure and switch mode                     # ì‹¤íŒ¨ ê°ì§€ ë° ì „í™˜
      when:
        - net_mode == "internal"                                        # í˜„ì¬ internal ëª¨ë“œì¼ ë•Œ
        - internal_netem_result.rc is defined                           # ê²°ê³¼ ì½”ë“œ ì¡´ì¬
        - internal_netem_result.rc != 0                                 # ì‹¤íŒ¨ ì½”ë“œë©´
      ansible.builtin.set_fact:
        net_mode: "external"                                            # ëª¨ë“œë¥¼ externalë¡œ ì „í™˜
      changed_when: true                                                # ìƒíƒœ ë³€ê²½ìœ¼ë¡œ í‘œì‹œ

    - name: Announce fallback activation                                # ì „í™˜ ì•Œë¦¼ ë¡œê·¸ ì¶œë ¥
      when: net_mode == "external"                                      # ì „í™˜ ì‹œì—ë§Œ
      ansible.builtin.debug:
        msg: "âš ï¸ Internal Chaos ì‹¤íŒ¨ â€” External ëª¨ë“œë¡œ ìë™ ì „í™˜ (ì„œë¹„ìŠ¤ë³„ ì£¼ì…)."

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ External ëª¨ë“œ - ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Launch external chaos pods per service                      # external ëª¨ë“œ ì‹¤í–‰
      when: net_mode == "external"                                      # external ëª¨ë“œì¼ ë•Œë§Œ
      ansible.builtin.shell: |                                          # ì…¸ ëª…ë ¹ ì‹¤í–‰
        for svc in {{ target_services | join(' ') | default('') }}; do  # ê° ì„œë¹„ìŠ¤ ë°˜ë³µ
          echo "[EXTERNAL] Launching network chaos pod for $svc ..."    # ì‹œì‘ ë¡œê·¸ ì¶œë ¥
          SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)        # 6ìë¦¬ UUID ìƒì„± (Pod ì´ë¦„ ì¤‘ë³µ ë°©ì§€)
          kubectl run net-chaos-$svc-$SUFFIX \                          # Chaos Pod ì‹¤í–‰
            --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \  # ì¼íšŒì„± Pod
            --overrides='{  # Pod ìŠ¤í™ ì˜¤ë²„ë¼ì´ë“œ ì‹œì‘
              "metadata": {
                "labels": {
                  "app": "network-chaos",
                  "app.kubernetes.io/name": "network-chaos",
                  "app.kubernetes.io/part-of": "online-boutique-chaos-lab",
                  "app.kubernetes.io/tier": "backend",
                  "app.kubernetes.io/component": "chaos-network"
                }
              },
              "spec": {
                "containers": [{
                  "name": "net-chaos",                                  # ì»¨í…Œì´ë„ˆ ì´ë¦„
                  "image": "nicolaka/netshoot:latest",                  # ì´ë¯¸ì§€
                  "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } }, # ë„¤íŠ¸ì›Œí¬ ì„¤ì • ê¶Œí•œ ë¶€ì—¬
                  "command": ["/bin/sh","-c"],                          # ì…¸ ì‹¤í–‰
                  "args": [
                    "tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% {{ 'corrupt ' + packet_corrupt_percent + '%' if packet_corrupt_percent | int > 0 else '' }}; \
                     echo '[CHAOS] Injected network delay/loss on $svc'; \
                     sleep {{ chaos_duration }}; \
                     echo '[RECOVERY] Restoring network for $svc...'; \
                     tc qdisc del dev eth0 root || true; \
                     kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;" # ì™„ë£Œ í›„ ìê¸° ì‚­ì œ
                  ]
                }]
              }
            }' || true                                                  # ì˜¤ë¥˜ ë¬´ì‹œ
        done                                                            # forë¬¸ ì¢…ë£Œ
      register: external_chaos_result                                   # ê²°ê³¼ ì €ì¥
      ignore_errors: yes                                                # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true                                                # ë³€ê²½ ë°œìƒìœ¼ë¡œ í‘œì‹œ

    - name: Show external chaos summary                                 # ì™¸ë¶€ ëª¨ë“œ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      when: net_mode == "external"                                      # external ëª¨ë“œì¼ ë•Œë§Œ
      ansible.builtin.debug:
        msg: "{{ external_chaos_result.stdout | default('External chaos executed successfully') }}"  # ê²°ê³¼ ì¶œë ¥

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ Chaos ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write chaos log entry                                       # ë¡œê·¸ íŒŒì¼ì— ê²°ê³¼ ê¸°ë¡
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"                                    # Chaos ë¡œê·¸ ê²½ë¡œ
        create: true                                                   # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
        line: |                                                        # ë¡œê·¸ í˜•ì‹ ì§€ì •
          [{{ lookup('pipe','date -Iseconds') }}] NetworkChaos(ns={{ target_namespace }}) mode={{ net_mode }} delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}% targets={{ target_services | join(', ') | default('none') }}
      become: yes                                                      # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ ì‘ì„±

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final summary                                               # ìµœì¢… ê²°ê³¼ ìš”ì•½
      ansible.builtin.debug:
        msg: |                                                          # ì—¬ëŸ¬ ì¤„ ì¶œë ¥
          âœ… Network Chaos Injection Completed
          - Mode: {{ net_mode }}                                        # ìµœì¢… ëª¨ë“œ ì¶œë ¥
          - Namespace: {{ target_namespace }}                           # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶œë ¥
          - Duration: {{ chaos_duration }}s                             # ì§€ì†ì‹œê°„
          - Delay: {{ network_delay_ms }}ms                             # ì§€ì—°ì‹œê°„
          - Loss: {{ packet_loss_percent }}%                            # ì†ì‹¤ë¥ 
          - Corrupt: {{ packet_corrupt_percent }}%                      # ì†ìƒë¥ 
          - Targets: {{ target_services | join(', ') | default('none') }} # íƒ€ê²Ÿ ëª©ë¡
          - Log Path: {{ chaos_log_path }}                              # ë¡œê·¸ ê²½ë¡œ
          - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.                     # ë³µêµ¬ ì•ˆë‚´ ë¬¸êµ¬
