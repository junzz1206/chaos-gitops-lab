# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_network_chaos.yml
# ëª©ì :
#   - redis-cart Podì— ë„¤íŠ¸ì›Œí¬ ì§€ì—°, ì†ì‹¤, ìˆœì„œë³€ê²½ ë“± ì£¼ì…
#   - Chaos ì‹¤í—˜ í›„ ìƒíƒœ ê²€ì¦ ë° ë¡œê·¸ ê¸°ë¡
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, network_delay_ms, chaos_log_path, recovery_wait
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸŒ Run Redis Network Chaos
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    network_delay_ms: "{{ network_delay_ms | default(300) }}"
    packet_loss_percent: "{{ packet_loss_percent | default(2) }}"
    packet_corrupt_percent: "{{ packet_corrupt_percent | default(1) }}"
    recovery_wait: 10
    chaos_log_path: "/var/log/chaos_test.log"

  tasks:
    # Step 1ï¸âƒ£: Safety Check
    - name: ğŸ§© Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # Step 2ï¸âƒ£: Locate redis-cart Pod
    - name: ğŸ” Locate redis-cart pod
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} -l app=redis-cart -o name | head -n 1
      register: redis_pod
      changed_when: false

    - name: âŒ Abort if redis-cart pod not found
      ansible.builtin.fail:
        msg: "redis-cart Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      when: redis_pod.stdout == ""

    # Step 3ï¸âƒ£: Inject Network Chaos
    - name: ğŸ’£ Inject combined network chaos (delay + loss + corrupt)
      ansible.builtin.shell: |
        kubectl exec -n {{ target_namespace }} {{ redis_pod.stdout }} -- \
          tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%
      register: netem_result
      ignore_errors: yes
      changed_when: true

    # Step 4ï¸âƒ£: Log Injection
    - name: ğŸ§¾ Log network chaos injection
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] NetworkChaos: redis-cart delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}%
      become: true

    # Step 5ï¸âƒ£: Wait for effect
    - name: â³ Wait for network chaos effect to take hold
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 6ï¸âƒ£: Verify network condition (optional ping test)
    - name: ğŸ“¡ Test response time from cartservice to redis-cart
      ansible.builtin.shell: |
        CART_POD=$(kubectl get pods -n {{ target_namespace }} -l app=cartservice -o jsonpath='{.items[0].metadata.name}')
        kubectl exec -n {{ target_namespace }} $CART_POD -- ping -c 3 redis-cart | tail -n 5
      register: ping_result
      ignore_errors: yes

    - name: ğŸ§¾ Display ping result summary
      ansible.builtin.debug:
        msg: |
          ğŸ§  ë„¤íŠ¸ì›Œí¬ Chaos ìƒíƒœ ì ê²€ ê²°ê³¼:
          {{ ping_result.stdout | default('Ping ê²°ê³¼ ì—†ìŒ') }}

    # Step 7ï¸âƒ£: Optional clear (cleanup for next test)
    - name: ğŸ§¹ Remove netem chaos (restore normal state)
      ansible.builtin.shell: |
        kubectl exec -n {{ target_namespace }} {{ redis_pod.stdout }} -- tc qdisc del dev eth0 root || true
      ignore_errors: yes

    # Step 8ï¸âƒ£: Log cleanup
    - name: ğŸª¶ Write cleanup log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] NetworkChaos: redis-cart restored to normal state
      become: true

