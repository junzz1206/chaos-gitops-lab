# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: playbooks/chaos/run_network_chaos.yml
# ëª©ì :
#   - internal: ê° ì„œë¹„ìŠ¤ Pod ë‚´ë¶€ì— netemìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - external: Chaos Pod ìƒì„± í›„ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ external ì „í™˜ (Auto-Fallback)
#   - GitLab/ArgoCD í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ì§€ì • ì§€ì›
#   - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Network Chaos (Internal / External Auto-Fallback)
  hosts: k3s_master                     # ChaosëŠ” ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ìˆ˜í–‰
  become: yes                           # root ê¶Œí•œ í•„ìš” (kubectl, tc ëª…ë ¹ ì‹¤í–‰)
  vars:
    target_namespace: "app"             # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_log_path: "/var/log/chaos_test.log"    # Chaos ê²°ê³¼ ë¡œê·¸ ê²½ë¡œ

    # í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • (GitLab / ArgoCD ëª¨ë‘ ì§€ì›)
    net_mode: "{{ lookup('env','NET_MODE') | default('internal', true) }}"          # internal or external
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(3000, true) }}" # ì§€ì—° ì‹œê°„(ms)
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(5, true) }}" # íŒ¨í‚· ì†ì‹¤ë¥ (%)
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(0, true) }}" # íŒ¨í‚· ì†ìƒë¥ (%)
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(60, true) }}"        # Chaos ì§€ì†ì‹œê°„(ì´ˆ)
    target_app_labels: "{{ lookup('env','TARGET_SERVICES') | default('redis-cart', true) }}" # ê¸°ë³¸ íƒ€ê²Ÿ ì„œë¹„ìŠ¤

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ì•ˆì „ê²€ì‚¬ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"   # app ì™¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‹¤í–‰ ê¸ˆì§€
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ì„œë¹„ìŠ¤ ëª©ë¡ íŒŒì‹±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Parse target services list
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}"  # ì‰¼í‘œ ê¸°ì¤€ íŒŒì‹±
      changed_when: false

    - name: Show parsed services
      ansible.builtin.debug:
        msg: "ğŸ¯ Target services: {{ target_services | join(', ') | default('none') }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Internal Mode - Pod ë‚´ë¶€ netem ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Apply internal network chaos
      when: net_mode == "internal"
      ansible.builtin.shell: |
        failed_services=""
        for svc in {{ target_services | join(' ') | default('') }}; do
          echo "[INFO] Testing internal mode for $svc ..."
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -z "$POD" ]; then
            echo "[SKIP] No running Pod for $svc"
            continue
          fi
          # tc ìœ ë¬´ í™•ì¸
          if ! kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1; then
            echo "[WARN] tc not available in $svc"
            failed_services="$failed_services $svc"
            continue
          fi
          # ê¸°ì¡´ qdisc ì œê±° ë° netem ì£¼ì…
          echo "[CHAOS] Injecting netem into $svc ($POD)"
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
            delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% {{ 'corrupt ' + packet_corrupt_percent + '%' if packet_corrupt_percent | int > 0 else '' }}
        done
        # ì‹¤íŒ¨ ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ ë¹„ì •ìƒ ì¢…ë£Œ ì½”ë“œë¡œ ë°˜í™˜ (fallback trigger)
        if [ -n "$failed_services" ]; then
          echo "[WARN] Internal failed for:$failed_services"
          exit 99
        fi
      register: internal_netem_result
      ignore_errors: yes              # ì‹¤íŒ¨í•´ë„ playbook ê³„ì† ì§„í–‰
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ ì‹¤íŒ¨ ê°ì§€ í›„ Externalë¡œ ìë™ ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect internal failure and switch mode
      when:
        - net_mode == "internal"
        - internal_netem_result.rc is defined
        - internal_netem_result.rc != 0
      ansible.builtin.set_fact:
        net_mode: "external"          # net_modeë¥¼ externalë¡œ ì „í™˜
      changed_when: true

    - name: Announce fallback activation
      when: net_mode == "external"
      ansible.builtin.debug:
        msg: "âš ï¸ Internal Chaos ì‹¤íŒ¨ â€” External ëª¨ë“œë¡œ ìë™ ì „í™˜ (ì„œë¹„ìŠ¤ë³„ ì£¼ì…)."

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ External Mode - ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Launch external chaos pods per service
      when: net_mode == "external"
      ansible.builtin.shell: |
        for svc in {{ target_services | join(' ') | default('') }}; do
          echo "[EXTERNAL] Launching network chaos pod for $svc ..."
          kubectl run net-chaos-$svc --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "net-chaos",
                  "image": "nicolaka/netshoot:latest",
                  "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } },
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% {{ 'corrupt ' + packet_corrupt_percent + '%' if packet_corrupt_percent | int > 0 else '' }}; \
                     echo \"[CHAOS] \$svc: Delay={{ network_delay_ms }}ms Loss={{ packet_loss_percent }}%\"; \
                     sleep {{ chaos_duration }}; \
                     echo \"[RECOVERY] Restoring network for \$svc...\"; \
                     tc qdisc del dev eth0 root || true;"
                  ]
                }]
              }
            }' || true
        done
      register: external_chaos_result
      ignore_errors: yes
      changed_when: true

    - name: Show external chaos summary
      when: net_mode == "external"
      ansible.builtin.debug:
        msg: "{{ external_chaos_result.stdout | default('External chaos executed successfully') }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ Chaos ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write chaos log entry
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"                # Chaos ë¡œê·¸ ê²½ë¡œ
        create: true                               # ì—†ìœ¼ë©´ ìƒì„±
        line: |
          [{{ lookup('pipe','date -Iseconds') }}] NetworkChaos(ns={{ target_namespace }}) mode={{ net_mode }} delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}% targets={{ target_services | join(', ') | default('none') }}
      become: yes                                   # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ ì‘ì„±

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Network Chaos Injection Completed
          - Mode: {{ net_mode }}
          - Namespace: {{ target_namespace }}
          - Duration: {{ chaos_duration }}s
          - Delay: {{ network_delay_ms }}ms
          - Loss: {{ packet_loss_percent }}%
          - Corrupt: {{ packet_corrupt_percent }}%
          - Targets: {{ target_services | join(', ') | default('none') }}
          - Log Path: {{ chaos_log_path }}
