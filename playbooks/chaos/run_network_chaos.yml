# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: playbooks/chaos/run_network_chaos.yml
# ëª©ì :
#   - internal: ì§€ì •ëœ ì„œë¹„ìŠ¤ Pod ë‚´ë¶€ì— ë„¤íŠ¸ì›Œí¬ ì§€ì—°/ì†ì‹¤/ì†ìƒ ì£¼ì…
#   - external: ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„± í›„ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì…
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ external ì „í™˜
#   - CI/CD(GitLab, ArgoCD ë“±) í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ì§€ì • ì§€ì›
#   - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# GitLab / ArgoCD í™˜ê²½ë³€ìˆ˜ ì˜ˆì‹œ:
#   TARGET_SERVICES="frontend,checkoutservice"
#   NET_MODE="external"
#   NETWORK_DELAY_MS="3000"
#   PACKET_LOSS_PERCENT="5"
#   PACKET_CORRUPT_PERCENT="0"
#   CHAOS_DURATION="120"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸŒ Run Network Chaos (Internal / External Auto-Fallback)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    chaos_log_path: "/var/log/chaos_test.log"

    # CI/CD ë° ë¡œì»¬ í™˜ê²½ ë³€ìˆ˜ íŒŒì‹±
    net_mode: "{{ lookup('env','NET_MODE') | default('internal', true) }}"
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(3000, true) }}"
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(5, true) }}"
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(0, true) }}"
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(60, true) }}"
    target_app_labels: "{{ lookup('env','TARGET_SERVICES') | default('redis-cart', true) }}"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ Safety Check - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§© Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ì„œë¹„ìŠ¤ íŒŒì‹±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Parse target services list
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}"
      changed_when: false

    - name: Show parsed services
      ansible.builtin.debug:
        msg: "ğŸ¯ Target services: {{ target_services | join(', ') }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Internal Mode - Pod ë‚´ë¶€ netem ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ’£ Apply internal network chaos
      when: net_mode == "internal"
      ansible.builtin.shell: |
        failed_services=""
        for svc in {{ target_services | join(' ') }}; do
          echo "[INFO] Testing internal mode for $svc ..."
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -z "$POD" ]; then
            echo "[SKIP] No running Pod for $svc"
            continue
          fi
          if ! kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1; then
            echo "[WARN] tc not available in $svc"
            failed_services="$failed_services $svc"
            continue
          fi
          echo "[CHAOS] Injecting netem into $svc ($POD)"
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true
          kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
            delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%
        done
        if [ -n "$failed_services" ]; then
          echo "[WARN] Internal failed for:$failed_services"
          exit 99
        fi
      register: internal_netem_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Fallback ê°ì§€ ë° External ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect internal failure and switch mode
      when:
        - net_mode == "internal"
        - internal_netem_result.rc is defined
        - internal_netem_result.rc != 0
      ansible.builtin.set_fact:
        net_mode: "external"
      changed_when: true

    - name: âš ï¸ Announce fallback activation
      when: net_mode == "external"
      ansible.builtin.debug:
        msg: "âš ï¸ Internal Chaos ì‹¤íŒ¨ â€” External ëª¨ë“œë¡œ ìë™ ì „í™˜ (ì„œë¹„ìŠ¤ë³„ ì£¼ì…)."

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ External Mode - ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„±
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ Launch external chaos pods per service
      when: net_mode == "external"
      ansible.builtin.shell: |
        for svc in {{ target_services | join(' ') }}; do
          echo "[EXTERNAL] Launching network chaos pod for $svc ..."
          kubectl run net-chaos-$svc --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "net-chaos",
                  "image": "nicolaka/netshoot:latest",
                  "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } },
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%; \
                     echo \"[CHAOS] $svc: Delay={{ network_delay_ms }}ms Loss={{ packet_loss_percent }}% Corrupt={{ packet_corrupt_percent }}%\"; \
                     sleep {{ chaos_duration }}; \
                     echo \"[RECOVERY] Restoring network for $svc...\"; \
                     tc qdisc del dev eth0 root || true;"
                  ]
                }]
              }
            }' || true
        done
      register: external_chaos_result
      ignore_errors: yes
      changed_when: true

    - name: âœ… Show external chaos summary
      when: net_mode == "external"
      ansible.builtin.debug:
        msg: "{{ external_chaos_result.stdout | default('External chaos executed successfully') }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ Chaos ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸª¶ Write chaos log entry
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] NetworkChaos(ns={{ target_namespace }}) mode={{ net_mode }} delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}% targets={{ target_services | join(', ') }}
      become: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ìµœì¢… ë©”ì‹œì§€ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Network Chaos Injection Completed
          - Mode: {{ net_mode }}
          - Namespace: {{ target_namespace }}
          - Duration: {{ chaos_duration }}s
          - Delay: {{ network_delay_ms }}ms
          - Loss: {{ packet_loss_percent }}%
          - Corrupt: {{ packet_corrupt_percent }}%
          - Targets: {{ target_services | join(', ') }}
          - Log Path: {{ chaos_log_path }}


