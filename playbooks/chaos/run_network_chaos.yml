# ─────────────────────────────────────────────
# Chaos Mesh NetworkChaos (Stable Final)
# ─────────────────────────────────────────────

- name: Run Network Chaos (Chaos Mesh CR + Traffic)
  hosts: k3s_master
  become: yes

  vars:
    target_namespace: "app"
    chaos_log_path: "/var/log/chaos_test.log"

    # ENV
    net_action: "{{ lookup('env','NET_ACTION') | default('delay', true) }}"
    target_service: "{{ lookup('env','TARGET_SERVICE') | default('frontend', true) }}"
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(60, true) | int }}"

    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(2000, true) | int }}"
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(5, true) | int }}"
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(1, true) | int }}"

    traffic_enable: "{{ lookup('env','TRAFFIC_ENABLE') | default('false', true) | bool }}"
    traffic_qps: "{{ lookup('env','TRAFFIC_QPS') | default(50, true) | int }}"
    traffic_url: "{{ lookup('env','TRAFFIC_URL') | default('http://frontend:80/', true) }}"
    traffic_deploy_name: "fortio-loadgen"
    chaos_name: "net-{{ net_action }}-{{ target_service }}"

  tasks:
  # ─────────────────────────────────────────────
  # 1️⃣ Safety
  # ─────────────────────────────────────────────
  - name: Validate namespace
    ansible.builtin.assert:
      that:
        - target_namespace == "app"
      success_msg: "✅ namespace 확인 완료 ('app')"
      fail_msg: "❌ namespace는 app만 허용"

  - name: Validate NET_ACTION
    ansible.builtin.assert:
      that:
        - net_action in ['delay','loss','corrupt']
      success_msg: "✅ NET_ACTION={{ net_action }}"
      fail_msg: "❌ NET_ACTION은 delay/loss/corrupt 중 하나여야 함"

  # ─────────────────────────────────────────────
  # 2️⃣ Traffic Generator (Fortio, persistent Deployment)
  # ─────────────────────────────────────────────
  - name: Ensure traffic generator deployment (Fortio, persistent)
    when: traffic_enable
    ansible.builtin.shell: |
      cat <<EOF | kubectl apply -n {{ target_namespace }} -f -
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: fortio-loadgen
        labels:
          app: fortio-loadgen
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: fortio-loadgen
        template:
          metadata:
            labels:
              app: fortio-loadgen
          spec:
            terminationGracePeriodSeconds: 0
            containers:
              - name: fortio
                image: fortio/fortio:latest
                imagePullPolicy: IfNotPresent
                command: ["fortio"]
                args:
                  - load
                  - -qps
                  - "{{ traffic_qps }}"
                  - -t
                  - "0"
                  - "{{ traffic_url }}"
      EOF
    changed_when: true

  - name: Wait for fortio deployment ready (non-fatal, with diagnostics)
    when: traffic_enable
    ansible.builtin.shell: |
      kubectl -n {{ target_namespace }} rollout status deploy/fortio-loadgen --timeout=180s
    register: fortio_rollout
    changed_when: false
    failed_when: false

  - name: Show fortio rollout result
    when: traffic_enable
    ansible.builtin.debug:
      var: fortio_rollout.stdout_lines

  - name: Fortio diagnostics when not ready
    when:
      - traffic_enable
      - fortio_rollout.rc is defined
      - fortio_rollout.rc != 0
    block:
      - name: Show fortio pods
        ansible.builtin.shell: |
          kubectl -n {{ target_namespace }} get pods -l app=fortio-loadgen -owide
        register: fortio_pods
        changed_when: false
        failed_when: false

      - name: Describe fortio pod
        ansible.builtin.shell: |
          POD=$(kubectl -n {{ target_namespace }} get pod -l app=fortio-loadgen -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            kubectl -n {{ target_namespace }} describe pod "$POD" | tail -n 120
          else
            echo "No fortio pod found"
          fi
        register: fortio_desc
        changed_when: false
        failed_when: false

      - name: Logs fortio pod
        ansible.builtin.shell: |
          POD=$(kubectl -n {{ target_namespace }} get pod -l app=fortio-loadgen -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            kubectl -n {{ target_namespace }} logs "$POD" --tail=80 || true
          else
            echo "No fortio pod found"
          fi
        register: fortio_logs
        changed_when: false
        failed_when: false

      - name: Print fortio diagnostics (so playbook continues)
        ansible.builtin.debug:
          msg: |
            ⚠️ Fortio가 Ready가 안 됨(rollout timeout) → Chaos 단계는 계속 진행
            --- pods ---
            {{ fortio_pods.stdout | default('') }}
            --- describe(tail) ---
            {{ fortio_desc.stdout | default('') }}
            --- logs(tail) ---
            {{ fortio_logs.stdout | default('') }}

  # ─────────────────────────────────────────────
  # 3️⃣ Chaos Mesh CR (action 별 분리)
  # ─────────────────────────────────────────────
  - name: Remove existing NetworkChaos
    ansible.builtin.shell: |
      kubectl -n {{ target_namespace }} delete networkchaos {{ chaos_name }} --ignore-not-found
    changed_when: true

  - name: Write NetworkChaos (delay)
    when: net_action == "delay"
    ansible.builtin.copy:
      dest: /tmp/networkchaos.yaml
      content: |
        apiVersion: chaos-mesh.org/v1alpha1
        kind: NetworkChaos
        metadata:
          name: {{ chaos_name }}
          namespace: {{ target_namespace }}
        spec:
          action: delay
          mode: one
          selector:
            namespaces: [{{ target_namespace }}]
            labelSelectors:
              app: {{ target_service }}
          direction: to
          delay:
            latency: "{{ network_delay_ms }}ms"

  - name: Write NetworkChaos (loss)
    when: net_action == "loss"
    ansible.builtin.copy:
      dest: /tmp/networkchaos.yaml
      content: |
        apiVersion: chaos-mesh.org/v1alpha1
        kind: NetworkChaos
        metadata:
          name: {{ chaos_name }}
          namespace: {{ target_namespace }}
        spec:
          action: loss
          mode: one
          selector:
            namespaces: [{{ target_namespace }}]
            labelSelectors:
              app: {{ target_service }}
          direction: to
          duration: "{{ chaos_duration }}s"
          loss:
            loss: "{{ packet_loss_percent }}"

  - name: Write NetworkChaos (corrupt)
    when: net_action == "corrupt"
    ansible.builtin.copy:
      dest: /tmp/networkchaos.yaml
      content: |
        apiVersion: chaos-mesh.org/v1alpha1
        kind: NetworkChaos
        metadata:
          name: {{ chaos_name }}
          namespace: {{ target_namespace }}
        spec:
          action: corrupt
          mode: one
          selector:
            namespaces: [{{ target_namespace }}]
            labelSelectors:
              app: {{ target_service }}
          direction: to
          duration: "{{ chaos_duration }}s"
          corrupt:
            corrupt: "{{ packet_corrupt_percent }}"

  # ─────────────────────────────────────────────
  # 4️⃣ Apply
  # ─────────────────────────────────────────────
  - name: Apply NetworkChaos CR (retry-safe)
    ansible.builtin.shell: |
      kubectl apply -f /tmp/networkchaos.yaml
    register: chaos_apply
    retries: 5
    delay: 5
    until: chaos_apply.rc == 0
    changed_when: true

  # ─────────────────────────────────────────────
  # 5️⃣ Summary
  # ─────────────────────────────────────────────
  - name: Final summary
    ansible.builtin.debug:
      msg: |
        ✅ NetworkChaos Applied (Chaos Mesh)
        - Action: {{ net_action }}
        - Target: app={{ target_service }}
        - Duration: {{ chaos_duration }}s
        - Delay: {{ network_delay_ms }}ms
        - Loss: {{ packet_loss_percent }}%
        - Corrupt: {{ packet_corrupt_percent }}%
        - Traffic: {{ traffic_enable }} (QPS={{ traffic_qps }})

