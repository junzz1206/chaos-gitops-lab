# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_pod_kill.yml
# ëª©ì :
#   - app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ íŠ¹ì • ë˜ëŠ” ë¬´ì‘ìœ„ Pod ì‚­ì œ
#   - Internal(default): Pod ë‚´ë¶€ì—ì„œ Chaos ìˆ˜í–‰
#   - External: Chaos Pod ìƒì„±ìœ¼ë¡œ ë™ì¼ ì‚­ì œ ìˆ˜í–‰
#   - GitLab/ArgoCD(CI/CD)ì—ì„œëŠ” TARGET_PODS í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì§€ì •
#   - CLIì—ì„œëŠ” pod_kill_targets.ymlì„ í†µí•´ ì§€ì • (fallback)
#   - disable_autorecover_local=true ì‹œ ReplicaSet ë³µêµ¬ ì°¨ë‹¨
#   - execution_modeì— ë”°ë¼ ìˆœì°¨/ë³‘ë ¬ ëª¨ë“œ ì§€ì›
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ’€ Run Pod Kill Chaos (Internal / External + CI/CD aware)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    kill_count_local: "{{ lookup('env','KILL_COUNT') | default(2, true) }}"
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(30, true) }}"
    chaos_log_path_local: "/var/log/chaos_test.log"
    disable_autorecover_local: "{{ lookup('env','DISABLE_AUTORECOVER') | default(false, true) }}"
    execution_mode: "{{ lookup('env','EXECUTION_MODE') | default('sequential', true) }}"
    pod_kill_mode: "{{ lookup('env','KILL_MODE') | default('internal', true) }}"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ Safety Check
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§© Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ëŒ€ìƒ íŒŒë“œ ë¡œë“œ (í™˜ê²½ë³€ìˆ˜ â†’ íŒŒì¼ â†’ ê¸°ë³¸)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Resolve target pods from environment or file
      vars:
        env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"
      block:
        - name: Load pod targets from CI/CD environment
          when: env_target_pods | length > 0
          ansible.builtin.set_fact:
            target_pods_effective: "{{ env_target_pods.split(',') | map('trim') | list }}"
          changed_when: false

        - name: Load fallback pod targets from pod_kill_targets.yml
          when:
            - (env_target_pods | length == 0)
            - lookup('file', '{{ playbook_dir }}/../../pod_kill_targets.yml', errors='ignore') is not none
          ansible.builtin.include_vars:
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"
            name: pod_targets_fallback

        - name: Apply fallback pod target list
          when:
            - env_target_pods | length == 0
            - pod_targets_fallback is defined and pod_targets_fallback.pod_targets is defined
          ansible.builtin.set_fact:
            target_pods_effective: "{{ pod_targets_fallback.pod_targets }}"
          changed_when: false

        - name: Default to empty list if nothing resolved
          when: target_pods_effective is not defined
          ansible.builtin.set_fact:
            target_pods_effective: []
          changed_when: false

    - name: Display resolved targets
      ansible.builtin.debug:
        msg: |
          ğŸ¯ Pod Kill ëŒ€ìƒ:
          - ENV(TARGET_PODS): {{ lookup('env','TARGET_PODS') | default('N/A') }}
          - File(pod_kill_targets.yml): {{ pod_targets_fallback.pod_targets | default([]) }}
          - Effective Targets: {{ target_pods_effective | default([]) }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ Chaos í™˜ê²½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Print chaos configuration
      ansible.builtin.debug:
        msg: |
          âš™ï¸ Pod Kill Chaos ì„¤ì •
          - ì‹¤í–‰ ëª¨ë“œ: {{ execution_mode }}
          - Kill Mode: {{ pod_kill_mode }}
          - ì‚­ì œ ê°œìˆ˜: {{ kill_count_local }}
          - Disable AutoRecover: {{ disable_autorecover_local }}
          - ëŒ€ìƒ Pods: {{ target_pods_effective | join(', ') if target_pods_effective | length > 0 else 'ëœë¤ ì„ íƒ' }}
          - ë¡œê·¸ ê²½ë¡œ: {{ chaos_log_path_local }}
          - ë³µêµ¬ ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Disable Auto-Recover (ì˜µì…˜)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Disable auto recovery for target pods
      when:
        - disable_autorecover_local | bool
        - target_pods_effective | length > 0
      ansible.builtin.shell: |
        echo "ğŸ›‘ Disabling ReplicaSet auto recovery..."
        for svc in {{ target_pods_effective | join(' ') }}; do
          kubectl scale deploy -n {{ target_namespace }} -l app=$svc --replicas=0 || true
          kubectl scale rs -n {{ target_namespace }} -l app=$svc --replicas=0 || true
          kubectl scale statefulset -n {{ target_namespace }} -l app=$svc --replicas=0 || true
        done
      changed_when: true
      ignore_errors: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Internal Kill Mode
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ’€ Delete target pods internally
      when: pod_kill_mode == "internal"
      ansible.builtin.shell: |
        if [ {{ target_pods_effective | length }} -eq 0 ]; then
          echo "[RANDOM MODE] Selecting {{ kill_count_local }} random pods..."
          PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ kill_count_local }})
        else
          PODS=$(for svc in {{ target_pods_effective | join(' ') }}; do kubectl get pod -n {{ target_namespace }} -l app=$svc -o name; done)
        fi

        echo "[EXECUTION] {{ execution_mode }} mode active."
        if [ "{{ execution_mode }}" = "parallel" ]; then
          echo "[âš¡] Parallel kill started."
          for p in $PODS; do kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force & done
          wait
        else
          echo "[ğŸ§©] Sequential kill started."
          for p in $PODS; do
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force
            sleep {{ recovery_wait }}
          done
        fi
        echo "[DONE] Internal Pod Kill Completed."
      register: internal_kill_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ Internal ì‹¤íŒ¨ ì‹œ External ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Detect internal failure and switch mode
      when:
        - pod_kill_mode == "internal"
        - internal_kill_result.rc is defined
        - internal_kill_result.rc != 0
      ansible.builtin.set_fact:
        pod_kill_mode: "external"
      changed_when: true

    - name: âš ï¸ Announce fallback to external
      when: pod_kill_mode == "external"
      ansible.builtin.debug:
        msg: "âš ï¸ Internal ì‹¤íŒ¨ â†’ External Chaos ëª¨ë“œ ì „í™˜ (ì„œë¹„ìŠ¤ë³„ Chaos Pod ìƒì„±)"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ External Mode (CI/CD ì§€ì • ëŒ€ìƒ or íŒŒì¼ ê¸°ë°˜ ëŒ€ìƒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§¨ Launch chaos pods for external deletion
      when: pod_kill_mode == "external"
      ansible.builtin.shell: |
        for svc in {{ target_pods_effective | join(' ') }}; do
          echo "[EXTERNAL] Launching chaos pod for $svc..."
          kubectl run kill-chaos-$svc --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "kill-chaos",
                  "image": "nicolaka/netshoot:latest",
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "echo \"[CHAOS] Deleting pods for $svc...\"; \
                     kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true; \
                     echo \"[CHAOS] Done for $svc.\"; sleep {{ recovery_wait }};"
                  ]
                }]
              }
            }' || true
        done
      register: external_kill_result
      ignore_errors: yes
      changed_when: true

    - name: âœ… External kill summary
      when: pod_kill_mode == "external"
      ansible.builtin.debug:
        msg: "{{ external_kill_result.stdout | default('External Chaos Completed Successfully') }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ Verify Current State
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Verify current pod states
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      ignore_errors: yes
      changed_when: false

    - name: Print pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Pod Kill Chaos ê²°ê³¼
          {{ pod_state.stdout | default('âš ï¸ Pod ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸªµ Write chaos summary to log file
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_local }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] PodKill mode={{ pod_kill_mode }} exec={{ execution_mode }} ns={{ target_namespace }} killed={{ target_pods_effective | length if target_pods_effective | length > 0 else kill_count_local }} targets={{ target_pods_effective | join(', ') if target_pods_effective | length > 0 else 'ëœë¤' }} result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”Ÿ ìµœì¢… ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Chaos Pod Kill ì™„ë£Œ
          - ì‹¤í–‰ ëª¨ë“œ: {{ execution_mode }}
          - Kill Mode: {{ pod_kill_mode }}
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ëŒ€ìƒ: {{ target_pods_effective | join(', ') if target_pods_effective | length > 0 else 'ëœë¤ ì„ íƒ' }}
          - ë¡œê·¸ íŒŒì¼: {{ chaos_log_path_local }}
          - ë³µêµ¬ ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ
