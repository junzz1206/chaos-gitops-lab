# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_pod_kill.yml
# ëª©ì :
#   - Pod ì‚­ì œ Chaos (Internal / External ì§€ì›)
#   - CI/CD í™˜ê²½: TARGET_PODS í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì§€ì •
#   - CLI í™˜ê²½: pod_kill_targets.yml fallback
#   - Internal ì‹¤íŒ¨ ì‹œ Externalë¡œ ìë™ ì „í™˜
#   - ë³‘ë ¬ / ìˆœì°¨ ì‹¤í–‰ ì§€ì›
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Pod Kill Chaos (Internal / External, Safe Refactor)
  hosts: k3s_master                 # ChaosëŠ” ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰
  become: yes                       # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ (kubectl ê¶Œí•œ í•„ìš”)
  vars:
    target_namespace: "app"         # Chaosë¥¼ ì‹¤í–‰í•  ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    kill_count_local: "{{ lookup('env','KILL_COUNT') | default(2, true) | int }}"   # ëœë¤ ì‚­ì œ ê°œìˆ˜ (ê¸°ë³¸ê°’ 2)
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(30, true) | int }}"  # ê° ë‹¨ê³„ ê°„ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    chaos_log_path_local: "/var/log/chaos_test.log"   # Chaos ë¡œê·¸ ê²½ë¡œ
    disable_autorecover_local: "{{ lookup('env','DISABLE_AUTORECOVER') | default(false, true) | bool }}"  # ìë™ë³µêµ¬ ì°¨ë‹¨ ì—¬ë¶€
    execution_mode: "{{ lookup('env','EXECUTION_MODE') | default('sequential', true) }}"  # sequential / parallel ëª¨ë“œ
    pod_kill_mode: "{{ lookup('env','KILL_MODE') | default('internal', true) }}"          # internal / external ëª¨ë“œ

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ì•ˆì „ê²€ì‚¬ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Safety Check - namespace
      ansible.builtin.assert:
        that: target_namespace == "app"    # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œë§Œ ì‹¤í–‰ ê°€ëŠ¥
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."    # ì˜ëª»ëœ ê²½ìš° ì—ëŸ¬ ì¶œë ¥
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"  # ì •ìƒ í†µê³¼ ì‹œ ë©”ì‹œì§€

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ëŒ€ìƒ Pod ëª©ë¡ ë¡œë“œ (í™˜ê²½ë³€ìˆ˜ â†’ íŒŒì¼ â†’ ê¸°ë³¸)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Load pod targets (ENV â†’ File â†’ Default)
      vars:
        env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"   # í™˜ê²½ë³€ìˆ˜ TARGET_PODS ì½ê¸°
      block:
        # 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ëŒ€ìƒ ì§€ì •
        - name: Load from ENV
          when: env_target_pods | length > 0                 # TARGET_PODSê°€ ì§€ì •ëœ ê²½ìš°ë§Œ ì‹¤í–‰
          ansible.builtin.set_fact:
            target_pods_effective: "{{ env_target_pods.split(',') | map('trim') | list }}"  # ì‰¼í‘œ ê¸°ì¤€ ë¶„ë¦¬ í›„ listí™”
          changed_when: false

        # 2ï¸âƒ£ pod_kill_targets.yml íŒŒì¼ fallback
        - name: Load from pod_kill_targets.yml
          when:
            - env_target_pods | length == 0                  # í™˜ê²½ë³€ìˆ˜ ë¯¸ì§€ì • ì‹œ
          block:
            - ansible.builtin.stat:                          # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                path: "{{ playbook_dir }}/../../pod_kill_targets.yml"
              register: pod_target_file

            - ansible.builtin.include_vars:                  # íŒŒì¼ì´ ìˆìœ¼ë©´ include
                file: "{{ playbook_dir }}/../../pod_kill_targets.yml"
                name: pod_targets_fallback
              when: pod_target_file.stat.exists

            - ansible.builtin.set_fact:                      # pod_targets ë³€ìˆ˜ ì ìš©
                target_pods_effective: "{{ pod_targets_fallback.pod_targets | default([]) }}"
              changed_when: false

        # 3ï¸âƒ£ ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”
        - name: Default empty list
          when: target_pods_effective is not defined
          ansible.builtin.set_fact:
            target_pods_effective: []                        # ê¸°ë³¸ ë¹ˆ ë¦¬ìŠ¤íŠ¸
          changed_when: false

    # 4ï¸âƒ£ ê²°ê³¼ í™•ì¸ ì¶œë ¥
    - name: Display effective target list
      ansible.builtin.debug:
        msg: |
          ğŸ¯ Pod Kill Targets:
          - ENV: {{ env_target_pods | default('N/A') }}                         # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ì€ ëŒ€ìƒ
          - File: {{ pod_targets_fallback.pod_targets | default([]) }}           # íŒŒì¼ì—ì„œ ì½ì€ ëŒ€ìƒ
          - Effective: {{ target_pods_effective | default([]) }}                 # ìµœì¢… ì ìš©ëœ ë¦¬ìŠ¤íŠ¸

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ ìë™ë³µêµ¬ ì°¨ë‹¨ (ì˜µì…˜)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Disable ReplicaSet recovery
      when: disable_autorecover_local and (target_pods_effective | length > 0)   # ì˜µì…˜ trueì¼ ê²½ìš°ë§Œ ì‹¤í–‰
      ansible.builtin.shell: |
        echo "[INFO] Disabling ReplicaSets..."
        for svc in {{ target_pods_effective | join(' ') | default('') }}; do
          kubectl scale deploy -n {{ target_namespace }} -l app=$svc --replicas=0 || true  # Deployment ë³µêµ¬ ì°¨ë‹¨
        done
      ignore_errors: yes                    # ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ (ì•ˆì „í•œ ì‹¤í–‰)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Internal Kill Mode (Pod ì§ì ‘ ì‚­ì œ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete pods internally
      when: pod_kill_mode == "internal"     # internal ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
      ansible.builtin.shell: |
        set -e                                               # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
        if [ {{ target_pods_effective | length }} -eq 0 ]; then
          echo "[RANDOM] Selecting random pods..."
          PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ kill_count_local }})
        else
          PODS=$(for svc in {{ target_pods_effective | join(' ') | default('') }}; do kubectl get pod -n {{ target_namespace }} -l app=$svc -o name; done)
        fi

        if [ -z "$PODS" ]; then                             # ì„ íƒëœ Podì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
          echo "[WARN] No pods found to delete"
          exit 0
        fi

        if [ "{{ execution_mode }}" = "parallel" ]; then     # ë³‘ë ¬ ì‹¤í–‰ ëª¨ë“œ
          for p in $PODS; do
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force &  # ë°±ê·¸ë¼ìš´ë“œ ì‚­ì œ
          done
          wait                                               # ëª¨ë“  ì‚­ì œ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
        else
          for p in $PODS; do                                 # ìˆœì°¨ ì‹¤í–‰ ëª¨ë“œ
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force
            sleep {{ recovery_wait }}                        # ê° ì‚­ì œ ì‚¬ì´ ëŒ€ê¸°
          done
        fi
      register: internal_kill_result
      ignore_errors: yes                                     # ì‚­ì œ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì†
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Internal ì‹¤íŒ¨ ì‹œ External ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Switch to external mode on failure
      when: pod_kill_mode == "internal" and (internal_kill_result.rc is defined and internal_kill_result.rc != 0)
      ansible.builtin.set_fact:
        pod_kill_mode: "external"             # ì‹¤íŒ¨ ì‹œ External ëª¨ë“œë¡œ ë³€ê²½
      changed_when: true

    - name: Notify fallback
      when: pod_kill_mode == "external"       # ëª¨ë“œ ì „í™˜ ì•ˆë‚´ ë©”ì‹œì§€
      ansible.builtin.debug:
        msg: "âš ï¸ Internal ì‹¤íŒ¨ â†’ External ëª¨ë“œë¡œ ì „í™˜ ì¤‘"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ External Mode (Chaos Podì„ í†µí•œ ì‚­ì œ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Launch chaos pods for deletion
      when: pod_kill_mode == "external"       # External ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
      ansible.builtin.shell: |
        for svc in {{ target_pods_effective | join(' ') | default('') }}; do
          echo "[EXTERNAL] Launching chaos pod for $svc..."
          kubectl run kill-chaos-$svc \
            --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "kill-chaos",
                  "image": "nicolaka/netshoot:latest",
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "echo \"[CHAOS] Deleting pods for \$svc...\"; \
                     kubectl delete pod -n {{ target_namespace }} -l app=\$svc --grace-period=0 --force || true; \
                     sleep {{ recovery_wait }}; \
                     echo \"[DONE] Chaos complete for \$svc.\";"
                  ]
                }]
              }
            }' || true
        done
      register: external_kill_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ê²°ê³¼ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check pod states
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      ignore_errors: yes                     # Pod ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ê³„ì†

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ Chaos ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Append chaos summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_local }}"   # Chaos ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
        create: true                         # ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        line: |
          [{{ ansible_date_time.iso8601 }}] PodKill ns={{ target_namespace }} mode={{ pod_kill_mode }} exec={{ execution_mode }} targets={{ target_pods_effective | join(',') | default('ëœë¤') }} result="{{ pod_state.stdout | default('') | replace('\n','; ') }}"
      become: true                           # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ ì‘ì„±

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Pod Kill Chaos ì™„ë£Œ
          - Mode: {{ pod_kill_mode }}                                # ìµœì¢… ëª¨ë“œ ì¶œë ¥
          - Execution: {{ execution_mode }}                          # ì‹¤í–‰ ë°©ì‹ ì¶œë ¥
          - Targets: {{ target_pods_effective | join(', ') | default('ëœë¤ ì„ íƒ') }}  # ì‹¤ì œ ì‚­ì œ ëŒ€ìƒ
          - Log: {{ chaos_log_path_local }}                          # ë¡œê·¸ ìœ„ì¹˜

