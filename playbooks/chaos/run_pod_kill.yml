# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_pod_kill.yml
# ëª©ì :
#   - app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì˜ì˜ Pod ì—¬ëŸ¬ ê°œë¥¼ ë¬´ì‘ìœ„ë¡œ ì‚­ì œ
#   - íŠ¹ì • íŒŒë“œ(target_pod_names_local) ì§€ì • ì‹œ í•´ë‹¹ íŒŒë“œë§Œ ì‚­ì œ
#   - Chaos Monkey ìŠ¤íƒ€ì¼ ì‹¤í—˜ ìˆ˜í–‰
#   - ì‚­ì œ ê²°ê³¼ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ê³  ìƒíƒœ í™•ì¸ ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, kill_count_local, chaos_log_path_local, recovery_wait, target_pod_names_local
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ§¨ Run Random Pod Kill Chaos
  hosts: k3s_master
  become: yes

  vars:
    target_namespace: "app"                       # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    kill_count_local: 2                           # ì‚­ì œí•  íŒŒë“œ ê°œìˆ˜
    recovery_wait: 10                             # ë³µêµ¬ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    chaos_log_path_local: "/var/log/chaos_test.log"
    target_pod_names_local: []                    # íŠ¹ì • íŒŒë“œ ì§€ì • ì—†ìœ¼ë©´ ëœë¤ ì„ íƒ

  tasks:
    # Step 1ï¸âƒ£: ì•ˆì „ì¥ì¹˜ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    - name: ğŸ§© Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # Step 2ï¸âƒ£: Chaos ì„¤ì • ì¶œë ¥
    - name: ğŸ” Print chaos configuration
      ansible.builtin.debug:
        msg: |
          ğŸ§¨ Random Pod Kill Chaos ì‹œì‘
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ì‚­ì œ ê°œìˆ˜: {{ kill_count_local }}
          - ì§€ì •ëœ íƒ€ê²Ÿ íŒŒë“œ: {{ target_pod_names_local | join(', ') if target_pod_names_local | length > 0 else 'ì—†ìŒ (ëœë¤ ì„ íƒ)' }}
          - ë¡œê·¸ ê²½ë¡œ: {{ chaos_log_path_local }}
          - ë³µêµ¬ ëŒ€ê¸° ì‹œê°„: {{ recovery_wait }}ì´ˆ

    # Step 3ï¸âƒ£: chaos_pod ë¡¤ ì‹¤í–‰
    - name: âš™ï¸ Execute chaos_pod role
      ansible.builtin.include_role:
        name: chaos_pod
      vars:
        target_namespace: "{{ target_namespace }}"
        kill_count_from_playbook: "{{ kill_count_local }}"
        chaos_log_path: "{{ chaos_log_path_local }}"
        target_pod_names: "{{ target_pod_names_local }}"
      ignore_errors: yes
      register: pod_kill_result

    # Step 4ï¸âƒ£: ë³µêµ¬ ëŒ€ê¸°
    - name: â³ Wait before verifying pod recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 5ï¸âƒ£: í˜„ì¬ íŒŒë“œ ìƒíƒœ í™•ì¸
    - name: ğŸ” Verify current pod state
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      changed_when: false
      ignore_errors: yes

    # Step 6ï¸âƒ£: ê²°ê³¼ ì¶œë ¥
    - name: ğŸ§¾ Print pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Random Pod Kill Chaos ê²°ê³¼
          {{ pod_state.stdout | default('âš ï¸ Pod ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # Step 7ï¸âƒ£: ë¡œê·¸ íŒŒì¼ì— ê²°ê³¼ ê¸°ë¡
    - name: ğŸªµ Write chaos summary to log file
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_local }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] PodKill: ns={{ target_namespace }} killed={{ kill_count_local }} targets={{ target_pod_names_local | join(', ') if target_pod_names_local | length > 0 else 'ëœë¤' }} result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true
      when: pod_state is defined

