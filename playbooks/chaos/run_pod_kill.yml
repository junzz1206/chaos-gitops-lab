# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_pod_kill.yml
# ëª©ì :
<<<<<<< Updated upstream
#   - app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì˜ì˜ Pod ì—¬ëŸ¬ ê°œë¥¼ ë¬´ì‘ìœ„ë¡œ ì‚­ì œ
#   - íŠ¹ì • íŒŒë“œ(target_pod_names_local) ì§€ì • ì‹œ í•´ë‹¹ íŒŒë“œë§Œ ì‚­ì œ
#   - Chaos Monkey ìŠ¤íƒ€ì¼ ì‹¤í—˜ ìˆ˜í–‰
#   - ì‚­ì œ ê²°ê³¼ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ê³  ìƒíƒœ í™•ì¸ ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, kill_count_local, chaos_log_path_local, recovery_wait, target_pod_names_local
=======
#   - app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ íŠ¹ì • ë˜ëŠ” ë¬´ì‘ìœ„ Pod ì‚­ì œ
#   - ì§€ì •ëœ íŒŒë“œ(target_pod_names_local ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ TARGET_PODS)ë§Œ ì‚­ì œ ê°€ëŠ¥
#   - disable_autorecover_local=true ì‹œ í•´ë‹¹ ì„œë¹„ìŠ¤ ì™„ì „ ì¢…ë£Œ (ë³µêµ¬ ì°¨ë‹¨)
#   - execution_mode ì— ë”°ë¼ ìˆœì°¨ / ë³‘ë ¬ ì‹¤í–‰ ì „í™˜
#   - GitLab / ArgoCD í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„œë¹„ìŠ¤ ì§€ì • ì§€ì›
#   - âœ… ë³‘ë ¬ ëª¨ë“œ ì‹œ async ê¸°ë°˜ ë¹„ë™ê¸° ì‚­ì œ ìˆ˜í–‰
>>>>>>> Stashed changes
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Targeted or Random Pod Kill Chaos
  hosts: k3s_master
  become: yes

  vars:
    target_namespace: "app"                       # Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
<<<<<<< Updated upstream
    kill_count_local: 2                           # ì‚­ì œí•  íŒŒë“œ ê°œìˆ˜
    recovery_wait: 10                             # ë³µêµ¬ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    chaos_log_path_local: "/var/log/chaos_test.log"
    target_pod_names_local: []                    # íŠ¹ì • íŒŒë“œ ì§€ì • ì—†ìœ¼ë©´ ëœë¤ ì„ íƒ

  tasks:
    # Step 1ï¸âƒ£: ì•ˆì „ì¥ì¹˜ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    - name: ğŸ§© Validate namespace
=======
    kill_count_local: 2                           # ì‚­ì œí•  íŒŒë“œ ê°œìˆ˜ (ëœë¤ ëª¨ë“œìš©)
    recovery_wait: 60                             # ë³µêµ¬ ëŒ€ê¸° ì‹œê°„(ì´ˆ)
    chaos_log_path_local: "/var/log/chaos_test.log"
    target_pod_names_local: []                    # ì§€ì • íŒŒë“œ ë¦¬ìŠ¤íŠ¸ (ë¹„ì›Œë‘ë©´ ëœë¤)
    disable_autorecover_local: true               # trueë©´ ReplicaSet ìë™ ë³µêµ¬ ì°¨ë‹¨
    execution_mode: "{{ execution_mode | default('sequential') }}"  # ìˆœì°¨/ë³‘ë ¬ ì œì–´

  tasks:
    # Step 1ï¸âƒ£: í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ë™ì  ëŒ€ìƒ íŒŒë“œ ë¡œë“œ
    - name: Resolve target pods from environment variable (TARGET_PODS)
      vars:
        env_target_pods: "{{ lookup('env', 'TARGET_PODS') | default('', true) }}"
      ansible.builtin.set_fact:
        target_pod_names_effective: >-
          {{
            (env_target_pods.split(',') | map('trim') | list)
            if env_target_pods | length > 0
            else (target_pod_names_local | default([]))
          }}
      changed_when: false

    - name: Show resolved target pods
      ansible.builtin.debug:
        msg: |
          ğŸ¯ íŒŒë“œ ëŒ€ìƒ ê²°ì •:
          - ENV(TARGET_PODS): {{ lookup('env', 'TARGET_PODS') | default('N/A') }}
          - Local var: {{ target_pod_names_local | default([]) }}
          - Effective: {{ target_pod_names_effective | default([]) }}

    # Step 2ï¸âƒ£: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì „ê²€ì¦
    - name: Validate target namespace
>>>>>>> Stashed changes
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

<<<<<<< Updated upstream
    # Step 2ï¸âƒ£: Chaos ì„¤ì • ì¶œë ¥
    - name: ğŸ” Print chaos configuration
=======
    # Step 3ï¸âƒ£: ì‹¤í–‰ ì •ë³´ ì¶œë ¥
    - name: Print chaos configuration
>>>>>>> Stashed changes
      ansible.builtin.debug:
        msg: |
          ğŸ§¨ Pod Kill Chaos ì‹œì‘
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
<<<<<<< Updated upstream
          - ì‚­ì œ ê°œìˆ˜: {{ kill_count_local }}
          - ì§€ì •ëœ íƒ€ê²Ÿ íŒŒë“œ: {{ target_pod_names_local | join(', ') if target_pod_names_local | length > 0 else 'ì—†ìŒ (ëœë¤ ì„ íƒ)' }}
          - ë¡œê·¸ ê²½ë¡œ: {{ chaos_log_path_local }}
          - ë³µêµ¬ ëŒ€ê¸° ì‹œê°„: {{ recovery_wait }}ì´ˆ

    # Step 3ï¸âƒ£: chaos_pod ë¡¤ ì‹¤í–‰
    - name: âš™ï¸ Execute chaos_pod role
=======
          - ì‹¤í–‰ ëª¨ë“œ: {{ execution_mode }}
          - ì‚­ì œ ëª¨ë“œ: {{ 'ì§€ì • íŒŒë“œ' if target_pod_names_effective | length > 0 else 'ë¬´ì‘ìœ„' }}
          - ì‚­ì œ ê°œìˆ˜: {{ kill_count_local if target_pod_names_effective | length == 0 else target_pod_names_effective | length }}
          - íƒ€ê²Ÿ íŒŒë“œ: {{ target_pod_names_effective | join(', ') if target_pod_names_effective | length > 0 else 'ì—†ìŒ (ëœë¤ ì„ íƒ)' }}
          - ë³µêµ¬ ì°¨ë‹¨: {{ disable_autorecover_local }}
          - ë³µêµ¬ ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ

    # Step 4ï¸âƒ£: ìë™ ë³µêµ¬ ì°¨ë‹¨ ëª¨ë“œ (Deployment, RS, StatefulSet 0ìœ¼ë¡œ)
    - name: Disable auto recovery for targeted services
      when:
        - disable_autorecover_local | default(false)
        - target_pod_names_effective | length > 0
      ansible.builtin.shell: |
        echo "ğŸ›‘ Disabling auto recovery for: {{ target_pod_names_effective | join(', ') }}"
        for svc in {{ target_pod_names_effective | join(' ') }}; do
          kubectl scale deploy -n {{ target_namespace }} -l app=$svc --replicas=0 || true
          kubectl scale rs -n {{ target_namespace }} -l app=$svc --replicas=0 || true
          kubectl scale statefulset -n {{ target_namespace }} -l app=$svc --replicas=0 || true
        done
      changed_when: true
      ignore_errors: yes

    # Step 5ï¸âƒ£: ì‹¤í–‰ ëª¨ë“œ ë¶„ê¸° (ìˆœì°¨ or ë³‘ë ¬)
    - name: Run chaos sequentially
      when: execution_mode == "sequential"
      ansible.builtin.shell: |
        echo "ğŸ§© [ìˆœì°¨ ëª¨ë“œ] ê° ì„œë¹„ìŠ¤ë¥¼ ìˆœì„œëŒ€ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤."
        for svc in {{ target_pod_names_effective | join(' ') }}; do
          echo "==> [ìˆœì°¨ ì£¼ì…] ëŒ€ìƒ: $svc"
          kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true
          echo "Waiting {{ recovery_wait }} seconds before next service..."
          sleep {{ recovery_wait }}
        done
        echo "[âœ”] Sequential Chaos Completed."
      register: sequential_result
      ignore_errors: yes
      changed_when: true

    - name: Run chaos in parallel (async mode)
      when: execution_mode == "parallel"
      ansible.builtin.shell: |
        echo "âš¡ [ë³‘ë ¬ ëª¨ë“œ] ëª¨ë“  ëŒ€ìƒ ì„œë¹„ìŠ¤ë¥¼ ë™ì‹œì— ì¢…ë£Œí•©ë‹ˆë‹¤."
        for svc in {{ target_pod_names_effective | join(' ') }}; do
          echo "Launching background delete for $svc ..."
          kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force &
        done
        wait
        echo "[âœ”] Parallel Chaos Completed."
      async: 45
      poll: 0
      register: parallel_job
      ignore_errors: yes
      changed_when: true

    - name: Monitor async pod kill job completion
      when: execution_mode == "parallel"
      ansible.builtin.async_status:
        jid: "{{ parallel_job.ansible_job_id }}"
      register: parallel_status
      until: parallel_status.finished
      retries: 20
      delay: 5
      ignore_errors: yes
      changed_when: false

    # Step 6ï¸âƒ£: Chaos Pod Role ì‹¤í–‰ (ëœë¤ ëª¨ë“œ)
    - name: Execute chaos_pod role
>>>>>>> Stashed changes
      ansible.builtin.include_role:
        name: chaos_pod
      vars:
        target_namespace: "{{ target_namespace }}"
<<<<<<< Updated upstream
        kill_count_from_playbook: "{{ kill_count_local }}"
        chaos_log_path: "{{ chaos_log_path_local }}"
        target_pod_names: "{{ target_pod_names_local }}"
=======
        random_pod_kill_count: "{{ kill_count_local }}"
        chaos_log_path: "{{ chaos_log_path_local }}"
        target_pod_names: "{{ target_pod_names_effective }}"
        disable_autorecover: "{{ disable_autorecover_local }}"
>>>>>>> Stashed changes
      ignore_errors: yes
      register: chaos_exec_result

<<<<<<< Updated upstream
    # Step 4ï¸âƒ£: ë³µêµ¬ ëŒ€ê¸°
    - name: â³ Wait before verifying pod recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 5ï¸âƒ£: í˜„ì¬ íŒŒë“œ ìƒíƒœ í™•ì¸
    - name: ğŸ” Verify current pod state
=======
    # Step 7ï¸âƒ£: ë³µêµ¬ ëŒ€ê¸°
    - name: Wait before verifying pod recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 8ï¸âƒ£: í˜„ì¬ íŒŒë“œ ìƒíƒœ ì¡°íšŒ
    - name: Verify current pod states
>>>>>>> Stashed changes
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      changed_when: false
      ignore_errors: yes

<<<<<<< Updated upstream
    # Step 6ï¸âƒ£: ê²°ê³¼ ì¶œë ¥
    - name: ğŸ§¾ Print pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Random Pod Kill Chaos ê²°ê³¼
          {{ pod_state.stdout | default('âš ï¸ Pod ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # Step 7ï¸âƒ£: ë¡œê·¸ íŒŒì¼ì— ê²°ê³¼ ê¸°ë¡
    - name: ğŸªµ Write chaos summary to log file
=======
    # Step 9ï¸âƒ£: ìƒíƒœ ìš”ì•½ ì¶œë ¥
    - name: Print pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Pod Kill Chaos ê²°ê³¼
          {{ pod_state.stdout | default('âš ï¸ íŒŒë“œ ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # Step ğŸ”Ÿ: Chaos ì‹¤í–‰ ë¡œê·¸ ê¸°ë¡
    - name: Write chaos summary to log file
>>>>>>> Stashed changes
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_local }}"
        create: yes
        line: |
<<<<<<< Updated upstream
          [{{ ansible_date_time.iso8601 }}] PodKill: ns={{ target_namespace }} killed={{ kill_count_local }} targets={{ target_pod_names_local | join(', ') if target_pod_names_local | length > 0 else 'ëœë¤' }} result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true
      when: pod_state is defined
=======
          [{{ ansible_date_time.iso8601 }}] PodKill mode={{ execution_mode }} \
          ns={{ target_namespace }} \
          killed={{ target_pod_names_effective | length if target_pod_names_effective | length > 0 else kill_count_local }} \
          targets={{ target_pod_names_effective | join(', ') if target_pod_names_effective | length > 0 else 'ëœë¤' }} \
          result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true
      when: pod_state is defined

    # Step â“«: ìš”ì•½ ì¶œë ¥
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Chaos Pod Kill ì™„ë£Œ
          - ì‹¤í–‰ ëª¨ë“œ: {{ execution_mode }}
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ëŒ€ìƒ: {{ target_pod_names_effective | join(', ') if target_pod_names_effective | length > 0 else 'ëœë¤ ì„ íƒ' }}
          - ë³µêµ¬ ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ
          - ë¡œê·¸ íŒŒì¼: {{ chaos_log_path_local }}
>>>>>>> Stashed changes

