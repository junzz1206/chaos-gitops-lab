# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/run_pod_kill.yml
# ëª©ì :
#   - Pod ì‚­ì œ Chaos (Internal / External ì§€ì›)
#   - CI/CD í™˜ê²½: TARGET_PODS í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì§€ì •
#   - CLI í™˜ê²½: pod_kill_targets.yml fallback
#   - Internal ì‹¤íŒ¨ ì‹œ Externalë¡œ ìë™ ì „í™˜
#   - ë³‘ë ¬ / ìˆœì°¨ ì‹¤í–‰ ì§€ì›
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Run Pod Kill Chaos (Internal / External, Safe Refactor)
  hosts: k3s_master
  become: yes

  vars_files:
   - "{{ playbook_dir }}/../../group_vars/all.yml"

  vars:
    # NOTE: target_namespaceëŠ” group_vars/all.yml ì „ì—­ê°’ ì‚¬ìš© (ì—¬ê¸°ì„œ í•˜ë“œì½”ë”© ê¸ˆì§€)
    env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"

    kill_count_local: "{{ lookup('env','KILL_COUNT') | default(2, true) | int }}"
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(30, true) | int }}"
    chaos_log_path_local: "/var/log/chaos_test.log"
    disable_autorecover_local: "{{ lookup('env','DISABLE_AUTORECOVER') | default(false, true) | bool }}"
    execution_mode: "{{ lookup('env','EXECUTION_MODE') | default('sequential', true) }}"   # sequential / parallel
    pod_kill_mode: "{{ lookup('env','KILL_MODE') | default('internal', true) }}"           # internal / external

    # External ëª¨ë“œìš©
    external_sa_name: "chaos-runner"
    external_kubectl_image: "bitnami/kubectl:latest"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ ì•ˆì „ê²€ì‚¬ - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Safety Check - namespace
      ansible.builtin.assert:
        that: target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ('app')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ëŒ€ìƒ Pod ëª©ë¡ ë¡œë“œ (ENV â†’ File â†’ Default)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Load pod targets (ENV â†’ File â†’ Default)
      block:
        # âœ… (Aì•ˆ) pod_targets_fallback ê¸°ë³¸ dict ì„ ìƒì„± (íŒŒì¼ ì—†ì–´ë„ ì•ˆì „)
        - name: Init fallback dict
          ansible.builtin.set_fact:
            pod_targets_fallback:
              pod_targets: []
          changed_when: false

        # 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ëŒ€ìƒ ì§€ì •
        - name: Load from ENV
          when: env_target_pods | length > 0
          ansible.builtin.set_fact:
            target_pods_effective: "{{ env_target_pods.split(',') | map('trim') | list }}"
          changed_when: false

        # 2ï¸âƒ£ pod_kill_targets.yml íŒŒì¼ fallback
        - name: Load from pod_kill_targets.yml
          when: env_target_pods | length == 0
          block:
            - name: Check pod_kill_targets.yml exists
              ansible.builtin.stat:
                path: "{{ playbook_dir }}/../../pod_kill_targets.yml"
              register: pod_target_file

            - name: Include pod_kill_targets.yml
              ansible.builtin.include_vars:
                file: "{{ playbook_dir }}/../../pod_kill_targets.yml"
                name: pod_targets_fallback
              when: pod_target_file.stat.exists

            - name: Apply fallback list
              ansible.builtin.set_fact:
                target_pods_effective: "{{ pod_targets_fallback.pod_targets | default([]) }}"
              changed_when: false

        # 3ï¸âƒ£ ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸
        - name: Default empty list
          when: target_pods_effective is not defined
          ansible.builtin.set_fact:
            target_pods_effective: []
          changed_when: false

    - name: Display effective target list
      ansible.builtin.debug:
        msg: |
          ğŸ¯ Pod Kill Targets:
          - ENV: {{ env_target_pods | default('N/A') }}
          - File: {{ pod_targets_fallback.pod_targets | default([]) }}
          - Effective: {{ target_pods_effective | default([]) }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ ìë™ë³µêµ¬ ì°¨ë‹¨ (ì˜µì…˜)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Disable ReplicaSet recovery
      when: disable_autorecover_local and (target_pods_effective | length > 0)
      ansible.builtin.shell: |
        echo "[INFO] Disabling ReplicaSets..."
        for svc in {{ target_pods_effective | join(' ') | default('') }}; do
          kubectl scale deploy -n {{ target_namespace }} -l app=$svc --replicas=0 || true
        done
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Internal Kill Mode (Pod ì§ì ‘ ì‚­ì œ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete pods internally
      when: pod_kill_mode == "internal"
      ansible.builtin.shell: |
        set -e
        if [ {{ target_pods_effective | length }} -eq 0 ]; then
          echo "[RANDOM] Selecting random pods..."
          PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ kill_count_local }})
        else
          PODS=$(for svc in {{ target_pods_effective | join(' ') | default('') }}; do kubectl get pod -n {{ target_namespace }} -l app=$svc -o name; done)
        fi

        if [ -z "$PODS" ]; then
          echo "[WARN] No pods found to delete"
          exit 0
        fi

        if [ "{{ execution_mode }}" = "parallel" ]; then
          for p in $PODS; do
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force &
          done
          wait
        else
          for p in $PODS; do
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force
            sleep {{ recovery_wait }}
          done
        fi
      register: internal_kill_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Internal ì‹¤íŒ¨ ì‹œ External ì „í™˜
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Switch to external mode on failure
      when: pod_kill_mode == "internal" and (internal_kill_result.rc is defined and internal_kill_result.rc != 0)
      ansible.builtin.set_fact:
        pod_kill_mode: "external"
      changed_when: true

    - name: Notify fallback
      when: pod_kill_mode == "external"
      ansible.builtin.debug:
        msg: "âš ï¸ Internal ì‹¤íŒ¨ â†’ External ëª¨ë“œë¡œ ì „í™˜ ì¤‘"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ External Mode ì¤€ë¹„: RBAC(ServiceAccount/Role/RoleBinding)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Ensure RBAC for external chaos runner
      when: pod_kill_mode == "external"
      ansible.builtin.shell: |
        cat <<'YAML' | kubectl apply -f -
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: {{ external_sa_name }}
          namespace: {{ target_namespace }}
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: Role
        metadata:
          name: chaos-pod-deleter
          namespace: {{ target_namespace }}
        rules:
          - apiGroups: [""]
            resources: ["pods"]
            verbs: ["get","list","delete"]
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        metadata:
          name: chaos-pod-deleter-binding
          namespace: {{ target_namespace }}
        subjects:
          - kind: ServiceAccount
            name: {{ external_sa_name }}
            namespace: {{ target_namespace }}
        roleRef:
          kind: Role
          name: chaos-pod-deleter
          apiGroup: rbac.authorization.k8s.io
        YAML
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ External Mode (Chaos Podì„ í†µí•œ ì‚­ì œ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Launch chaos pods for deletion
      when: pod_kill_mode == "external"
      ansible.builtin.shell: |
        for svc in {{ target_pods_effective | join(' ') | default('') }}; do
          echo "[EXTERNAL] Launching chaos pod for $svc..."
          kubectl run kill-chaos-$svc \
            --image={{ external_kubectl_image }} --restart=Never -n {{ target_namespace }} \
            --serviceaccount={{ external_sa_name }} \
            --env="SVC=$svc" \
            --overrides='{
              "spec": {
                "containers": [{
                  "name": "kill-chaos",
                  "image": "{{ external_kubectl_image }}",
                  "command": ["/bin/sh","-c"],
                  "args": [
                    "echo \"[CHAOS] Deleting pods for $SVC...\"; \
                     kubectl delete pod -n {{ target_namespace }} -l app=$SVC --grace-period=0 --force || true; \
                     sleep {{ recovery_wait }}; \
                     echo \"[DONE] Chaos complete for $SVC.\";"
                  ]
                }]
              }
            }' || true
        done
      register: external_kill_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ê²°ê³¼ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check pod states
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      ignore_errors: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ Chaos ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Append chaos summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path_local }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] PodKill ns={{ target_namespace }} mode={{ pod_kill_mode }} exec={{ execution_mode }} targets={{ target_pods_effective | join(',') | default('ëœë¤') }} result="{{ pod_state.stdout | default('') | replace('\n','; ') }}"
      become: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9ï¸âƒ£ ìµœì¢… ìš”ì•½ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final summary
      ansible.builtin.debug:
        msg: |
          âœ… Pod Kill Chaos ì™„ë£Œ
          - Mode: {{ pod_kill_mode }}
          - Execution: {{ execution_mode }}
          - Targets: {{ target_pods_effective | join(', ') | default('ëœë¤ ì„ íƒ') }}
          - Log: {{ chaos_log_path_local }}

