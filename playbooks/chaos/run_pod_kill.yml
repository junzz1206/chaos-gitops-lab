# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_pod_kill.yml
# ëª©ì :
#   - app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ì„ì˜ì˜ Pod ì—¬ëŸ¬ ê°œë¥¼ ë¬´ì‘ìœ„ë¡œ ì‚­ì œ
#   - Chaos Monkey ìŠ¤íƒ€ì¼ ì‹¤í—˜ ìˆ˜í–‰
#   - ì‚­ì œ ê²°ê³¼ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ê³  ìƒíƒœ í™•ì¸ ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, random_pod_kill_count, chaos_log_path, recovery_wait
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ§¨ Run Random Pod Kill Chaos
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"
    random_pod_kill_count: "{{ random_pod_kill_count | default(2) }}"
    recovery_wait: 10
    chaos_log_path: "/var/log/chaos_test.log"

  tasks:
    # Step 1ï¸âƒ£: Safety Check
    - name: ğŸ§© Validate namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # Step 2ï¸âƒ£: Display test parameters
    - name: ğŸ§¾ Print chaos configuration
      ansible.builtin.debug:
        msg: |
          ğŸ§¨ Random Pod Kill Chaos ì‹œì‘
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ë¬´ì‘ìœ„ ì‚­ì œ ê°œìˆ˜: {{ random_pod_kill_count }}

    # Step 3ï¸âƒ£: Execute Pod Kill Role
    - name: ğŸ’€ Execute chaos_pod role
      ansible.builtin.include_role:
        name: chaos_pod
      ignore_errors: yes
      register: pod_kill_result

    # Step 4ï¸âƒ£: Wait for stabilization
    - name: â³ Wait before verifying pod recovery
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"

    # Step 5ï¸âƒ£: Verify pod status
    - name: ğŸ” Verify current pod state
      ansible.builtin.shell: |
        kubectl get pods -n {{ target_namespace }} -o custom-columns="NAME:.metadata.name,STATUS:.status.phase" --no-headers
      register: pod_state
      changed_when: false
      ignore_errors: yes

    # Step 6ï¸âƒ£: Display results
    - name: ğŸ§¾ Print pod state summary
      ansible.builtin.debug:
        msg: |
          âœ… Random Pod Kill Chaos ê²°ê³¼
          {{ pod_state.stdout | default('Pod ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') }}

    # Step 7ï¸âƒ£: Log chaos result
    - name: ğŸª¶ Write chaos summary to log file
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] PodKill: ns={{ target_namespace }} killed={{ random_pod_kill_count }} result="{{ pod_state.stdout | replace('\n','; ') }}"
      become: true

