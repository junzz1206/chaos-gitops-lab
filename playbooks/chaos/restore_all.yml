# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼ëª…: playbooks/chaos/restore_all.yml  # íŒŒì¼ ê²½ë¡œ
# ëª©ì :
#   - CPU / Network chaos ë¶€í•˜ ì™„ì „ ë³µêµ¬
#   - ì„ì‹œ Chaos Pod ë° ë¦¬ì†ŒìŠ¤ ì •ë¦¬
#   - scale 0 â†’ 1 ë³µì›, Ready ë¶ˆì¼ì¹˜ ìë™ ìˆ˜ì •
#   - Redis â†” Cartservice ì˜ì¡´ì„± ìë™ ì¬ì •ë ¬
#   - âœ… GitLab / ArgoCD / Jenkins ë“± CI/CD í™˜ê²½ ì™„ì „ í˜¸í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Perform Unified Chaos Recovery (CI/CD Compatible)  # í”Œë ˆì´ ì´ë¦„
  hosts: k3s_master  # íƒ€ê²Ÿ í˜¸ìŠ¤íŠ¸
  become: yes  # ë£¨íŠ¸ ê¶Œí•œ í•„ìš”

  vars:  # í™˜ê²½ ë³€ìˆ˜ ë° ê¸°ë³¸ê°’ ì •ì˜
    target_namespace: "{{ lookup('env','TARGET_NAMESPACE') | default('app', true) }}"  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_log_path: "{{ lookup('env','CHAOS_LOG_PATH') | default('/var/log/chaos_test.log', true) }}"  # ë¡œê·¸ ê²½ë¡œ
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(15, true) | int }}"  # ë³µêµ¬ ëŒ€ê¸°ì‹œê°„
    recovery_targets: >-  # ë³µêµ¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡
      {{ lookup('env','RECOVERY_TARGETS') |
         default('cartservice,checkoutservice,paymentservice,redis-cart,currencyservice,shippingservice,frontend,emailservice,productcatalogservice,recommendationservice', true)
         .split(',') }}  # ì‰¼í‘œ êµ¬ë¶„ í›„ ë¦¬ìŠ¤íŠ¸ ë³€í™˜

  tasks:  # ì‘ì—… ëª©ë¡ ì‹œì‘

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 0ï¸âƒ£ CPU / Network Chaos ë³µì›
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Restore CPU and network chaos (internal + external)  # Chaos ë³µì› ë¸”ë¡
      block:  # ë¸”ë¡ ì‹œì‘
        - ansible.builtin.shell: |  # ì…¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "[CLEANUP] Restoring CPU and network chaos effects..."  # ë¡œê·¸ ì¶œë ¥

            # ë…¸ë“œ ë‹¨ìœ„ ë³µì›
            echo "[NODE] Cleaning tc qdisc & killing stress-ng on nodes..."  # ë…¸ë“œ ë ˆë²¨ ë³µì› ì•ˆë‚´
            kubectl run chaos-cleaner --image=alpine:3.19 --restart=Never -n {{ target_namespace }} --overrides='{  # cleanup pod ì‹¤í–‰
              "metadata": {
                "labels": {
                  "app": "chaos-cleaner",
                  "app.kubernetes.io/name": "chaos-cleaner",
                  "app.kubernetes.io/part-of": "online-boutique-chaos-lab",
                  "app.kubernetes.io/component": "recovery",
                  "app.kubernetes.io/tier": "backend"
                }
              },
              "spec": {
                "hostPID": true,
                "containers": [{
                  "name": "cleanup",
                  "image": "alpine:3.19",
                  "securityContext": { "privileged": true },
                  "command": ["sh","-c",
                    "apk add --no-cache iproute2 procps >/dev/null; \
                     tc qdisc del dev eth0 root 2>/dev/null || true; \
                     pkill stress-ng 2>/dev/null || true; \
                     echo [OK] Node-level cleanup done.; \
                     kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true"]
                }]
              }
            }' || true  # ì‹¤íŒ¨ ë¬´ì‹œ

            # Pod ë‚´ë¶€ ë³µì›
            echo "[POD] Cleaning tc & stress-ng inside pods..."  # Pod ë‚´ë¶€ ë³µì› ì‹œì‘
            PODS=$(kubectl get pods -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}')  # ëª¨ë“  Pod ëª©ë¡ ì¶”ì¶œ
            for POD in $PODS; do  # Pod ë°˜ë³µ
              kubectl exec -n {{ target_namespace }} $POD -- sh -c "  # ë‚´ë¶€ ëª…ë ¹ ì‹¤í–‰
                if command -v tc >/dev/null 2>&1; then tc qdisc del dev eth0 root 2>/dev/null || true; fi;  # ë„¤íŠ¸ì›Œí¬ ë³µì›
                if command -v pkill >/dev/null 2>&1; then pkill stress-ng 2>/dev/null || true; fi;  # CPU ë¶€í•˜ ì¢…ë£Œ
              " || true
            done  # ë°˜ë³µ ì¢…ë£Œ

            echo "[DONE] CPU/Network chaos recovery completed."  # ì™„ë£Œ ë¡œê·¸ ì¶œë ¥
          register: cleanup_result  # ê²°ê³¼ ì €ì¥
          ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
          changed_when: true  # ë³€ê²½ ë°œìƒìœ¼ë¡œ ê°„ì£¼

      rescue:  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ë¦¬
        - name: Handle manual cancellation during CI/CD  # ìˆ˜ë™ ì¤‘ë‹¨ ì²˜ë¦¬
          ansible.builtin.debug:
            msg: "ğŸ›‘ CI/CD manual stop detected â€” Recovery aborted safely."  # ì¤‘ë‹¨ ì•ˆë‚´ ë©”ì‹œì§€

        - name: Log abort state  # ì¤‘ë‹¨ ìƒíƒœ ë¡œê·¸ ê¸°ë¡
          ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"  # ë¡œê·¸ ê²½ë¡œ
            create: yes  # ì—†ìœ¼ë©´ ìƒì„±
            line: "[{{ ansible_date_time.iso8601 }}] Recovery aborted manually (CI/CD stop)"  # ë¡œê·¸ ì‘ì„±
          become: yes  # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ê¸°ë¡
          failed_when: false  # rescue ë‚´ ì˜¤ë¥˜ ë°©ì§€

        - ansible.builtin.meta: end_play  # ì´í›„ task ì¤‘ë‹¨

    - name: Show cleanup summary  # ë³µì› ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: cleanup_result.stdout_lines  # ì…¸ ì¶œë ¥ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ Chaos ê´€ë ¨ ì„ì‹œ Pod ì •ë¦¬
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete leftover chaos pods  # ë‚¨ì€ chaos pod ì‚­ì œ
      ansible.builtin.shell: |
        CHAOS_PODS=$(kubectl get pods -n {{ target_namespace }} -o name | grep -E '^pod/(cpu|net|network|svc|chaos)-' || true)  # chaos ê´€ë ¨ íŒ¨í„´ ê²€ìƒ‰
        if [ -n "$CHAOS_PODS" ]; then  # ì¡´ì¬í•˜ë©´
          echo "[CLEANUP] Removing chaos pods..."  # ë¡œê·¸ ì¶œë ¥
          for p in $CHAOS_PODS; do  # ë°˜ë³µ
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force || true  # ê°•ì œ ì‚­ì œ
          done
        else
          echo "[INFO] No chaos pods found."  # ì—†ì„ ê²½ìš° ë¡œê·¸
        fi
      register: pod_cleanup  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true  # ë³€ê²½ ë°œìƒìœ¼ë¡œ ê°„ì£¼

    - name: Show chaos pod cleanup result  # chaos pod ì •ë¦¬ ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: pod_cleanup.stdout_lines  # ê²°ê³¼ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ Namespace ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate target namespace  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
      ansible.builtin.assert:
        that:
          - target_namespace == "app"  # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ë³µêµ¬ëŠ” app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ìˆ˜í–‰ë©ë‹ˆë‹¤."  # ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"  # ì„±ê³µ ë©”ì‹œì§€

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ scale 0 â†’ 1 ë³µì›
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Restore deployments scaled to zero  # 0ìœ¼ë¡œ ì¤„ì–´ë“  Deployment ë³µì›
      ansible.builtin.shell: |
        for svc in {{ recovery_targets | join(' ') }}; do  # ì„œë¹„ìŠ¤ ë°˜ë³µ
          if kubectl get deploy $svc -n {{ target_namespace }} >/dev/null 2>&1; then  # ì¡´ì¬ í™•ì¸
            replicas=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "")
            if [ "$replicas" = "0" ]; then  # replicas=0ì´ë©´
              echo "[RESTORE] Scaling $svc from 0 â†’ 1"  # ë¡œê·¸ ì¶œë ¥
              kubectl scale deploy $svc -n {{ target_namespace }} --replicas=1 || true  # ë³µì›
            fi
          fi
        done
      register: scale_restore  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true  # ë³€ê²½ ë°œìƒ

    - name: Show scale restore output  # ìŠ¤ì¼€ì¼ ë³µì› ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: scale_restore.stdout_lines  # ì¶œë ¥ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ ëˆ„ë½ Deployment ì¬ë°°í¬
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Redeploy missing services  # ëˆ„ë½ëœ ì„œë¹„ìŠ¤ ì¬ë°°í¬
      ansible.builtin.shell: |
        for svc in {{ recovery_targets | join(' ') }}; do  # ë°˜ë³µ
          if ! kubectl get deploy $svc -n {{ target_namespace }} >/dev/null 2>&1; then  # ë°°í¬ ì¡´ì¬ í™•ì¸
            if [ -f "{{ playbook_dir }}/../app/$svc.yaml" ]; then  # yaml ì¡´ì¬ í™•ì¸
              echo "[AUTO-DEPLOY] Recreating missing $svc"  # ë¡œê·¸ ì¶œë ¥
              kubectl apply -f {{ playbook_dir }}/../app/$svc.yaml || true  # ì¬ë°°í¬
            fi
          fi
        done
      register: redeploy_result  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true  # ë³€ê²½ ê°ì§€

    - name: Show redeploy actions  # ì¬ë°°í¬ ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: redeploy_result.stdout_lines  # ì¶œë ¥ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Ready â‰  Desired â†’ Rollout ì¬ì‹œì‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Restart unready deployments  # Ready ìƒíƒœ ë¶ˆì¼ì¹˜ ì‹œ ë¡¤ì•„ì›ƒ ì¬ì‹œì‘
      ansible.builtin.shell: |
        for svc in {{ recovery_targets | join(' ') }}; do  # ë°˜ë³µ
          desired=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
          ready=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          if [ "$desired" != "$ready" ]; then  # ë¶ˆì¼ì¹˜ ì‹œ
            echo "[ROLLBACK] Restarting $svc (Desired=$desired, Ready=$ready)"  # ë¡œê·¸ ì¶œë ¥
            kubectl rollout restart deploy $svc -n {{ target_namespace }} || true  # ì¬ì‹œì‘ ìˆ˜í–‰
          fi
        done
      register: restart_unready  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true  # ë³€ê²½ ë°œìƒìœ¼ë¡œ ê°„ì£¼

    - name: Show restart actions  # ì¬ì‹œì‘ ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: restart_unready.stdout_lines  # ì¶œë ¥ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ redis-cart â†” cartservice ì˜ì¡´ì„± ì •ë ¬
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Re-sync cartservice after redis-cart ready  # ì˜ì¡´ì„± ë³µêµ¬
      ansible.builtin.shell: |
        kubectl rollout status deploy/redis-cart -n {{ target_namespace }} --timeout=180s || true  # Redis ì•ˆì •í™” ëŒ€ê¸°
        kubectl rollout restart deploy/cartservice -n {{ target_namespace }} || true  # Cartservice ì¬ì‹œì‘
      register: cart_sync  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: true  # ë³€ê²½ ê°ì§€

    - name: Show cartservice sync result  # ë™ê¸°í™” ê²°ê³¼ ì¶œë ¥
      ansible.builtin.debug:
        var: cart_sync.stdout_lines  # ì¶œë ¥ í‘œì‹œ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ ì•ˆì •í™” ëŒ€ê¸° ë° ìµœì¢… ìƒíƒœ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Wait for recovery stabilization  # ë³µêµ¬ ì•ˆì •í™” ëŒ€ê¸°
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"  # ì§€ì •ëœ ì‹œê°„ ëŒ€ê¸°

    - name: Get final deployment status  # ìµœì¢… ë°°í¬ ìƒíƒœ í™•ì¸
      ansible.builtin.shell: |
        kubectl get deployments -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,READY:.status.readyReplicas,DESIRED:.spec.replicas" --no-headers
      register: final_status  # ê²°ê³¼ ì €ì¥
      ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
      changed_when: false  # ë³€ê²½ ì—†ìŒ

    - name: Show final deployment summary  # ìµœì¢… ìƒíƒœ ìš”ì•½ ì¶œë ¥
      ansible.builtin.debug:
        msg: |
          âœ… ìµœì¢… ë³µêµ¬ ìƒíƒœ
          {{ final_status.stdout | default('ì •ë³´ ì—†ìŒ') }}  # ìµœì¢… ì¶œë ¥

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ ë¡œê·¸ ê¸°ë¡ ë° ìš”ì•½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write recovery summary to log  # ë³µêµ¬ ê²°ê³¼ ë¡œê·¸ ê¸°ë¡
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path | default('/tmp/chaos_test.log') }}"  # ë¡œê·¸ ê²½ë¡œ (fallback í¬í•¨)
        create: yes  # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
        line: |
          [{{ ansible_date_time.iso8601 }}] Recovery ns={{ target_namespace }} result="{{ final_status.stdout | replace('\n','; ') }}"  # ë¡œê·¸ ì‘ì„±
      become: yes  # ë£¨íŠ¸ ê¶Œí•œ í•„ìš”

    - name: Final recovery summary  # ìµœì¢… ìš”ì•½ ì¶œë ¥
      ansible.builtin.debug:
        msg: |
          âœ… Chaos Recovery Completed Successfully  # ì™„ë£Œ ë©”ì‹œì§€
          - Namespace: {{ target_namespace }}  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‘œì‹œ
          - Recovered Services: {{ recovery_targets | join(', ') }}  # ë³µêµ¬ ëŒ€ìƒ í‘œì‹œ
          - Final Status:
          {{ final_status.stdout | default('ì •ë³´ ì—†ìŒ') }}  # ìƒíƒœ ì¶œë ¥
