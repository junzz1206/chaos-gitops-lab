# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/restore_all.yml
# ëª©ì :
#   - CPU / Network chaos ì”ì—¬ ë¶€í•˜ ì™„ì „ ë³µêµ¬
#   - ì„ì‹œ Chaos Pod ì •ë¦¬
#   - scale 0, ì‚­ì œ, Ready ë¶ˆì¼ì¹˜ ìë™ ë³µì›
#   - Redis â†” Cartservice ì¢…ì† ê´€ê³„ ì¬ì •ë ¬
#   - âœ… CI/CD(ArgoCD, GitLab ë“±) í™˜ê²½ í˜¸í™˜ì„± ê°•í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Perform Unified Chaos Recovery (CPU + Network + Services)
  hosts: k3s_master           # Chaos ë³µêµ¬ëŠ” ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì‹¤í–‰
  become: yes                 # ë£¨íŠ¸ ê¶Œí•œ í•„ìš” (kubectl, ë¡œê·¸ ì ‘ê·¼ ë“±)
  vars:
    # CI/CD í™˜ê²½ ë³€ìˆ˜ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    target_namespace: "{{ lookup('env','TARGET_NAMESPACE') | default('app', true) }}"
    chaos_log_path: "{{ lookup('env','CHAOS_LOG_PATH') | default('/var/log/chaos_test.log', true) }}"
    recovery_wait: "{{ lookup('env','RECOVERY_WAIT') | default(15, true) | int }}"
    recovery_targets: >-
      {{ lookup('env','RECOVERY_TARGETS') |
         default('cartservice,checkoutservice,paymentservice,redis-cart,currencyservice,shippingservice,frontend,emailservice,productcatalogservice,recommendationservice', true)
         .split(',') }}

  tasks:

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 0ï¸âƒ£ CPU ë° ë„¤íŠ¸ì›Œí¬ Chaos ë¶€í•˜ ë³µì› (Pod ë‚´ë¶€ + ë…¸ë“œ ì™¸ë¶€)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§  Cleanup residual CPU & network stress (Pod internal & external)
      block:   # ì •ìƒì ì¸ ë³µêµ¬ ì‹œ ì‹¤í–‰
        - ansible.builtin.shell: |
            echo "[CLEANUP] Restoring CPU and Network states..."

            # 1ï¸âƒ£ ë…¸ë“œ ë‹¨ìœ„ ë¶€í•˜ ë³µì› (external chaos ë³µêµ¬)
            echo "[NODE] Cleaning tc qdisc and killing stress-ng on node..."
            kubectl run cleanup-node --image=alpine --restart=Never -n {{ target_namespace }} --overrides='{
              "spec": {
                "hostPID": true,
                "containers": [{
                  "name": "cleanup",
                  "image": "alpine",
                  "securityContext": { "privileged": true },
                  "command": ["sh", "-c",
                    "apk add --no-cache iproute2 procps; \
                     tc qdisc del dev eth0 root 2>/dev/null || true; \
                     pkill stress-ng 2>/dev/null || true; \
                     echo [OK] Node-level CPU/Network stress restored."]
                }]
              }
            }' || true

            # 2ï¸âƒ£ Pod ë‚´ë¶€ ë¶€í•˜ ë³µì› (internal chaos ë³µêµ¬)
            echo "[POD] Cleaning tc qdisc and killing stress-ng in running pods..."
            PODS=$(kubectl get pods -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}')
            for POD in $PODS; do
              kubectl exec -n {{ target_namespace }} $POD -- sh -c "
                if command -v tc >/dev/null 2>&1; then tc qdisc del dev eth0 root 2>/dev/null || true; fi
                if command -v pkill >/dev/null 2>&1; then pkill stress-ng 2>/dev/null || true; fi
              " || true
            done
          register: chaos_restore      # ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ì €ì¥
          ignore_errors: yes           # ì‹¤íŒ¨í•˜ë”ë¼ë„ ë³µêµ¬ ê³„ì† ì§„í–‰
          changed_when: true           # í•­ìƒ ë³€ê²½ëœ ê²ƒìœ¼ë¡œ í‘œì‹œ

      rescue:  # CI/CDì—ì„œ "ì·¨ì†Œ" ëˆŒëŸ¬ì„œ playbook ì¤‘ë‹¨ ì‹œ ì²˜ë¦¬
        - name: ğŸ›‘ Handle CI/CD manual cancellation
          ansible.builtin.debug:
            msg: "CI/CD ì¤‘ë‹¨ ê°ì§€ë¨ â€” ë³µêµ¬ ì¤‘ë‹¨ ë° ìƒíƒœ ì €ì¥"

        # ì¤‘ë‹¨ ì‹œ ë¡œê·¸ì— â€˜abortedâ€™ ê¸°ë¡
        - ansible.builtin.lineinfile:
            path: "{{ chaos_log_path }}"
            create: yes
            line: "[{{ ansible_date_time.iso8601 }}] Recovery aborted (manual stop detected)"
          become: yes

        # ë³µêµ¬ í”Œë ˆì´ ì¤‘ë‹¨
        - ansible.builtin.meta: end_play

    # ë³µêµ¬ ê²°ê³¼ ì¶œë ¥
    - name: Show chaos restoration actions
      ansible.builtin.debug:
        var: chaos_restore.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ Chaos ì„ì‹œ Pod ì œê±°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§¹ Delete leftover chaos pods (cpu-stress*, net-chaos*, network-chaos*)
      ansible.builtin.shell: |
        # chaos í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ pod ëª©ë¡ ì¶”ì¶œ
        CHAOS_PODS=$(kubectl get pods -n {{ target_namespace }} -o name | grep -E '^pod/(cpu-stress|net-chaos|network-chaos)' || true)
        if [ -n "$CHAOS_PODS" ]; then
          echo "[ACTION] Deleting chaos pods..."
          # ë‚¨ì€ chaos pod ê°•ì œ ì‚­ì œ
          for p in $CHAOS_PODS; do
            kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force || true
          done
        else
          echo "[INFO] No chaos pods found."
        fi
      register: chaos_pod_cleanup      # ì‚­ì œ ê²°ê³¼ ì €ì¥
      ignore_errors: yes
      changed_when: true

    # ì‚­ì œ ê²°ê³¼ ì¶œë ¥
    - name: Show chaos pod cleanup
      ansible.builtin.debug:
        var: chaos_pod_cleanup.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate target namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"   # ì•ˆì „ì¥ì¹˜: app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œë§Œ ë³µêµ¬ ìˆ˜í–‰
        fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
        success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ ë³µêµ¬ ì‹œì‘ ì•ˆë‚´
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Announce recovery start
      ansible.builtin.debug:
        msg: |
          ì „ì²´ ë³µêµ¬ ì‹œì‘
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ë³µêµ¬ ëŒ€ìƒ: {{ recovery_targets | join(', ') }}
          - ì•ˆì •í™” ëŒ€ê¸°: {{ recovery_wait }}ì´ˆ

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ scale 0 â†’ 1 ë³µì›
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Restore scaled-down deployments
      ansible.builtin.shell: |
        # scale 0ìœ¼ë¡œ ì¤‘ë‹¨ëœ Deployment ë‹¤ì‹œ 1ë¡œ ë³µì›
        for svc in {{ recovery_targets | join(' ') }}; do
          replicas=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "")
          if [ "$replicas" = "0" ]; then
            echo "[RESTORE] Scaling $svc from 0 â†’ 1"
            kubectl scale deploy $svc -n {{ target_namespace }} --replicas=1 || true
          fi
        done
      register: scale_restore
      ignore_errors: yes
      changed_when: true

    # ë³µì› ê²°ê³¼ ì¶œë ¥
    - name: Show scale restore result
      ansible.builtin.debug:
        var: scale_restore.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ ëˆ„ë½ Deployment ì¬ë°°í¬
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Recreate missing or empty deployments
      ansible.builtin.shell: |
        # ë³µêµ¬ ëŒ€ìƒ ì¤‘ ë°°í¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ìë™ ì¬ë°°í¬
        for svc in {{ recovery_targets | join(' ') }}; do
          if ! kubectl get deploy $svc -n {{ target_namespace }} >/dev/null 2>&1; then
            if [ -f "{{ playbook_dir }}/../app/$svc.yaml" ]; then
              echo "[AUTO-REDEPLOY] $svc ì—†ìŒ â†’ ì¬ë°°í¬"
              kubectl apply -f {{ playbook_dir }}/../app/$svc.yaml || true
            fi
          fi
        done
      register: redeploy_missing
      ignore_errors: yes
      changed_when: true

    - name: Show redeploy results
      ansible.builtin.debug:
        var: redeploy_missing.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ Ready â‰  Desired â†’ Rollout ì¬ì‹œì‘
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Restart unready deployments
      ansible.builtin.shell: |
        # Ready ìˆ˜ì™€ Desired ìˆ˜ ë¶ˆì¼ì¹˜ ì‹œ rollout restart
        for svc in {{ recovery_targets | join(' ') }}; do
          desired=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
          ready=$(kubectl get deploy $svc -n {{ target_namespace }} -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          if [ "$desired" != "$ready" ]; then
            echo "[ROLLBACK] $svc: Desired=$desired Ready=$ready â†’ rollout restart"
            kubectl rollout restart deploy $svc -n {{ target_namespace }} || true
          fi
        done
      register: restart_unready
      ignore_errors: yes
      changed_when: true

    - name: Show restart actions
      ansible.builtin.debug:
        var: restart_unready.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7ï¸âƒ£ redis-cart â†” cartservice ì¢…ì†ì„± ì •ë ¬
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Ensure cartservice refreshed after redis-cart ready
      ansible.builtin.shell: |
        # redis-cart ì¤€ë¹„ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° í›„ cartservice ì¬ì‹œì‘
        kubectl rollout status deploy/redis-cart -n {{ target_namespace }} --timeout=120s || true
        kubectl rollout restart deploy/cartservice -n {{ target_namespace }} || true
      register: cart_sync
      ignore_errors: yes
      changed_when: true

    - name: Show sync result
      ansible.builtin.debug:
        var: cart_sync.stdout_lines

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8ï¸âƒ£ ì•ˆì •í™” ëŒ€ê¸° í›„ ìµœì¢… ìƒíƒœ í™•ì¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Wait for recovery stabilization
      ansible.builtin.pause:
        seconds: "{{ recovery_wait }}"  # ë³µêµ¬ í›„ ì•ˆì •í™” ëŒ€ê¸°

    - name: Check final deployment status
      ansible.builtin.shell: |
        # ìµœì¢… ë°°í¬ ìƒíƒœ ì¡°íšŒ (READY / DESIRED ë¹„êµ)
        kubectl get deployments -n {{ target_namespace }} \
          -o custom-columns="NAME:.metadata.name,READY:.status.readyReplicas,DESIRED:.spec.replicas" --no-headers
      register: final_status
      changed_when: false
      ignore_errors: yes

    - name: Display final deployment status
      ansible.builtin.debug:
        msg: |
          âœ… ìµœì¢… ë°°í¬ ìƒíƒœ:
          {{ final_status.stdout | default('ì •ë³´ ì—†ìŒ') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9ï¸âƒ£ ë¡œê·¸ ê¸°ë¡
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Write unified recovery summary to log
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"    # chaos ì‹¤í–‰ ë¡œê·¸ íŒŒì¼
        create: yes
        line: |
          [{{ ansible_date_time.iso8601 }}] Recovery(ns={{ target_namespace }}) CPU/NET restored pods={{ chaos_pod_cleanup.stdout | replace('\n','; ') }} final="{{ final_status.stdout | replace('\n','; ') }}"
      become: yes

    # ì½˜ì†”ìš© ìš”ì•½ ì¶œë ¥
    - name: âœ… Print unified recovery completion summary
      ansible.builtin.debug:
        msg: |
          âœ… Chaos ë³µêµ¬ ì™„ë£Œ
          - CPU/Network ë¶€í•˜ í•´ì œ ì™„ë£Œ
          - ì„ì‹œ Chaos Pod ì •ë¦¬: {{ chaos_pod_cleanup.stdout | default('ì—†ìŒ') }}
          - ë³µêµ¬ ëŒ€ìƒ: {{ recovery_targets | join(', ') }}
          - ìµœì¢… ìƒíƒœ:
          {{ final_status.stdout | default('ì •ë³´ ì—†ìŒ') }}


