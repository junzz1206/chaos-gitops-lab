# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# playbooks/chaos/run_cpu_stress.yml
# ëª©ì :
#   - ì§€ì •ëœ ì„œë¹„ìŠ¤ë“¤ì— CPU ë¶€í•˜ ì£¼ì… (internal)
#   - ì „ì²´ Podì— ë¶€í•˜ ì£¼ì… (external, foreground ì‹¤í–‰)
#   - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ë³„ë„ ìˆ˜í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: CPU Chaos Test (Internal / External)
  hosts: k3s_master
  become: yes
  vars:
    target_namespace: "app"                     # í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤
    chaos_duration: 120                         # ë¶€í•˜ ìœ ì§€ ì‹œê°„(ì´ˆ)
    chaos_log_path: "/var/log/chaos_test.log"   # Chaos ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
    target_app_labels: "checkoutservice"        # internal ëª¨ë“œì‹œ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1ï¸âƒ£ stress_mode ê¸°ë³¸ê°’ ì„¤ì •
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Set default stress_mode
      ansible.builtin.set_fact:
        effective_stress_mode: "{{ stress_mode | default('internal') }}"  # ê¸°ë³¸ internal

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2ï¸âƒ£ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate target_namespace
      ansible.builtin.assert:
        that:
          - target_namespace == "app"
        fail_msg: "namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
        success_msg: "namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3ï¸âƒ£ External ëª¨ë“œ - ëª¨ë“  Pod ëŒ€ìƒ stress-ng ë¶€í•˜ (foreground)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: External cluster-wide CPU stress injection (foreground)
      when: effective_stress_mode == "external"
      ansible.builtin.shell: |
        echo "[INFO] Injecting stress-ng load into all pods under {{ target_namespace }} ..."
        ALL_PODS=$(kubectl get pods -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}')
        for POD in $ALL_PODS; do
          echo "[TARGET] $POD"
          kubectl run cpu-stress-$POD \
            --image=alpine:3.19 \
            --restart=Never \
            -n {{ target_namespace }} \
            --command -- sh -c "
              set -eux;
              apk add --no-cache stress-ng >/dev/null;
              echo '[INFO] ğŸ”¥ Starting CPU/MEM/IO stress for {{ chaos_duration }}s on $POD...';
              stress-ng -c 0 -l 100 --matrix 64 --vm 16 --vm-bytes 95% --hdd 4 \
                --timeout {{ chaos_duration }}s --metrics-brief;
              echo '[OK] âœ… Stress complete for $POD';
              sleep 1;
            " || true
        done
      register: external_stress_result
      ignore_errors: yes
      changed_when: true

    - name: External stress summary
      when: effective_stress_mode == "external"
      ansible.builtin.debug:
        msg: |
          âœ… External CPU stress pods launched (foreground mode)
          RC={{ external_stress_result.rc }}
          STDOUT:
          {{ external_stress_result.stdout | default('N/A') }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4ï¸âƒ£ Internal ëª¨ë“œ - ì§€ì •ëœ ì„œë¹„ìŠ¤ë³„ ë¶€í•˜ ì£¼ì…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Split target_app_labels into list
      when: effective_stress_mode != "external"
      ansible.builtin.set_fact:
        target_services: "{{ target_app_labels.split(',') | map('trim') | list }}"

    - name: Inject CPU stress into each target service pod (internal mode)
      when: effective_stress_mode != "external"
      ansible.builtin.shell: |
        for svc in {{ target_services | join(' ') }}; do
          echo "[INFO] Finding pod for service: $svc"
          POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$POD" ]; then
            echo "[CHAOS] Injecting CPU stress into $svc ($POD) for {{ chaos_duration }}s"
            kubectl exec -n {{ target_namespace }} $POD -- sh -c '
              if command -v yes >/dev/null 2>&1; then
                yes > /dev/null &
                PID=$!
                sleep {{ chaos_duration }}
                kill $PID 2>/dev/null || true
                echo "[DONE] CPU stress completed for $svc"
              else
                echo "[WARN] yes command not found in container for $svc"
              fi
            '
          else
            echo "[SKIP] No running pod found for $svc"
          fi
        done
      register: internal_stress_result
      ignore_errors: yes
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5ï¸âƒ£ Chaos ë¡œê·¸ ê¸°ë¡ (ë³µêµ¬ ì—†ìŒ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Log chaos summary
      ansible.builtin.lineinfile:
        path: "{{ chaos_log_path }}"
        create: true
        line: |
          [{{ ansible_date_time.iso8601 }}] ChaosCPU ns={{ target_namespace }} mode={{ effective_stress_mode }} duration={{ chaos_duration }} target_services={{ target_app_labels }}
      become: yes

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6ï¸âƒ£ ê²°ê³¼ ì¶œë ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Final chaos summary message
      ansible.builtin.debug:
        msg: |
          âœ… CPU Chaos Injection Completed
          - Mode: {{ effective_stress_mode }}
          - Duration: {{ chaos_duration }}s
          - Namespace: {{ target_namespace }}
          - Target Services: {{ target_app_labels }}
          - Recovery handled separately in restore_all.yml

