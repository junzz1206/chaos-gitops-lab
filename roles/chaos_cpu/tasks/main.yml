# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# roles/chaos_cpu/tasks/main.yml
# ëª©ì : checkoutservice ë° backend ê³„ì¸µ ì „ì²´ì— CPU ë¶€í•˜ ì£¼ì…
# í‘œì¤€ ë³€ìˆ˜:
#   - target_namespace: Chaos ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ê¸°ë³¸: app)
#   - chaos_duration: ë¶€í•˜ ìœ ì§€ ì‹œê°„ (ê¸°ë³¸: 10s)
#   - chaos_log_path: Chaos ì‹¤í–‰ ë¡œê·¸ ê²½ë¡œ (ê¸°ë³¸: /var/log/chaos_test.log)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Step 1ï¸âƒ£: Safety Check
- name: ğŸ§© Safety Check - Namespace Validation
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# Step 2ï¸âƒ£: Set defaults
- name: âš™ï¸ Set default variables
  ansible.builtin.set_fact:
    chaos_duration: "{{ chaos_duration | default('10s') }}"
    chaos_log_path: "/var/log/chaos_test.log"
  changed_when: false

# Step 3ï¸âƒ£: Log start message
- name: ğŸ§¾ Announce CPU Stress Test start
  ansible.builtin.debug:
    msg: |
      ğŸš€ CPU ë¶€í•˜ ì£¼ì… ì‹œì‘
      - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
      - ìœ ì§€ ì‹œê°„: {{ chaos_duration }}
      - ë¡œê·¸ ê²½ë¡œ: {{ chaos_log_path }}

# Step 4ï¸âƒ£: checkoutservice Pod ë¶€í•˜ ì£¼ì…
- name: ğŸ”¥ Inject CPU Load into checkoutservice
  ansible.builtin.shell: |
    POD=$(kubectl get pod -n {{ target_namespace }} -l app=checkoutservice -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
    if [ -n "$POD" ]; then
      echo "[LOAD] checkoutservice pod=$POD"
      kubectl exec -n {{ target_namespace }} $POD -- bash -c "yes > /dev/null & sleep {{ chaos_duration }} && pkill yes || true"
    else
      echo "[SKIP] checkoutservice Pod ì—†ìŒ"
    fi
  register: checkout_cpu_result
  ignore_errors: yes
  changed_when: true

# Step 5ï¸âƒ£: backend tier ì „ì²´ ë¶€í•˜ ì£¼ì…
- name: ğŸ’ª Inject CPU Stress to all backend services
  ansible.builtin.shell: |
    pods=$(kubectl get pods -n {{ target_namespace }} -l 'tier=backend' -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || true)
    if [ -z "$pods" ]; then
      echo "[SKIP] backend tier Pod ì—†ìŒ"
    else
      for pod in $pods; do
        echo "[LOAD] backend pod=$pod"
        kubectl exec -n {{ target_namespace }} $pod -- bash -c "yes > /dev/null & sleep {{ chaos_duration }} && pkill yes || true"
      done
    fi
  register: backend_cpu_result
  ignore_errors: yes
  changed_when: true

# Step 6ï¸âƒ£: Wait for stabilization
- name: â³ Pause after CPU stress
  ansible.builtin.pause:
    seconds: "{{ (chaos_duration | regex_replace('s$','') | int) + 3 }}"

# Step 7ï¸âƒ£: Verify Pod recovery
- name: ğŸ” Check for non-running pods after CPU stress
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase!=Running -o wide --no-headers || true
  register: non_running_pods
  changed_when: false
  ignore_errors: yes

- name: ğŸ“Š Summarize pod states
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --no-headers | awk '{print $3}' | sort | uniq -c
  register: pod_state_summary
  changed_when: false
  ignore_errors: yes

# Step 8ï¸âƒ£: Log to file
- name: ğŸª¶ Write CPU stress summary to log file
  ansible.builtin.lineinfile:
    path: "{{ chaos_log_path }}"
    create: true
    line: |
      [{{ ansible_date_time.iso8601 }}] ChaosCPU: ns={{ target_namespace }} duration={{ chaos_duration }} checkout_rc={{ checkout_cpu_result.rc }} backend_rc={{ backend_cpu_result.rc }} non_running="{{ non_running_pods.stdout | default('All Running') | replace('\n','; ') }}"
  become: true

# Step 9ï¸âƒ£: Display summary
- name: âœ… Final CPU Chaos Summary
  ansible.builtin.debug:
    msg: |
      âœ… CPU Chaos ì™„ë£Œ
      - checkoutservice RC: {{ checkout_cpu_result.rc }}
      - backend tier RC: {{ backend_cpu_result.rc }}
      - ë¹„ì •ìƒ Pod ìš”ì•½: {{ pod_state_summary.stdout | default('All Running') }}

