# ─────────────────────────────────────────────
# 파일: roles/chaos_network/tasks/main.yml  # 파일 경로
# 목적:                                      # 파일의 역할 설명
#   - internal 모드: 서비스 Pod 내부에서 netem 지연/손실/손상 주입  # 내부 실행 방식
#   - external 모드: 서비스별 chaos pod 생성하여 동일 네트워크에 netem 주입  # 외부 실행 방식
#   - internal 실패 시 자동 external fallback (서비스별)  # 실패 시 전환
#   - GitLab/ArgoCD 등 CI/CD 환경 변수 기반 서비스 지정 가능  # CI/CD 호환
#   - 복구는 restore_all.yml에서만 수행  # 복구 책임 분리
# 표준 변수:  # 주요 변수 목록
#   target_namespace, net_mode, network_delay_ms, packet_loss_percent,  # 네트워크 지연 관련
#   packet_corrupt_percent, chaos_duration, target_services  # 손상율, 시간, 타겟 서비스
# ─────────────────────────────────────────────

# ─────────────────────────────────────────────
# 1️⃣ Safety Check - 네임스페이스 확인
# ─────────────────────────────────────────────
- name: Safety Check - Confirm namespace  # 네임스페이스 유효성 확인
  ansible.builtin.assert:
    that:
      - target_namespace == "app"  # 반드시 app 네임스페이스에서만 실행
    fail_msg: "❌ namespace가 'app'이 아닙니다. Chaos는 app 내에서만 수행해야 합니다."
    success_msg: "✅ namespace 확인 완료"

# ─────────────────────────────────────────────
# 2️⃣ 기본값 및 환경변수 설정
# ─────────────────────────────────────────────
- name: Set default and environment-driven variables  # 환경 변수 및 기본값 설정
  ansible.builtin.set_fact:
    net_mode: "{{ lookup('env','NET_MODE') | default(net_mode | default('internal'), true) }}"  # internal/external 모드 결정
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(network_delay_ms | default(3000), true) }}"  # 지연시간(ms)
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(packet_loss_percent | default(5), true) }}"  # 손실률(%)
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(packet_corrupt_percent | default(0), true) }}"  # 손상률(%)
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(60), true) | int }}"  # 지속시간(초)
    env_target_services: "{{ lookup('env','TARGET_SERVICES') | default('', true) }}"  # 환경변수 TARGET_SERVICES에서 대상 목록 가져오기
    default_services:  # 환경변수 없을 경우 기본 서비스 목록
      - frontend
      - productcatalogservice
      - cartservice
      - checkoutservice
      - paymentservice
      - shippingservice
      - emailservice
      - redis-cart
    effective_target_services: >-  # 최종 타겟 서비스 결정
      {{
        (env_target_services.split(',') | map('trim') | list)
        if env_target_services | length > 0
        else default_services
      }}
  changed_when: false  # 상태 변경 감지 비활성화

- name: Display chaos configuration  # Chaos 설정 디버그 출력
  ansible.builtin.debug:
    msg: |
      ⚙️ Network Chaos Configuration
      - Mode: {{ net_mode }}
      - Duration: {{ chaos_duration }}s
      - Delay: {{ network_delay_ms }}ms
      - Loss: {{ packet_loss_percent }}%
      - Corrupt: {{ packet_corrupt_percent }}%
      - Targets: {{ effective_target_services | join(', ') }}

# ─────────────────────────────────────────────
# 3️⃣ Internal Mode - Pod 내부 netem 주입
# ─────────────────────────────────────────────
- name: Apply network chaos internally per service  # internal 모드 실행 블록
  when: net_mode == "internal"  # 조건: internal 모드일 때만 실행
  ansible.builtin.shell: |
    failed_services=""  # 실패 서비스 초기화
    for svc in {{ effective_target_services | join(' ') }}; do  # 서비스별 반복
      echo "[INFO] Target: $svc — applying internal netem..."
      POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)  # 첫 번째 Pod 선택
      if [ -z "$POD" ]; then
        echo "[SKIP] $svc: No running pods."
        continue
      fi
      kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1 || failed_services="$failed_services $svc"
      echo "[CHAOS] Applying netem to $svc ($POD)..."
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
        delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}% || failed_services="$failed_services $svc"
    done
    if [ -n "$failed_services" ]; then
      echo "[WARN] Internal netem failed for:$failed_services"
      exit 99  # 실패 시 fallback 유도
    fi
  register: internal_netem_result
  ignore_errors: yes  # 오류 무시 (fallback 위해)
  changed_when: true

# ─────────────────────────────────────────────
# 4️⃣ Internal 실패 시 External로 전환
# ─────────────────────────────────────────────
- name: Switch to external mode on internal failure
  when: net_mode == "internal" and internal_netem_result.rc is defined and internal_netem_result.rc != 0
  ansible.builtin.set_fact:
    net_mode: "external"  # external 모드로 전환
  changed_when: true

- name: Fallback notice
  when: net_mode == "external"
  ansible.builtin.debug:
    msg: "⚠️ Internal netem injection failed → Switching to external mode (per-service pods)."

# ─────────────────────────────────────────────
# 5️⃣ External Mode - 서비스별 Chaos Pod 생성 (공통 라벨 적용)
# ─────────────────────────────────────────────
- name: Apply external network chaos (per-service helper pods)
  when: net_mode == "external"
  ansible.builtin.shell: |
    for svc in {{ effective_target_services | join(' ') }}; do
      echo "[EXTERNAL] Launching chaos pod for ${svc}..."
      SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # 고유 접미사 생성

      # ✅ 공통 라벨 표준 적용 + tier 자동 분기
      if [ "$svc" = "frontend" ]; then
        TIER="frontend"
      elif [ "$svc" = "redis-cart" ]; then
        TIER="data"
      else
        TIER="backend"
      fi

      LABELS="app=${svc},app.kubernetes.io/name=${svc},app.kubernetes.io/part-of=online-boutique-chaos-lab,app.kubernetes.io/tier=${TIER},app.kubernetes.io/component=network-chaos"

      kubectl run net-chaos-${svc}-${SUFFIX} \
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
        --labels="${LABELS}" \  # 표준 라벨 부여
        --overrides='{  
          "spec": {
            "containers": [{
              "name": "net-chaos",
              "image": "nicolaka/netshoot:latest",
              "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } },
              "command": ["/bin/sh", "-c"],
              "args": [
                "set -eux; \
                 echo \"[CHAOS] ${svc}: delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}%\"; \
                 tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%; \
                 sleep {{ chaos_duration }}; \
                 echo \"[RECOVERY] Restoring network (${svc})...\"; \
                 tc qdisc del dev eth0 root || true; \
                 echo \"[SELF-DELETE] Cleaning up chaos pod (${svc})...\"; \
                 kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;"
              ]
            }]
          }
        }' || true
    done
  register: external_netem_result
  ignore_errors: yes
  changed_when: true

- name: Show external result
  ansible.builtin.debug:
    msg: "{{ external_netem_result.stdout | default('No external chaos output') }}"

# ─────────────────────────────────────────────
# 6️⃣ Chaos 유지 및 최종 안내
# ─────────────────────────────────────────────
- name: Wait for chaos duration
  ansible.builtin.pause:
    seconds: "{{ chaos_duration }}"  # chaos 유지 시간만큼 대기

- name: Final notice
  ansible.builtin.debug:
    msg: |
      ✅ Network Chaos Injection Complete
      - Mode: {{ net_mode }}
      - Duration: {{ chaos_duration }}s
      - Delay: {{ network_delay_ms }}ms
      - Loss: {{ packet_loss_percent }}%
      - Corrupt: {{ packet_corrupt_percent }}%
      - Targets: {{ effective_target_services | join(', ') }}
      - ⚠️ 복구는 restore_all.yml에서 수행됩니다.
