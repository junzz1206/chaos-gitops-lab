# ─────────────────────────────────────────────
# 파일: roles/chaos_network/tasks/main.yml
# 목적:
#   - internal 모드: 지정된 서비스 Pod 내부에 netem 지연/손실/손상 주입
#   - external 모드: 각 서비스별 chaos 전용 Pod을 띄워 같은 네트워크에 netem 주입
#   - internal 실패 시 자동으로 external 전환 (서비스별)
#   - CI/CD(GitLab, ArgoCD 등) 환경변수 기반 서비스 지정 지원
#   - 복구는 restore_all.yml에서만 수행
# 표준 변수:
#   target_namespace, net_mode, network_delay_ms, packet_loss_percent,
#   packet_corrupt_percent, chaos_duration, target_services
# ─────────────────────────────────────────────

# ─────────────────────────────────────────────
# 1️⃣ Safety Check - 네임스페이스 확인
# ─────────────────────────────────────────────
- name: Safety Check - Confirm namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "❌ namespace가 'app'이 아닙니다. Chaos는 app 내에서만 수행해야 합니다."
    success_msg: "✅ namespace 확인 완료"

# ─────────────────────────────────────────────
# 2️⃣ 기본값 및 환경변수 설정
# ─────────────────────────────────────────────
- name: Set default and environment-driven variables
  ansible.builtin.set_fact:
    net_mode: "{{ lookup('env','NET_MODE') | default(net_mode | default('internal'), true) }}"
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(network_delay_ms | default(3000), true) }}"
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(packet_loss_percent | default(5), true) }}"
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(packet_corrupt_percent | default(0), true) }}"
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(60), true) }}"
    env_target_services: "{{ lookup('env','TARGET_SERVICES') | default('', true) }}"
    default_services:
      - frontend
      - productcatalogservice
      - cartservice
      - checkoutservice
      - paymentservice
      - shippingservice
      - emailservice
      - redis-cart
    effective_target_services: >-
      {{
        (env_target_services.split(',') | map('trim') | list)
        if env_target_services | length > 0
        else default_services
      }}
  changed_when: false

- name: Display chaos configuration
  ansible.builtin.debug:
    msg: |
      ⚙️ Network Chaos Configuration
      - Mode: {{ net_mode }}
      - Duration: {{ chaos_duration }}s
      - Delay: {{ network_delay_ms }}ms
      - Loss: {{ packet_loss_percent }}%
      - Corrupt: {{ packet_corrupt_percent }}%
      - Targets: {{ effective_target_services | join(', ') }}

# ─────────────────────────────────────────────
# 3️⃣ Internal Mode - Pod 내부 netem 주입
# ─────────────────────────────────────────────
- name: Apply network chaos internally per service
  when: net_mode == "internal"
  ansible.builtin.shell: |
    failed_services=""
    for svc in {{ effective_target_services | join(' ') }}; do
      echo "[INFO] Target: $svc — applying internal netem..."
      POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
      if [ -z "$POD" ]; then
        echo "[SKIP] $svc: No running pods."
        continue
      fi
      # tc 명령 확인
      kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1 || failed_services="$failed_services $svc"
      echo "[CHAOS] Applying netem to $svc ($POD)..."
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
        delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}% || failed_services="$failed_services $svc"
    done
    if [ -n "$failed_services" ]; then
      echo "[WARN] Internal netem failed for:$failed_services"
      exit 99
    fi
  register: internal_netem_result
  ignore_errors: yes
  changed_when: true

# ─────────────────────────────────────────────
# 4️⃣ Internal 실패 시 External로 전환
# ─────────────────────────────────────────────
- name: Switch to external mode on internal failure
  when: net_mode == "internal" and internal_netem_result.rc is defined and internal_netem_result.rc != 0
  ansible.builtin.set_fact:
    net_mode: "external"
  changed_when: true

- name: Fallback notice
  when: net_mode == "external"
  ansible.builtin.debug:
    msg: "⚠️ Internal netem injection failed → Switching to external mode (service-scoped pods)."

# ─────────────────────────────────────────────
# 5️⃣ External Mode - 서비스별 Chaos Pod 생성
# ─────────────────────────────────────────────
- name: Apply external network chaos (per-service helper pods)
  when: net_mode == "external"
  ansible.builtin.shell: |
    for svc in {{ effective_target_services | join(' ') }}; do
      echo "[EXTERNAL] Launching chaos pod for $svc..."
      kubectl run net-chaos-$svc \
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
        --labels="chaos-target=$svc" \
        --overrides='{
          "spec": {
            "containers": [{
              "name": "net-chaos",
              "image": "nicolaka/netshoot:latest",
              "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } },
              "command": ["/bin/sh", "-c"],
              "args": [
                "echo \"[CHAOS] Applying {{ network_delay_ms }}ms delay, {{ packet_loss_percent }}% loss, {{ packet_corrupt_percent }}% corrupt for {{ chaos_duration }}s (service: $svc)\"; \
                 tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%; \
                 sleep {{ chaos_duration }}; \
                 echo \"[RECOVERY] Restoring network (service: $svc)...\"; \
                 tc qdisc del dev eth0 root || true;"
              ]
            }]
          }
        }' || true
    done
  register: external_netem_result
  ignore_errors: yes
  changed_when: true

- name: Show external result
  ansible.builtin.debug:
    msg: "{{ external_netem_result.stdout | default('No external chaos output') }}"

# ─────────────────────────────────────────────
# 6️⃣ Chaos 유지 및 최종 안내
# ─────────────────────────────────────────────
- name: Wait for chaos duration
  ansible.builtin.pause:
    seconds: "{{ chaos_duration }}"

- name: Final notice
  ansible.builtin.debug:
    msg: |
      ✅ Network Chaos Injection Complete
      - Mode: {{ net_mode }}
      - Duration: {{ chaos_duration }}s
      - Delay: {{ network_delay_ms }}ms
      - Loss: {{ packet_loss_percent }}%
      - Corrupt: {{ packet_corrupt_percent }}%
      - Targets: {{ effective_target_services | join(', ') }}
      - ⚠️ 복구는 restore_all.yml에서 수행됩니다.
