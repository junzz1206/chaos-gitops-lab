# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# roles/chaos_network/tasks/main.yml
# ëª©ì : redis-cart Podì— ë„¤íŠ¸ì›Œí¬ ì§€ì—°, ì†ì‹¤, ìˆœì„œë³€ê²½ ì£¼ì…
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, network_delay_ms, chaos_duration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ§© Safety Check - Confirm namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤."
    success_msg: "namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ Locate redis-cart pod
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Locate redis-cart pod
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} -l app=redis-cart -o name | head -n 1
  register: redis_pod
  changed_when: false

- name: Abort if redis-cart pod not found
  ansible.builtin.fail:
    msg: "redis-cart Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  when: redis_pod.stdout == ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Remove existing qdisc (safety cleanup)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Ensure no previous netem rule exists
  ansible.builtin.shell: |
    kubectl exec -n {{ target_namespace }} {{ redis_pod.stdout }} -- \
      tc qdisc del dev eth0 root || true
  changed_when: false
  ignore_errors: yes

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Inject network chaos (delay + loss + reorder)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Inject combined network chaos
  ansible.builtin.shell: |
    kubectl exec -n {{ target_namespace }} {{ redis_pod.stdout }} -- \
      tc qdisc add dev eth0 root netem \
      delay {{ network_delay_ms }}ms loss 2% reorder 25%
  ignore_errors: yes
  register: netem_injected

- name: Log applied network chaos
  ansible.builtin.debug:
    msg: |
      redis-cartì— {{ network_delay_ms }}ms ì§€ì—°, 2% ì†ì‹¤, 25% íŒ¨í‚· ìˆœì„œ ë³€ê²½ ì£¼ì… ì™„ë£Œ.
      Pod: {{ redis_pod.stdout }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Hold chaos duration
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Maintain chaos effect for defined duration
  ansible.builtin.pause:
    seconds: "{{ (chaos_duration | regex_replace('s$', '')) | int }}"
  when: chaos_duration is defined

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ Restore normal network state
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Remove netem rule and restore normal traffic
  ansible.builtin.shell: |
    kubectl exec -n {{ target_namespace }} {{ redis_pod.stdout }} -- \
      tc qdisc del dev eth0 root || true
  ignore_errors: yes

- name: âœ… Log recovery completion
  ansible.builtin.debug:
    msg: "redis-cart ë„¤íŠ¸ì›Œí¬ ì •ìƒ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ."

