# ─────────────────────────────────────────────
# 파일: roles/chaos_network/tasks/main.yml  # 파일 경로 지정
# 목적:                                      # 이 파일의 기능 설명
#   - internal 모드: 서비스 Pod 내부에서 netem 지연/손실/손상 주입  # 내부 방식 설명
#   - external 모드: 서비스별 chaos pod 생성하여 동일 네트워크에 netem 주입  # 외부 방식 설명
#   - internal 실패 시 자동 external fallback (서비스별)  # 실패 시 자동 전환
#   - GitLab/ArgoCD 등 CI/CD 환경 변수 기반 서비스 지정 가능  # CI/CD 통합 가능
#   - 복구는 restore_all.yml에서만 수행  # 복구는 별도 플레이북에서 수행
# 표준 변수:  # 사용되는 주요 변수
#   target_namespace, net_mode, network_delay_ms, packet_loss_percent,  # 네트워크 지연 관련 변수
#   packet_corrupt_percent, chaos_duration, target_services  # 손상율 및 실행 지속시간
# ─────────────────────────────────────────────

# ─────────────────────────────────────────────
# 1️⃣ Safety Check - 네임스페이스 확인
# ─────────────────────────────────────────────
- name: Safety Check - Confirm namespace  # 현재 네임스페이스 확인 작업
  ansible.builtin.assert:  # assert 모듈을 사용하여 검증 수행
    that:  # 확인 조건 정의
      - target_namespace == "app"  # 'app' 네임스페이스에서만 실행 허용
    fail_msg: "❌ namespace가 'app'이 아닙니다. Chaos는 app 내에서만 수행해야 합니다."  # 실패 메시지
    success_msg: "✅ namespace 확인 완료"  # 성공 메시지

# ─────────────────────────────────────────────
# 2️⃣ 기본값 및 환경변수 설정
# ─────────────────────────────────────────────
- name: Set default and environment-driven variables  # 환경변수 및 기본값 세팅
  ansible.builtin.set_fact:  # Ansible 내부 변수 설정
    net_mode: "{{ lookup('env','NET_MODE') | default(net_mode | default('internal'), true) }}"  # 실행 모드 설정 (기본 internal)
    network_delay_ms: "{{ lookup('env','NETWORK_DELAY_MS') | default(network_delay_ms | default(3000), true) }}"  # 네트워크 지연(ms)
    packet_loss_percent: "{{ lookup('env','PACKET_LOSS_PERCENT') | default(packet_loss_percent | default(5), true) }}"  # 패킷 손실율
    packet_corrupt_percent: "{{ lookup('env','PACKET_CORRUPT_PERCENT') | default(packet_corrupt_percent | default(0), true) }}"  # 손상율 설정
    chaos_duration: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(60), true) | int }}"  # 지속 시간(초 단위)
    env_target_services: "{{ lookup('env','TARGET_SERVICES') | default('', true) }}"  # 환경변수 기반 대상 서비스
    default_services:  # 환경변수 미지정 시 기본 서비스 목록 정의
      - frontend  # 프론트엔드 서비스
      - productcatalogservice  # 상품 카탈로그 서비스
      - cartservice  # 장바구니 서비스
      - checkoutservice  # 결제 서비스
      - paymentservice  # 결제 처리 서비스
      - shippingservice  # 배송 서비스
      - emailservice  # 이메일 발송 서비스
      - redis-cart  # 캐시 서비스(redis)
    effective_target_services: >-  # 최종적으로 사용할 서비스 목록 계산
      {{
        (env_target_services.split(',') | map('trim') | list)  # 쉼표 구분 리스트로 변환
        if env_target_services | length > 0  # 환경변수 존재 시 사용
        else default_services  # 그렇지 않으면 기본 서비스 사용
      }}
  changed_when: false  # 단순 변수 설정으로 변경 감지 비활성화

- name: Display chaos configuration  # 현재 설정 확인용 출력
  ansible.builtin.debug:  # 디버그 메시지 출력 모듈
    msg: |  # 여러 줄 문자열
      ⚙️ Network Chaos Configuration  # 설정 제목
      - Mode: {{ net_mode }}  # 실행 모드 표시
      - Duration: {{ chaos_duration }}s  # 지속시간
      - Delay: {{ network_delay_ms }}ms  # 지연시간
      - Loss: {{ packet_loss_percent }}%  # 손실률
      - Corrupt: {{ packet_corrupt_percent }}%  # 손상률
      - Targets: {{ effective_target_services | join(', ') }}  # 대상 서비스 출력

# ─────────────────────────────────────────────
# 3️⃣ Internal Mode - Pod 내부 netem 주입
# ─────────────────────────────────────────────
- name: Apply network chaos internally per service  # internal 모드에서 Pod 내부 실행
  when: net_mode == "internal"  # 조건문: internal 모드일 때만 실행
  ansible.builtin.shell: |  # 셸 명령어 블록 시작
    failed_services=""  # 실패한 서비스 목록 초기화
    for svc in {{ effective_target_services | join(' ') }}; do  # 각 서비스 반복
      echo "[INFO] Target: $svc — applying internal netem..."  # 로그 출력
      POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)  # 첫 번째 Pod 이름 가져오기
      if [ -z "$POD" ]; then  # Pod 존재 확인
        echo "[SKIP] $svc: No running pods."  # Pod 없으면 스킵 로그
        continue  # 다음 서비스로 넘어감
      fi
      kubectl exec -n {{ target_namespace }} $POD -- sh -c "which tc" >/dev/null 2>&1 || failed_services="$failed_services $svc"  # tc 명령 존재 여부 확인
      echo "[CHAOS] Applying netem to $svc ($POD)..."  # 실행 로그
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc del dev eth0 root || true  # 기존 qdisc 삭제
      kubectl exec -n {{ target_namespace }} $POD -- tc qdisc add dev eth0 root netem \
        delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}% || failed_services="$failed_services $svc"  # netem 적용
    done  # 반복문 종료
    if [ -n "$failed_services" ]; then  # 실패 서비스 존재 시
      echo "[WARN] Internal netem failed for:$failed_services"  # 경고 로그
      exit 99  # 실패 코드 반환 (fallback 트리거)
    fi  # 조건문 종료
  register: internal_netem_result  # 결과를 변수에 저장
  ignore_errors: yes  # 오류 발생 시에도 계속 진행
  changed_when: true  # 시스템 변경 감지 활성화

# ─────────────────────────────────────────────
# 4️⃣ Internal 실패 시 External로 전환
# ─────────────────────────────────────────────
- name: Switch to external mode on internal failure  # internal 실패 감지 후 external 전환
  when: net_mode == "internal" and internal_netem_result.rc is defined and internal_netem_result.rc != 0  # 실패 시 조건
  ansible.builtin.set_fact:  # 동적 변수 변경
    net_mode: "external"  # external 모드로 전환
  changed_when: true  # 변경 감지 표시

- name: Fallback notice  # fallback 발생 알림
  when: net_mode == "external"  # external 모드일 때만 실행
  ansible.builtin.debug:  # 디버그 메시지 출력
    msg: "⚠️ Internal netem injection failed → Switching to external mode (per-service pods)."  # 안내 메시지

# ─────────────────────────────────────────────
# 5️⃣ External Mode - 서비스별 Chaos Pod 생성 (공통 라벨 적용)
# ─────────────────────────────────────────────
- name: Apply external network chaos (per-service helper pods)  # external 모드 실행
  when: net_mode == "external"  # 조건: external 모드일 때만
  ansible.builtin.shell: |  # 셸 명령 블록 시작
    for svc in {{ effective_target_services | join(' ') }}; do  # 각 서비스 반복
      echo "[EXTERNAL] Launching chaos pod for ${svc}..."  # 로그 출력
      SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # 무작위 접미사 생성

      # ✅ 공통 라벨 표준 적용 + tier 자동 분기
      if [ "$svc" = "frontend" ]; then  # 프론트엔드일 경우
        TIER="frontend"  # tier=frontend 설정
      elif [ "$svc" = "redis-cart" ]; then  # Redis일 경우
        TIER="data"  # tier=data 설정
      else  # 나머지
        TIER="backend"  # tier=backend 설정
      fi  # 조건문 종료

      LABELS="app=\${svc},app.kubernetes.io/name=\${svc},app.kubernetes.io/part-of=online-boutique-chaos-lab,app.kubernetes.io/tier=\${TIER},app.kubernetes.io/component=network-chaos"  # 공통 라벨 문자열 조합

      kubectl run net-chaos-\${svc}-\${SUFFIX} \  # chaos pod 생성
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \  # 네임스페이스 지정 및 단일 실행 모드
        --labels="\${LABELS}" \  # 라벨 적용
        --overrides='{  # JSON 기반 Pod 오버라이드 정의 시작
          "spec": {  # Pod spec 정의
            "containers": [{  # 컨테이너 정의
              "name": "net-chaos",  # 컨테이너 이름
              "image": "nicolaka/netshoot:latest",  # 이미지 지정
              "securityContext": { "capabilities": { "add": ["NET_ADMIN"] } },  # 네트워크 관리자 권한 부여
              "command": ["/bin/sh", "-c"],  # 명령 실행 방식
              "args": [  # 실행 명령 정의
                "set -eux; \  # 스크립트 에러 시 즉시 중단 + 디버그
                 echo \"[CHAOS] \${svc}: delay={{ network_delay_ms }}ms loss={{ packet_loss_percent }}% corrupt={{ packet_corrupt_percent }}%\"; \  # Chaos 시작 로그
                 tc qdisc add dev eth0 root netem delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%; \  # 네트워크 지연 및 손실 주입
                 sleep {{ chaos_duration }}; \  # 지정 시간 대기
                 echo \"[RECOVERY] Restoring network (\${svc})...\"; \  # 복구 로그 출력
                 tc qdisc del dev eth0 root || true; \  # qdisc 제거
                 echo \"[SELF-DELETE] Cleaning up chaos pod (\${svc})...\"; \  # 자기 삭제 로그
                 kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;"  # 자기 자신 삭제
              ]  # args 종료
            }]  # 컨테이너 배열 종료
          }  # spec 종료
        }' || true  # 실패해도 무시하고 계속 실행
    done  # 반복문 종료
  register: external_netem_result  # 결과를 변수로 저장
  ignore_errors: yes  # 일부 실패 허용
  changed_when: true  # 변경 감지

- name: Show external result  # 외부 실행 결과 출력
  ansible.builtin.debug:  # 디버그 모듈 사용
    msg: "{{ external_netem_result.stdout | default('No external chaos output') }}"  # 로그 출력

# ─────────────────────────────────────────────
# 6️⃣ Chaos 유지 및 최종 안내
# ─────────────────────────────────────────────
- name: Wait for chaos duration  # Chaos 유지 시간 대기
  ansible.builtin.pause:  # Ansible 일시 정지 모듈
    seconds: "{{ chaos_duration }}"  # chaos_duration만큼 대기

- name: Final notice  # 최종 요약 출력
  ansible.builtin.debug:  # 디버그 출력
    msg: |  # 여러 줄 출력
      ✅ Network Chaos Injection Complete  # 완료 로그
      - Mode: {{ net_mode }}  # 실행 모드 표시
      - Duration: {{ chaos_duration }}s  # 지속 시간
      - Delay: {{ network_delay_ms }}ms  # 지연 시간
      - Loss: {{ packet_loss_percent }}%  # 손실률
      - Corrupt: {{ packet_corrupt_percent }}%  # 손상률
      - Targets: {{ effective_target_services | join(', ') }}  # 대상 목록 출력
      - ⚠️ 복구는 restore_all.yml에서 수행됩니다.  # 복구 안내
