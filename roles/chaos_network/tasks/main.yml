# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# roles/chaos_network/tasks/main.yml
# ëª©ì :
#   - internal ëª¨ë“œ: ì§€ì •ëœ ì„œë¹„ìŠ¤ë“¤(target_services)ì— ë„¤íŠ¸ì›Œí¬ ì§€ì—°/ì†ì‹¤/ì†ìƒ ì£¼ì…
#   - external ëª¨ë“œ: í˜¸ìŠ¤íŠ¸ NIC(eth0)ì— netem ì§ì ‘ ì£¼ì… (ì „ì²´ ì„œë¹„ìŠ¤ ì˜í–¥)
#   - ë³µêµ¬ëŠ” restore_all.ymlì—ì„œë§Œ ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace, net_mode, network_delay_ms, packet_loss_percent,
#   packet_corrupt_percent, chaos_duration, target_services
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ Safety Check - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ§© Safety Check - Confirm namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"                           # app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì™¸ ê¸ˆì§€
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ ê¸°ë³¸ê°’ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: âš™ï¸ Set default variables
  ansible.builtin.set_fact:
    net_mode: "{{ net_mode | default('internal') }}"         # ê¸°ë³¸ internal
    network_delay_ms: "{{ network_delay_ms | default(3000) }}"  # ì§€ì—° (ms)
    packet_loss_percent: "{{ packet_loss_percent | default(5) }}"  # ì†ì‹¤ìœ¨ (%)
    packet_corrupt_percent: "{{ packet_corrupt_percent | default(0) }}"  # ì†ìƒìœ¨ (%)
    chaos_duration: "{{ chaos_duration | default(60) }}"     # ìœ ì§€ì‹œê°„ (ì´ˆ)
    target_services: "{{ (target_services | default('redis-cart')).split(',') | map('trim') | list }}"  # ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì„œë¹„ìŠ¤
  changed_when: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Internal Mode - ì§€ì •ëœ ì„œë¹„ìŠ¤ Podì— netem ì£¼ì…
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ’£ Inject network chaos inside selected services (internal mode)
  when: net_mode == "internal"
  block:

    # 3.1 ëŒ€ìƒ ì„œë¹„ìŠ¤ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¤‘ë‹¨
    - name: ğŸš« Fail if no target services specified
      when: target_services | length == 0
      ansible.builtin.fail:
        msg: "internal ëª¨ë“œì—ì„œëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ target_servicesê°€ í•„ìš”í•©ë‹ˆë‹¤."

    # 3.2 ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì²« ë²ˆì§¸ Pod ì°¾ì•„ì„œ netem ì ìš©
    - name: ğŸ” Iterate over target services
      ansible.builtin.shell: |
        set -eux
        for svc in {{ target_services | join(' ') }}; do
          echo "[INFO] ì„œë¹„ìŠ¤: $svc â†’ Pod ì¡°íšŒ ì¤‘..."
          POD_NAME=$(kubectl get pod -n {{ target_namespace }} -l app=$svc -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)

          if [ -z "$POD_NAME" ]; then
            echo "[SKIP] $svc ì„œë¹„ìŠ¤ì— ì‹¤í–‰ ì¤‘ì¸ Podì´ ì—†ìŠµë‹ˆë‹¤."
            continue
          fi

          echo "[ACTION] $svc ($POD_NAME)ì— ë„¤íŠ¸ì›Œí¬ Chaos ì£¼ì… ì¤‘..."
          kubectl exec -n {{ target_namespace }} $POD_NAME -- tc qdisc del dev eth0 root || true
          kubectl exec -n {{ target_namespace }} $POD_NAME -- \
            tc qdisc add dev eth0 root netem \
            delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%

          echo "[OK] $svc ($POD_NAME)ì— {{ network_delay_ms }}ms ì§€ì—°, {{ packet_loss_percent }}% ì†ì‹¤, {{ packet_corrupt_percent }}% ì†ìƒ ì ìš© ì™„ë£Œ."
        done
      register: internal_netem_result
      ignore_errors: yes
      changed_when: true

    # 3.3 ë¡œê·¸ ì¶œë ¥
    - name: ğŸ§¾ Log internal netem result
      ansible.builtin.debug:
        msg: |
          Internal Mode Netem Injection Complete
          {{ internal_netem_result.stdout | default('No log output') }}

    # 3.4 Chaos ìœ ì§€ì‹œê°„ ëŒ€ê¸°
    - name: â³ Maintain chaos duration
      ansible.builtin.pause:
        seconds: "{{ chaos_duration }}"

    # 3.5 ë³µêµ¬ëŠ” ì´ íŒŒì¼ì—ì„œ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
    - name: âš ï¸ Note - recovery handled in restore_all.yml
      ansible.builtin.debug:
        msg: "ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤. í˜„ì¬ netemì€ ìœ ì§€ ìƒíƒœë¡œ ë‚¨ìŠµë‹ˆë‹¤."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ External Mode - Host NIC ìˆ˜ì¤€ netem ì£¼ì…
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸŒ Inject host-level network chaos (external mode)
  when: net_mode == "external"
  block:

    # 4.1 ì‹œì‘ ì•ˆë‚´
    - name: Announce external chaos start
      ansible.builtin.debug:
        msg: |
          [External Mode] ë…¸ë“œ ì „ì²´ ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì£¼ì… ì‹œì‘
          - delay={{ network_delay_ms }}ms
          - loss={{ packet_loss_percent }}%
          - corrupt={{ packet_corrupt_percent }}%
          - duration={{ chaos_duration }}s

    # 4.2 í˜¸ìŠ¤íŠ¸ NICì— qdisc ì¶”ê°€
    - name: Apply tc qdisc on host NIC (eth0)
      ansible.builtin.shell: |
        tc qdisc del dev eth0 root || true
        tc qdisc add dev eth0 root netem \
          delay {{ network_delay_ms }}ms loss {{ packet_loss_percent }}% corrupt {{ packet_corrupt_percent }}%
      ignore_errors: yes
      register: external_tc_add
      changed_when: true

    # 4.3 Chaos ìœ ì§€ì‹œê°„ ëŒ€ê¸°
    - name: Wait for chaos duration
      ansible.builtin.pause:
        seconds: "{{ chaos_duration }}"

    # 4.4 ë³µêµ¬ëŠ” ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ (restore_all.yml ë‹´ë‹¹)
    - name: âš ï¸ Note - recovery handled in restore_all.yml
      ansible.builtin.debug:
        msg: "í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ëŠ” restore_all.ymlì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤. í˜„ì¬ netemì€ ìœ ì§€ ì¤‘ì…ë‹ˆë‹¤."

