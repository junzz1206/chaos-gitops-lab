# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_kill/tasks/main.yml
# ëª©ì :
#   - ì§€ì •ëœ ì„œë¹„ìŠ¤(ë¼ë²¨ app=)ì˜ Pod ë° ìƒìœ„ ReplicaSet/Deployment ìë™ë³µêµ¬ ì™„ì „ ì°¨ë‹¨ í›„ ê°•ì œ ì‚­ì œ
#   - í™˜ê²½ë³€ìˆ˜ TARGET_SERVICES ê¸°ë°˜ ë‹¤ì¤‘ ì„œë¹„ìŠ¤ Chaos ì£¼ì… ì§€ì›
#   - ë¬´ì‘ìœ„ Chaos Monkey ëª¨ë“œ ì§€ì›
#   - disable_autorecover=true ì‹œ ReplicaSet, Deployment, StatefulSet scale 0
#   - chaos_duration ë™ì•ˆ ë³µêµ¬ ê¸ˆì§€
#   - internal ì‹¤íŒ¨ ì‹œ externalë¡œ ìë™ fallback
#   - CI/CD ì·¨ì†Œ(ArgoCD, GitLab ë“±) ì‹œ ì•ˆì „ ì¤‘ë‹¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Safety Check - Confirm namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app namespace ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 1ï¸âƒ£: Resolve target services dynamically
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target services (ENV â†’ vars.yml â†’ random)
  vars:
    env_target_services: "{{ lookup('env', 'TARGET_SERVICES') | default('', true) }}"
  ansible.builtin.set_fact:
    target_services_effective: >-
      {{
        (env_target_services.split(',') | map('trim') | list)
        if env_target_services | length > 0
        else
          (
            [ target_app_label ]
            if (target_app_label is defined and target_app_label != "random")
            else []
          )
      }}
  changed_when: false

- name: Display resolved service targets
  ansible.builtin.debug:
    msg: |
      ğŸ¯ Chaos ëŒ€ìƒ ì„œë¹„ìŠ¤
      - ENV(TARGET_SERVICES): {{ lookup('env', 'TARGET_SERVICES') | default('N/A') }}
      - Vars(target_app_label): {{ target_app_label | default('N/A') }}
      - Effective: {{ target_services_effective | default([]) }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 2ï¸âƒ£: Disable auto-recovery for each target
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable auto-recovery for selected services
  when:
    - disable_autorecover | default(true)
    - target_services_effective | length > 0
  ansible.builtin.shell: |
    for svc in {{ target_services_effective | join(' ') }}; do
      echo "[DISABLE] Scaling down controllers for $svc ..."
      kubectl get deploy -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      kubectl get rs -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      kubectl get sts -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      echo "[OK] $svc auto-recovery disabled."
    done
  register: disable_result
  ignore_errors: yes

- name: Show disable result
  ansible.builtin.debug:
    msg: "{{ disable_result.stdout | default('No output') }}"
  when: disable_result is defined

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 3ï¸âƒ£: Kill pods of each target service (try internal first)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Attempt pod kill via internal exec (detect minimal images)
  when: target_services_effective | length > 0
  ansible.builtin.shell: |
    failed_services=""
    for svc in {{ target_services_effective | join(' ') }}; do
      echo "[TRY] Internal delete for $svc ..."
      POD=$(kubectl get pod -n {{ target_namespace }} -l app=$svc \
        -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
      if [ -n "$POD" ]; then
        # distroless ì´ë¯¸ì§€ ë“±ì—ì„œ shell ì‹¤í–‰ ë¶ˆê°€ ì‹œ ì‹¤íŒ¨ ì²˜ë¦¬
        kubectl exec -n {{ target_namespace }} $POD -- sh -c "echo ok" >/dev/null 2>&1 || failed_services="$failed_services $svc"
        echo "[INFO] Killing pod(s) for $svc ..."
        kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true
      else
        echo "[SKIP] No pod found for $svc"
      fi
    done
    if [ -n "$failed_services" ]; then
      echo "[WARN] Internal mode not supported on:$failed_services"
      exit 99
    fi
  register: internal_kill_result
  ignore_errors: yes

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 4ï¸âƒ£: Auto-fallback (internal â†’ external)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Fallback to external deletion if internal failed
  when: internal_kill_result.rc != 0
  ansible.builtin.shell: |
    echo "[FALLBACK] Switching to external chaos kill mode..."
    for svc in {{ target_services_effective | join(' ') }}; do
      echo "[CHAOS] Forcing deletion of pods for $svc (external)..."
      kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true
    done
  register: fallback_kill_result
  ignore_errors: yes

- name: Log fallback result
  when: internal_kill_result.rc != 0
  ansible.builtin.debug:
    msg: |
      âš ï¸ Internal execution failed, switched to external mode
      {{ fallback_kill_result.stdout | default('No output') }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 5ï¸âƒ£: Random Chaos Mode (fallback if no service provided)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute random chaos mode
  when: (target_services_effective | length == 0) or (target_app_label | default('random') == 'random')
  ansible.builtin.shell: |
    chaos_targets="frontend productcatalogservice cartservice checkoutservice paymentservice shippingservice emailservice redis-cart"
    echo "[RANDOM CHAOS] Randomly selecting services..."
    for i in $(seq 1 {{ random_pod_kill_count | default(1) }}); do
      svc=$(shuf -e $chaos_targets -n 1)
      echo "[TARGET] Selected: $svc"
      kubectl get deploy -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      pod=$(kubectl get pods -n {{ target_namespace }} -l app=$svc -o name | shuf -n 1)
      [ -n "$pod" ] && echo "[KILL] $svc â†’ $pod" && kubectl delete $pod -n {{ target_namespace }} --grace-period=0 --force
    done
  register: random_kill_result
  ignore_errors: yes

- name: Show random chaos results
  ansible.builtin.debug:
    msg: |
      ğŸ² Random Chaos Results:
      {{ random_kill_result.stdout | default('No output') }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 6ï¸âƒ£: Post-chaos verification
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Wait for recovery period
  ansible.builtin.pause:
    seconds: "{{ chaos_duration | default(30) }}"

- name: Verify non-running pods
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase!=Running
  register: non_running_pods
  changed_when: false
  ignore_errors: yes

- name: Display final status
  ansible.builtin.debug:
    msg: |
      âœ… Chaos í…ŒìŠ¤íŠ¸ ì™„ë£Œ
      ë¹„ì •ìƒ ìƒíƒœì˜ Pod:
      {{ non_running_pods.stdout | default('None (All Running)') }}


