# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# roles/chaos_kill/tasks/main.yml
# ëª©ì : íŠ¹ì • ì„œë¹„ìŠ¤ Pod í˜¹ì€ ë¬´ì‘ìœ„ Pod ê°•ì œ ì¢…ë£Œ (Chaos Monkey)
# ì„¤ëª…:
#   - target_app_labelì´ "random"ì´ë©´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¤‘ ëœë¤ Pod ì‚­ì œ
#   - ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì§€ì •ëœ ì„œë¹„ìŠ¤(app label) ê¸°ì¤€ìœ¼ë¡œ Pod Kill ìˆ˜í–‰
# í‘œì¤€ ë³€ìˆ˜:
#   target_namespace: í…ŒìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ê¸°ë³¸ê°’: app)
#   target_app_label: ëŒ€ìƒ ì„œë¹„ìŠ¤ ì´ë¦„ ë˜ëŠ” 'random'
#   random_pod_kill_count: ëœë¤ ì‚­ì œ ì‹œ ì œê±°í•  Pod ìˆ˜ (ê¸°ë³¸ 1)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸ§© Safety Check - Confirm namespace  # Step 1: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²€ì¦
  ansible.builtin.assert:
    that:
      - target_namespace == "app"  # Chaos í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ app namespace ë‚´ì—ì„œë§Œ ìˆ˜í–‰
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app namespace ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 2ï¸âƒ£: ëŒ€ìƒ ì„œë¹„ìŠ¤ ì„ íƒ ë° ì•ˆë‚´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ” Display target service info
  ansible.builtin.debug:
    msg: |
      Chaos Pod Kill í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
      - ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
      - ëŒ€ìƒ ì„œë¹„ìŠ¤: {{ target_app_label }}
      - ë¬´ì‘ìœ„ ì‚­ì œ ê°œìˆ˜: {{ random_pod_kill_count | default(1) }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Case 1ï¸âƒ£: íŠ¹ì • ì„œë¹„ìŠ¤ Pod ê°•ì œ ì¢…ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ”§ Get pods of specific service
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} -l "app={{ target_app_label }}" \
      --no-headers -o custom-columns=":metadata.name"
  register: pod_list_raw
  when: target_app_label != "random"
  changed_when: false

- name: ğŸ“‹ Parse target pod list
  ansible.builtin.set_fact:
    pod_list: "{{ pod_list_raw.stdout_lines | select('match', '^[A-Za-z0-9-]+$') | list }}"
  when: target_app_label != "random"

- name: ğŸš« Abort if no pod found
  ansible.builtin.fail:
    msg: "âŒ ì„œë¹„ìŠ¤ '{{ target_app_label }}'ì˜ Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Chaos Kill ë¶ˆê°€ëŠ¥."
  when:
    - target_app_label != "random"
    - pod_list | length == 0

- name: ğŸ’€ Force delete all pods of the target service
  ansible.builtin.shell: |
    for pod in {{ pod_list | join(' ') }}; do
      kubectl delete pod $pod -n {{ target_namespace }} --grace-period=0 --force
    done
  when: target_app_label != "random"
  register: kill_result
  ignore_errors: yes

- name: ğŸ§¾ Log specific service kill result
  ansible.builtin.debug:
    msg: |
      âœ… ì„œë¹„ìŠ¤ {{ target_app_label }} Pod ê°•ì œ ì¢…ë£Œ ì™„ë£Œ
      ì„¸ë¶€ì •ë³´:
      {{ kill_result.stdout | default('No output') }}
  when: target_app_label != "random"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Case 2ï¸âƒ£: ë¬´ì‘ìœ„ Pod Kill (Chaos Monkey)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ² Define chaos target services
  ansible.builtin.set_fact:
    chaos_targets:
      - frontend
      - productcatalogservice
      - cartservice
      - checkoutservice
      - paymentservice
      - shippingservice
      - emailservice
      - redis-cart
  when: target_app_label == "random"

- name: ğŸ’£ Execute random pod kills across multiple services
  ansible.builtin.shell: |
    for i in $(seq 1 {{ random_pod_kill_count | default(1) }}); do
      svc=$(shuf -e {{ chaos_targets | join(" ") }} -n 1)
      pod=$(kubectl get pods -n {{ target_namespace }} -l app=$svc -o name | shuf -n 1)
      if [ -n "$pod" ]; then
        echo "[KILL] Target Service: $svc â†’ Pod: $pod"
        kubectl delete $pod -n {{ target_namespace }} --grace-period=0 --force
      else
        echo "[SKIP] No running pods found for $svc"
      fi
    done
  when: target_app_label == "random"
  register: random_kill_output
  ignore_errors: yes

- name: ğŸ§¾ Log random chaos results
  ansible.builtin.debug:
    msg: |
      ğŸ² ë¬´ì‘ìœ„ Pod ê°•ì œ ì¢…ë£Œ ê²°ê³¼:
      {{ random_kill_output.stdout | default('No output logged') }}
  when: target_app_label == "random"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 3ï¸âƒ£: ìƒíƒœ í™•ì¸ ë° ë¡œê·¸ ì¶œë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: â³ Wait for new pods to be rescheduled
  ansible.builtin.pause:
    seconds: 5

- name: ğŸ” Verify pod recovery status
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase!=Running
  register: non_running_pods
  changed_when: false
  ignore_errors: yes

- name: ğŸ§¾ Display recovery check result
  ansible.builtin.debug:
    msg: |
      âœ… Chaos í…ŒìŠ¤íŠ¸ ì™„ë£Œ.
      ë¹„ì •ìƒ ìƒíƒœì˜ Pod:
      {{ non_running_pods.stdout | default('None (All Running)') }}

~

