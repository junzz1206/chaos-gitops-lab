# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_kill/tasks/main.yml
# ëª©ì :
#   - ì§€ì •ëœ ì„œë¹„ìŠ¤(ë¼ë²¨ app=)ì˜ Pod ë° ìƒìœ„ ReplicaSet/Deployment ìë™ë³µêµ¬ ì™„ì „ ì°¨ë‹¨ í›„ ê°•ì œ ì‚­ì œ
#   - í™˜ê²½ë³€ìˆ˜ TARGET_SERVICES ê¸°ë°˜ ë‹¤ì¤‘ ì„œë¹„ìŠ¤ Chaos ì£¼ì… ì§€ì›
#   - ë¬´ì‘ìœ„ Chaos Monkey ëª¨ë“œ ì§€ì›
#   - disable_autorecover=true ì‹œ ReplicaSet, Deployment, StatefulSet scale 0
#   - chaos_duration ë™ì•ˆ ë³µêµ¬ ê¸ˆì§€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Safety Check - Confirm namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. Chaos í…ŒìŠ¤íŠ¸ëŠ” app namespace ë‚´ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ ({{ target_namespace }})"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 1ï¸âƒ£: Resolve target services dynamically
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target services (ENV â†’ vars.yml â†’ random)
  vars:
    env_target_services: "{{ lookup('env', 'TARGET_SERVICES') | default('', true) }}"
  ansible.builtin.set_fact:
    target_services_effective: >-
      {{
        (env_target_services.split(',') | map('trim') | list)
        if env_target_services | length > 0
        else
          (
            [ target_app_label ]
            if (target_app_label is defined and target_app_label != "random")
            else []
          )
      }}
  changed_when: false

- name: Display resolved service targets
  ansible.builtin.debug:
    msg: |
      ğŸ¯ Chaos ëŒ€ìƒ ì„œë¹„ìŠ¤ ê²°ì •
      - ENV(TARGET_SERVICES): {{ lookup('env', 'TARGET_SERVICES') | default('N/A') }}
      - Vars(target_app_label): {{ target_app_label | default('N/A') }}
      - Effective: {{ target_services_effective | default([]) }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 2ï¸âƒ£: Disable auto-recovery for each target
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable auto-recovery for selected services
  when:
    - disable_autorecover | default(true)
    - target_services_effective | length > 0
  ansible.builtin.shell: |
    for svc in {{ target_services_effective | join(' ') }}; do
      echo "[DISABLE] Scaling down controllers for $svc ..."
      kubectl get deploy -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      kubectl get rs -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      kubectl get sts -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      echo "[OK] $svc auto-recovery disabled."
    done
  register: disable_result
  ignore_errors: yes

- name: Show disable result
  ansible.builtin.debug:
    msg: "{{ disable_result.stdout | default('No output') }}"
  when: disable_result is defined

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 3ï¸âƒ£: Kill pods of each target service
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Kill pods of target services
  when:
    - target_services_effective | length > 0
  ansible.builtin.shell: |
    for svc in {{ target_services_effective | join(' ') }}; do
      echo "[CHAOS] Killing pods for $svc ..."
      kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true
    done
    echo "[âœ”] Service-level Pod kill complete."
  register: service_kill_result
  ignore_errors: yes

- name: Log service kill result
  ansible.builtin.debug:
    msg: |
      âœ… ì§€ì • ì„œë¹„ìŠ¤ Chaos ì£¼ì… ì™„ë£Œ
      {{ service_kill_result.stdout | default('No output') }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 4ï¸âƒ£: Random Chaos Mode (fallback)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute random chaos mode
  when: (target_services_effective | length == 0) or (target_app_label | default('random') == 'random')
  ansible.builtin.shell: |
    chaos_targets="frontend productcatalogservice cartservice checkoutservice paymentservice shippingservice emailservice redis-cart"
    echo "[RANDOM CHAOS] Executing random kills..."
    for i in $(seq 1 {{ random_pod_kill_count | default(1) }}); do
      svc=$(shuf -e $chaos_targets -n 1)
      echo "[TARGET] Randomly selected: $svc"
      kubectl get deploy -n {{ target_namespace }} -l app=$svc -o name | \
        xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0 || true
      pod=$(kubectl get pods -n {{ target_namespace }} -l app=$svc -o name | shuf -n 1)
      [ -n "$pod" ] && echo "[KILL] $svc â†’ $pod" && kubectl delete $pod -n {{ target_namespace }} --grace-period=0 --force
    done
    echo "[âœ”] Random chaos complete."
  register: random_kill_result
  ignore_errors: yes

- name: Show random chaos results
  ansible.builtin.debug:
    msg: |
      ğŸ² ë¬´ì‘ìœ„ Chaos ê²°ê³¼:
      {{ random_kill_result.stdout | default('No output') }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Step 5ï¸âƒ£: Post-chaos verification
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Wait for recovery period
  ansible.builtin.pause:
    seconds: "{{ chaos_duration | default(30) }}"

- name: Verify running pod status
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase!=Running
  register: non_running_pods
  changed_when: false
  ignore_errors: yes

- name: Display final status
  ansible.builtin.debug:
    msg: |
      âœ… Chaos í…ŒìŠ¤íŠ¸ ì™„ë£Œ
      ë¹„ì •ìƒ ìƒíƒœì˜ Pod:
      {{ non_running_pods.stdout | default('None (All Running)') }}

