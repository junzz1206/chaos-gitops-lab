# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_pod/tasks/main.yml
# ëª©ì :
#   - internal: Ansible ë˜ëŠ” CI/CDì—ì„œ ì§ì ‘ Pod ì‚­ì œ
#   - external: ë³„ë„ chaos podì´ kubectl delete ì‹¤í–‰
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ fallback
#   - Ansible ì‹¤í–‰ ì‹œ pod_kill_targets.yml ì‚¬ìš©
#   - CI/CD ì‹¤í–‰ ì‹œ í™˜ê²½ë³€ìˆ˜ TARGET_PODSë¡œ ì„œë¹„ìŠ¤ ì§€ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0ï¸âƒ£ Safety Checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Validate namespace
  ansible.builtin.assert:
    that:
      - target_namespace == "app"
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ë° ê¸°ë³¸ê°’ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Initialize chaos configuration
  ansible.builtin.set_fact:
    chaos_log_path_final: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"
    chaos_duration_safe: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(15), true) }}"
    random_pod_kill_count_safe: "{{ lookup('env','RANDOM_POD_KILL_COUNT') | default(random_pod_kill_count | default(2), true) }}"
    kill_mode: "{{ lookup('env','KILL_MODE') | default(kill_mode | default('internal'), true) }}"
    env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"
  changed_when: false

- name: Show configuration summary
  ansible.builtin.debug:
    msg: |
      âš™ï¸ Pod Kill Chaos Configuration
      - Mode: {{ kill_mode }}
      - Duration: {{ chaos_duration_safe }}s
      - Namespace: {{ target_namespace }}
      - ENV Target Pods: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ íƒ€ê²Ÿ Pod í•´ì„ (internal + external ë¶„ê¸°)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target pods (Ansible vs CI/CD)
  block:
    # â”€â”€â”€â”€â”€ Internal ëª¨ë“œ: ê¸°ì¡´ ë¡œì§ ìœ ì§€ â”€â”€â”€â”€â”€
    - name: Load from ENV or pod_kill_targets.yml (internal)
      when: kill_mode == "internal"
      block:
        - name: Load from ENV
          when: env_target_pods | length > 0
          ansible.builtin.set_fact:
            target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"
          changed_when: false

        - name: Load from pod_kill_targets.yml (fallback)
          when:
            - (target_pod_names is not defined or target_pod_names | length == 0)
            - lookup('file', '{{ playbook_dir }}/../../pod_kill_targets.yml', errors='ignore') is not none
          ansible.builtin.include_vars:
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"
            name: pod_targets_fallback

        - name: Apply fallback list
          when:
            - target_pod_names is not defined or target_pod_names | length == 0
            - pod_targets_fallback is defined and pod_targets_fallback.pod_targets is defined
          ansible.builtin.set_fact:
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"
          changed_when: false

        - name: Debug targets (internal)
          ansible.builtin.debug:
            msg: |
              ğŸ¯ Internal Pod Kill Targets
              - From ENV: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}
              - Effective: {{ target_pod_names | default([]) }}

    # â”€â”€â”€â”€â”€ External ëª¨ë“œ: CI/CD vs Ansible ë¶„ë¦¬ â”€â”€â”€â”€â”€
    - name: Determine external targets (CI/CD)
      when: kill_mode == "external" and env_target_pods | length > 0
      ansible.builtin.set_fact:
        target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"
      changed_when: false

    - name: Determine external targets (Ansible local)
      when: kill_mode == "external" and env_target_pods | length == 0
      block:
        - name: Include pod_kill_targets.yml (Ansible fallback)
          ansible.builtin.include_vars:
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"
            name: pod_targets_fallback
        - name: Set external targets from file
          ansible.builtin.set_fact:
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"
          changed_when: false
        - name: Debug targets (external local)
          ansible.builtin.debug:
            msg: |
              ğŸ¯ External Pod Kill Targets (Ansible)
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Disable auto-recovery (ì„ íƒì )
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable ReplicaSets if requested
  when: disable_autorecover | default(false)
  ansible.builtin.shell: |
    echo "[INFO] Disabling ReplicaSets..."
    kubectl get rs -n {{ target_namespace }} -o name | xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0
  ignore_errors: yes

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Internal Pod Kill
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Kill pods directly (internal)
  when: kill_mode == "internal"
  ansible.builtin.shell: |
    if [ "{{ target_pod_names | default('') }}" != "" ]; then
      PODS="{{ target_pod_names | join(' ') }}"
    else
      PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ random_pod_kill_count_safe }})
    fi
    echo "[INFO] Deleting pods: $PODS"
    for p in $PODS; do
      kubectl delete "$p" -n {{ target_namespace }} --grace-period=0 --force || echo "[WARN] Failed to delete $p"
    done
  register: internal_kill_result
  ignore_errors: yes
  changed_when: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ Fallback â€” internal ì‹¤íŒ¨ ì‹œ external ì „í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Switch to external if internal fails
  when: kill_mode == "internal" and internal_kill_result.rc != 0
  ansible.builtin.set_fact:
    kill_mode: "external"
  changed_when: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ External Mode â€” helper podì„ í†µí•œ ì‚­ì œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute external pod kill per service
  when: kill_mode == "external"
  ansible.builtin.shell: |
    for svc in {{ target_pod_names | join(' ') }}; do
      echo "[EXTERNAL] Launching chaos pod for $svc..."
      kubectl run chaos-podkill-$svc \
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \
        --overrides='{
          "spec": {
            "containers": [{
              "name": "podkill",
              "image": "nicolaka/netshoot:latest",
              "command": ["/bin/sh","-c"],
              "args": [
                "echo \"[CHAOS] Deleting pod(s) for $svc ...\"; \
                 kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force; \
                 sleep {{ chaos_duration_safe }}; \
                 echo \"[DONE] Chaos complete for $svc.\";"
              ]
            }]
          }
        }' || true
    done
  register: external_result
  ignore_errors: yes
  changed_when: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7ï¸âƒ£ ë¡œê·¸ ê¸°ë¡ ë° ì¢…ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Append chaos result to log
  ansible.builtin.lineinfile:
    path: "{{ chaos_log_path_final }}"
    create: yes
    line: |
      [{{ ansible_date_time.iso8601 }}] PodChaos ns={{ target_namespace }} mode={{ kill_mode }} targets={{ target_pod_names | join(',') }} duration={{ chaos_duration_safe }}s
  become: true

- name: Final message
  ansible.builtin.debug:
    msg: |
      âœ… Pod Chaos Completed
      - Mode: {{ kill_mode }}
      - Targets: {{ target_pod_names | join(', ') }}
      - Duration: {{ chaos_duration_safe }}s
      - Log: {{ chaos_log_path_final }}
