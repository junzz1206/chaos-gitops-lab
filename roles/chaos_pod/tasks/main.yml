# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_pod/tasks/main.yml  # íŒŒì¼ ê²½ë¡œ
# ëª©ì :  
#   - internal: Ansible ë˜ëŠ” CI/CDì—ì„œ ì§ì ‘ Pod ì‚­ì œ (ë‚´ë¶€ ì‹¤í–‰)
#   - external: ë³„ë„ chaos podì´ kubectl delete ì‹¤í–‰ (ì™¸ë¶€ ì‹¤í–‰)
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ fallback (ì•ˆì •ì  ë³µì› êµ¬ì¡°)
#   - Ansible ì‹¤í–‰ ì‹œ pod_kill_targets.ymlì€ external ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©
#   - CI/CD ì‹¤í–‰ ì‹œ TARGET_PODS í™˜ê²½ë³€ìˆ˜ë¡œ ì„œë¹„ìŠ¤ ì§€ì •
#   - ëª¨ë“  chaos podì— ê³µí†µ ë¼ë²¨(app.kubernetes.io/*) ì ìš©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0ï¸âƒ£ Safety Checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Validate namespace  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì „ì„± ê²€ì¦ ì‘ì—… ì •ì˜
  ansible.builtin.assert:  # assert ëª¨ë“ˆ ì‚¬ìš©
    that:  # ê²€ì‚¬ ì¡°ê±´ ì •ì˜
      - target_namespace == "app"  # ChaosëŠ” ë°˜ë“œì‹œ app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ì‹¤í–‰ ê°€ëŠ¥
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."  # ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ"  # ì„±ê³µ ì‹œ ë©”ì‹œì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ë° ê¸°ë³¸ê°’ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Initialize chaos configuration  # Chaos ì‹¤í–‰ ê¸°ë³¸ ë³€ìˆ˜ ì´ˆê¸°í™”
  ansible.builtin.set_fact:  # set_fact ëª¨ë“ˆ ì‚¬ìš©
    chaos_log_path_final: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"  # Chaos ë¡œê·¸ ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
    chaos_duration_safe: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(15), true) }}"  # Chaos ìœ ì§€ ì‹œê°„
    random_pod_kill_count_safe: "{{ lookup('env','RANDOM_POD_KILL_COUNT') | default(random_pod_kill_count | default(2), true) }}"  # ë¬´ì‘ìœ„ Pod ì‚­ì œ ìˆ˜
    kill_mode: "{{ lookup('env','KILL_MODE') | default(kill_mode | default('internal'), true) }}"  # ì‹¤í–‰ ëª¨ë“œ ê²°ì •
    env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"  # CI/CD í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ íƒ€ê²Ÿ
  changed_when: false  # ìƒíƒœ ë³€ê²½ ì—†ìŒìœ¼ë¡œ í‘œì‹œ

- name: Show configuration summary  # ì„¤ì • ì •ë³´ ì¶œë ¥
  ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
    msg: |  # ë‹¤ì¤‘ ë¼ì¸ ì¶œë ¥
      âš™ï¸ Pod Kill Chaos Configuration  # ì„¤ì • ìš”ì•½ ì‹œì‘
      - Mode: {{ kill_mode }}  # ì‹¤í–‰ ëª¨ë“œ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # Chaos ì§€ì† ì‹œê°„ í‘œì‹œ
      - Namespace: {{ target_namespace }}  # ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‘œì‹œ
      - ENV Target Pods: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # í™˜ê²½ë³€ìˆ˜ ì§€ì • ì—¬ë¶€ í‘œì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ íƒ€ê²Ÿ Pod í•´ì„ (internal / external ë¶„ë¦¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target pods (Ansible vs CI/CD)  # Pod íƒ€ê²Ÿ ë¡œë“œ ë‹¨ê³„
  block:  # ë‹¤ì¤‘ ì‘ì—… ë¸”ë¡ ì‹œì‘

    - name: Load internal targets from ENV only  # internal ëª¨ë“œ ì „ìš©
      when: kill_mode == "internal"  # internal ì¡°ê±´
      block:  # ë‚´ë¶€ ë¸”ë¡ ì‹œì‘
        - name: Load from ENV  # í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œ
          ansible.builtin.set_fact:  # set_fact ì‚¬ìš©
            target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list if env_target_pods | length > 0 else [] }}"  # ì‰¼í‘œ ê¸°ì¤€ ë¶„ë¦¬
          changed_when: false  # ìƒíƒœ ë³€ê²½ ì—†ìŒ

        - name: Fail if no internal targets specified  # ë‚´ë¶€ íƒ€ê²Ÿ ëˆ„ë½ ì‹œ ì‹¤íŒ¨
          ansible.builtin.fail:  # fail ëª¨ë“ˆ ì‚¬ìš©
            msg: "âŒ internal ëª¨ë“œì—ì„œëŠ” TARGET_PODS í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” CLI ì¸ìë¡œ ëŒ€ìƒ Podì„ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤."  # ì˜¤ë¥˜ ë©”ì‹œì§€
          when: target_pod_names | length == 0  # ì¡°ê±´ ê²€ì‚¬

        - name: Debug internal targets  # internal íƒ€ê²Ÿ í™•ì¸
          ansible.builtin.debug:  # debug ì‚¬ìš©
            msg: |  # ë©€í‹°ë¼ì¸ ì¶œë ¥
              ğŸ¯ Internal Pod Kill Targets  # ë‚´ë¶€ íƒ€ê²Ÿ í‘œì‹œ
              - From ENV: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # í™˜ê²½ë³€ìˆ˜ í‘œì‹œ
              - Effective: {{ target_pod_names | default([]) }}  # ìµœì¢… ëª©ë¡ í‘œì‹œ

    - name: Determine external targets (CI/CD)  # external(CI/CD) íƒ€ê²Ÿ
      when: kill_mode == "external" and env_target_pods | length > 0  # ì¡°ê±´
      ansible.builtin.set_fact:  # set_fact ì‚¬ìš©
        target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"  # ì‰¼í‘œ êµ¬ë¶„
      changed_when: false  # ë³€ê²½ ì—†ìŒ

    - name: Determine external targets (Ansible local)  # external(ë¡œì»¬)
      when: kill_mode == "external" and env_target_pods | length == 0  # ì¡°ê±´
      block:  # ë¸”ë¡ ì‹œì‘
        - name: Include pod_kill_targets.yml (Ansible fallback)  # ê¸°ë³¸ íƒ€ê²Ÿ ë¡œë“œ
          ansible.builtin.include_vars:  # include_vars ì‚¬ìš©
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"  # ê²½ë¡œ ì§€ì •
            name: pod_targets_fallback  # ë³€ìˆ˜ ì´ë¦„ ì§€ì •
        - name: Set external targets from file  # íŒŒì¼ ê¸°ë°˜ íƒ€ê²Ÿ ì„¤ì •
          ansible.builtin.set_fact:  # set_fact ì‚¬ìš©
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"  # ì ìš©
          changed_when: false  # ë³€ê²½ ì—†ìŒ
        - name: Debug external targets  # ì™¸ë¶€ íƒ€ê²Ÿ ì¶œë ¥
          ansible.builtin.debug:  # debug ì‚¬ìš©
            msg: |  # ë©€í‹°ë¼ì¸ ì¶œë ¥
              ğŸ¯ External Pod Kill Targets (Ansible)  # ì™¸ë¶€ íƒ€ê²Ÿ í‘œì‹œ
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}  # íŒŒì¼ ë‚´ìš© í‘œì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Disable auto-recovery (ì„ íƒì )
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable ReplicaSets if requested  # ìë™ ë³µêµ¬ ì°¨ë‹¨
  when: disable_autorecover | default(false)  # ì¡°ê±´
  ansible.builtin.shell: |  # ì…¸ ì‹¤í–‰
    echo "[INFO] Disabling ReplicaSets..."  # ì‹œì‘ ë¡œê·¸
    kubectl get rs -n {{ target_namespace }} -o name | xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0  # ìŠ¤ì¼€ì¼ 0
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Internal Pod Kill
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Kill pods directly (internal)  # ë‚´ë¶€ ëª¨ë“œ ì‹¤í–‰
  when: kill_mode == "internal"  # ì¡°ê±´
  ansible.builtin.shell: |  # ì…¸ ì‹¤í–‰
    if [ "{{ target_pod_names | default('') }}" != "" ]; then  # íƒ€ê²Ÿ ì§€ì • ì—¬ë¶€ í™•ì¸
      PODS="{{ target_pod_names | join(' ') }}"  # ì§€ì •ëœ Pod ëª©ë¡ ì—°ê²°
    else  # íƒ€ê²Ÿ ì—†ì„ ë•Œ
      PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ random_pod_kill_count_safe }})  # ë¬´ì‘ìœ„ ì„ íƒ
    fi  # ì¡°ê±´ë¬¸ ì¢…ë£Œ
    echo "[INFO] Deleting pods: $PODS"  # ë¡œê·¸ ì¶œë ¥
    for p in $PODS; do  # ë°˜ë³µë¬¸ ì‹œì‘
      kubectl delete "$p" -n {{ target_namespace }} --grace-period=0 --force || echo "[WARN] Failed to delete $p"  # ê°•ì œ ì‚­ì œ
    done  # ë°˜ë³µ ì¢…ë£Œ
  register: internal_kill_result  # ê²°ê³¼ ì €ì¥
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ Fallback â€” internal ì‹¤íŒ¨ ì‹œ external ì „í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Switch to external if internal fails  # internal ì‹¤íŒ¨ ì‹œ fallback
  when: kill_mode == "internal" and internal_kill_result.rc != 0  # ì¡°ê±´
  ansible.builtin.set_fact:  # ë³€ìˆ˜ ì„¤ì •
    kill_mode: "external"  # external ì „í™˜
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ External Mode â€” helper podì„ í†µí•œ ì‚­ì œ (ê³µí†µ ë¼ë²¨ ì ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute external pod kill per service  # ì™¸ë¶€ ëª¨ë“œ ì‹¤í–‰
  when: kill_mode == "external"  # ì¡°ê±´
  ansible.builtin.shell: |  # ì…¸ ì‹¤í–‰
    for svc in {{ target_pod_names | join(' ') }}; do  # ì„œë¹„ìŠ¤ ë°˜ë³µ
      echo "[EXTERNAL] Launching chaos pod for ${svc}..."  # ë¡œê·¸ ì¶œë ¥
      SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # UUID ì ‘ë¯¸ì‚¬
      if [ "$svc" = "frontend" ]; then  # tier ë¶„ê¸°
        TIER="frontend"  # í”„ë¡ íŠ¸ì—”ë“œ
      elif [ "$svc" = "redis-cart" ]; then  # redis-cart
        TIER="data"  # ë°ì´í„° ê³„ì¸µ
      else  # ë‚˜ë¨¸ì§€
        TIER="backend"  # ë°±ì—”ë“œ
      fi  # ì¡°ê±´ ì¢…ë£Œ
      LABELS="app=\${svc},app.kubernetes.io/name=\${svc},app.kubernetes.io/part-of=online-boutique-chaos-lab,app.kubernetes.io/tier=\${TIER},app.kubernetes.io/component=podkill-chaos"  # ë¼ë²¨ í‘œì¤€ ì ìš©
      kubectl run chaos-podkill-\${svc}-\${SUFFIX} \  # chaos pod ì‹¤í–‰
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \  # ì´ë¯¸ì§€ ë° ë„¤ì„ìŠ¤í˜ì´ìŠ¤
        --labels="\${LABELS}" \  # ë¼ë²¨ ë¶€ì—¬
        --overrides='{  # JSON ì˜¤ë²„ë¼ì´ë“œ ì‹œì‘
          "spec": {  # ìŠ¤í™ ì •ì˜
            "containers": [{  # ì»¨í…Œì´ë„ˆ ë°°ì—´ ì‹œì‘
              "name": "podkill",  # ì´ë¦„
              "image": "nicolaka/netshoot:latest",  # ì´ë¯¸ì§€
              "command": ["/bin/sh","-c"],  # ì»¤ë§¨ë“œ
              "args": [  # ëª…ë ¹ ì¸ì
                "set -eux; \
                 echo \"[CHAOS] Deleting pod(s) for \${svc} ...\"; \
                 kubectl delete pod -n {{ target_namespace }} -l app=\${svc} --grace-period=0 --force || true; \
                 sleep {{ chaos_duration_safe }}; \
                 echo \"[RECOVERY] Chaos complete for \${svc}.\"; \
                 echo \"[SELF-DELETE] Removing chaos pod...\"; \
                 kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;"
              ]  # args ì¢…ë£Œ
            }]  # containers ì¢…ë£Œ
          }  # spec ì¢…ë£Œ
        }' || true  # ì‹¤íŒ¨ ë¬´ì‹œ
    done  # ë°˜ë³µ ì¢…ë£Œ
  register: external_result  # ê²°ê³¼ ì €ì¥
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7ï¸âƒ£ ë¡œê·¸ ê¸°ë¡ ë° ì¢…ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Append chaos result to log  # ë¡œê·¸ ì‘ì„±
  ansible.builtin.lineinfile:  # íŒŒì¼ ì‘ì„± ëª¨ë“ˆ
    path: "{{ chaos_log_path_final }}"  # ë¡œê·¸ ê²½ë¡œ
    create: yes  # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
    line: |  # ë¡œê·¸ ë‚´ìš©
      [{{ ansible_date_time.iso8601 }}] PodChaos ns={{ target_namespace }} mode={{ kill_mode }} targets={{ target_pod_names | join(',') }} duration={{ chaos_duration_safe }}s  # ì‹¤í–‰ ë¡œê·¸
  become: true  # ë£¨íŠ¸ ê¶Œí•œ

- name: Final message  # ìµœì¢… ì¶œë ¥
  ansible.builtin.debug:  # ë””ë²„ê·¸ ëª¨ë“ˆ
    msg: |  # ë‹¤ì¤‘ ì¶œë ¥
      âœ… Pod Chaos Completed  # ì™„ë£Œ ë©”ì‹œì§€
      - Mode: {{ kill_mode }}  # ëª¨ë“œ í‘œì‹œ
      - Targets: {{ target_pod_names | join(', ') }}  # íƒ€ê²Ÿ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # ì§€ì† ì‹œê°„ í‘œì‹œ
      - Log: {{ chaos_log_path_final }}  # ë¡œê·¸ ê²½ë¡œ í‘œì‹œ
