# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_pod/tasks/main.yml  # íŒŒì¼ ê²½ë¡œ
# ëª©ì :  # íŒŒì¼ì˜ ì—­í•  ìš”ì•½
#   - internal: Ansible ë˜ëŠ” CI/CDì—ì„œ ì§ì ‘ Pod ì‚­ì œ  # ë‚´ë¶€ ëª¨ë“œ
#   - external: ë³„ë„ chaos podì´ kubectl delete ì‹¤í–‰  # ì™¸ë¶€ ëª¨ë“œ
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ fallback  # ì‹¤íŒ¨ ì‹œ ìë™ ì „í™˜
#   - Ansible ì‹¤í–‰ ì‹œ pod_kill_targets.yml ì‚¬ìš©  # Ansible ê¸°ë°˜ ì§€ì •
#   - CI/CD ì‹¤í–‰ ì‹œ í™˜ê²½ë³€ìˆ˜ TARGET_PODSë¡œ ì„œë¹„ìŠ¤ ì§€ì •  # CI/CD ê¸°ë°˜ ì§€ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0ï¸âƒ£ Safety Checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Validate namespace  # ì•ˆì „ì„± ê²€ì¦
  ansible.builtin.assert:  # assert ëª¨ë“ˆ ì‚¬ìš©
    that:  # ê²€ì¦ ì¡°ê±´
      - target_namespace == "app"  # ë°˜ë“œì‹œ app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ í—ˆìš©
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."  # ì‹¤íŒ¨ ë©”ì‹œì§€
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ"  # ì„±ê³µ ë©”ì‹œì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ë° ê¸°ë³¸ê°’ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Initialize chaos configuration  # Chaos ì‹¤í–‰ í™˜ê²½ êµ¬ì„±
  ansible.builtin.set_fact:  # ë³€ìˆ˜ ì„¤ì •
    chaos_log_path_final: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"  # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
    chaos_duration_safe: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(15), true) }}"  # Chaos ìœ ì§€ ì‹œê°„
    random_pod_kill_count_safe: "{{ lookup('env','RANDOM_POD_KILL_COUNT') | default(random_pod_kill_count | default(2), true) }}"  # ë¬´ì‘ìœ„ kill ê°œìˆ˜
    kill_mode: "{{ lookup('env','KILL_MODE') | default(kill_mode | default('internal'), true) }}"  # ì‹¤í–‰ ëª¨ë“œ (internal/external)
    env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"  # CI/CD í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ íƒ€ê²Ÿ
  changed_when: false  # ë‹¨ìˆœ ë³€ìˆ˜ ì„¤ì • â†’ ë³€ê²½ ì•„ë‹˜

- name: Show configuration summary  # ì„¤ì •ê°’ ì¶œë ¥
  ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
    msg: |  # ë©€í‹°ë¼ì¸ ë©”ì‹œì§€ ì¶œë ¥
      âš™ï¸ Pod Kill Chaos Configuration
      - Mode: {{ kill_mode }}  # ì‹¤í–‰ ëª¨ë“œ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # ì§€ì† ì‹œê°„ í‘œì‹œ
      - Namespace: {{ target_namespace }}  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‘œì‹œ
      - ENV Target Pods: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •ëœ íƒ€ê²Ÿ í‘œì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ íƒ€ê²Ÿ Pod í•´ì„ (internal + external ë¶„ê¸°)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target pods (Ansible vs CI/CD)  # íƒ€ê²Ÿ Pod ê³„ì‚° ë¸”ë¡
  block:  # ë‹¤ì¤‘ ì¡°ê±´ ì²˜ë¦¬
    # â”€â”€â”€â”€â”€ Internal ëª¨ë“œ â”€â”€â”€â”€â”€
    - name: Load from ENV or pod_kill_targets.yml (internal)  # internalì¼ ë•Œ íƒ€ê²Ÿ ë¡œë“œ
      when: kill_mode == "internal"  # internal ëª¨ë“œ ì¡°ê±´
      block:  # ë‚´ë¶€ ë¸”ë¡
        - name: Load from ENV  # í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
          when: env_target_pods | length > 0  # TARGET_PODS ì¡´ì¬ ì‹œ
          ansible.builtin.set_fact:  # ë³€ìˆ˜ ì„¤ì •
            target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"  # ì‰¼í‘œ êµ¬ë¶„ â†’ ë¦¬ìŠ¤íŠ¸ ë³€í™˜
          changed_when: false  # ë‹¨ìˆœ ì„¤ì •

        - name: Load from pod_kill_targets.yml (fallback)  # íŒŒì¼ ê¸°ë°˜ fallback
          when:  # ì¡°ê±´ ì •ì˜
            - (target_pod_names is not defined or target_pod_names | length == 0)  # ENV ë¯¸ì •ì˜
            - lookup('file', '{{ playbook_dir }}/../../pod_kill_targets.yml', errors='ignore') is not none  # íŒŒì¼ ì¡´ì¬ í™•ì¸
          ansible.builtin.include_vars:  # ë³€ìˆ˜ í¬í•¨
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"  # ëŒ€ìƒ íŒŒì¼ ê²½ë¡œ
            name: pod_targets_fallback  # ë¡œë“œëœ ë³€ìˆ˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì •

        - name: Apply fallback list  # fallback ê°’ ì ìš©
          when:  # ì¡°ê±´
            - target_pod_names is not defined or target_pod_names | length == 0  # ENV ë¯¸ì •ì˜
            - pod_targets_fallback is defined and pod_targets_fallback.pod_targets is defined  # fallback ê°’ ì¡´ì¬
          ansible.builtin.set_fact:  # ë³€ìˆ˜ ì ìš©
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"  # fallback ì ìš©
          changed_when: false  # ë³€ê²½ ì•„ë‹˜

        - name: Debug targets (internal)  # internal íƒ€ê²Ÿ ì¶œë ¥
          ansible.builtin.debug:  # debug ì¶œë ¥
            msg: |  # ë©€í‹°ë¼ì¸
              ğŸ¯ Internal Pod Kill Targets
              - From ENV: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # ENV
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}  # íŒŒì¼
              - Effective: {{ target_pod_names | default([]) }}  # ìµœì¢… ê²°ê³¼

    # â”€â”€â”€â”€â”€ External ëª¨ë“œ â”€â”€â”€â”€â”€
    - name: Determine external targets (CI/CD)  # CI/CD í™˜ê²½ external ì²˜ë¦¬
      when: kill_mode == "external" and env_target_pods | length > 0  # external + ENV ì¡´ì¬
      ansible.builtin.set_fact:  # ë³€ìˆ˜ ì„¤ì •
        target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"  # ì‰¼í‘œ êµ¬ë¶„ ì²˜ë¦¬
      changed_when: false  # ë³€ê²½ ì•„ë‹˜

    - name: Determine external targets (Ansible local)  # Ansible ì‹¤í–‰ ì‹œ external ì²˜ë¦¬
      when: kill_mode == "external" and env_target_pods | length == 0  # external + ENV ì—†ìŒ
      block:  # íŒŒì¼ ê¸°ë°˜ ì²˜ë¦¬
        - name: Include pod_kill_targets.yml (Ansible fallback)  # fallback ë¡œë“œ
          ansible.builtin.include_vars:  # include_vars ì‚¬ìš©
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"  # íŒŒì¼ ê²½ë¡œ
            name: pod_targets_fallback  # ë„¤ì„ ì§€ì •
        - name: Set external targets from file  # ë³€ìˆ˜ ì„¤ì •
          ansible.builtin.set_fact:  # set_fact ì‚¬ìš©
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"  # fallback ì ìš©
          changed_when: false  # ë³€ê²½ ì•„ë‹˜
        - name: Debug targets (external local)  # ê²°ê³¼ ì¶œë ¥
          ansible.builtin.debug:  # debug ëª¨ë“ˆ
            msg: |  # ë©€í‹°ë¼ì¸
              ğŸ¯ External Pod Kill Targets (Ansible)
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}  # íŒŒì¼ì—ì„œ ì½ì€ ëª©ë¡

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Disable auto-recovery (ì„ íƒì )
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable ReplicaSets if requested  # auto-recovery ì°¨ë‹¨
  when: disable_autorecover | default(false)  # ì¡°ê±´ì´ trueì¼ ê²½ìš°ë§Œ ì‹¤í–‰
  ansible.builtin.shell: |  # ì…¸ ëª…ë ¹ ì‹¤í–‰
    echo "[INFO] Disabling ReplicaSets..."  # ë¡œê·¸ ì¶œë ¥
    kubectl get rs -n {{ target_namespace }} -o name | xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0  # ReplicaSet 0ìœ¼ë¡œ ì¶•ì†Œ
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Internal Pod Kill
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Kill pods directly (internal)  # ë‚´ë¶€ ëª¨ë“œì—ì„œ ì§ì ‘ ì‚­ì œ
  when: kill_mode == "internal"  # internal ëª¨ë“œ ì¡°ê±´
  ansible.builtin.shell: |  # ì…¸ ì‹¤í–‰
    if [ "{{ target_pod_names | default('') }}" != "" ]; then  # íƒ€ê²Ÿì´ ì •ì˜ëœ ê²½ìš°
      PODS="{{ target_pod_names | join(' ') }}"  # ì§ì ‘ ì‚¬ìš©
    else  # ì •ì˜ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°
      PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ random_pod_kill_count_safe }})  # ë¬´ì‘ìœ„ Pod ì„ íƒ
    fi
    echo "[INFO] Deleting pods: $PODS"  # ë¡œê·¸ ì¶œë ¥
    for p in $PODS; do  # ê° Pod ë°˜ë³µ ì‚­ì œ
      kubectl delete "$p" -n {{ target_namespace }} --grace-period=0 --force || echo "[WARN] Failed to delete $p"  # ê°•ì œ ì‚­ì œ
    done
  register: internal_kill_result  # ê²°ê³¼ ì €ì¥
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ Fallback â€” internal ì‹¤íŒ¨ ì‹œ external ì „í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Switch to external if internal fails  # internal ì‹¤íŒ¨ ì‹œ external ëª¨ë“œë¡œ ì „í™˜
  when: kill_mode == "internal" and internal_kill_result.rc != 0  # ì‹¤íŒ¨ ì¡°ê±´
  ansible.builtin.set_fact:  # ë³€ìˆ˜ ë³€ê²½
    kill_mode: "external"  # external ì „í™˜
  changed_when: true  # ë³€ê²½ í‘œì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ External Mode â€” helper podì„ í†µí•œ ì‚­ì œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute external pod kill per service  # external pod ìƒì„± ë° ì‚­ì œ ìˆ˜í–‰
  when: kill_mode == "external"  # external ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
  ansible.builtin.shell: |  # ì…¸ ì‹¤í–‰
    for svc in {{ target_pod_names | join(' ') }}; do  # ê° ì„œë¹„ìŠ¤ ë°˜ë³µ
      echo "[EXTERNAL] Launching chaos pod for $svc..."  # ì‹¤í–‰ ë¡œê·¸ ì¶œë ¥
      SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # 6ìë¦¬ UUID ìƒì„± (ì¤‘ë³µ ë°©ì§€)
      kubectl run chaos-podkill-$svc-$SUFFIX \  # Pod ì´ë¦„ì— ì ‘ë¯¸ì‚¬ ì¶”ê°€
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì •
        --overrides='{  # Pod ìŠ¤í™ ì˜¤ë²„ë¼ì´ë“œ ì‹œì‘
          "spec": {
            "containers": [{  # ì»¨í…Œì´ë„ˆ ë°°ì—´
              "name": "podkill",  # ì»¨í…Œì´ë„ˆ ì´ë¦„
              "image": "nicolaka/netshoot:latest",  # ì´ë¯¸ì§€ ì§€ì •
              "command": ["/bin/sh","-c"],  # ì»¤ë§¨ë“œ ì‹¤í–‰
              "args": [  # ì‹¤í–‰ ì¸ì
                "set -eux; \  # ì˜¤ë¥˜ ì‹œ ì¤‘ë‹¨ + verbose ì¶œë ¥
                 echo \"[CHAOS] Deleting pod(s) for $svc ...\"; \  # ì‹œì‘ ë¡œê·¸
                 kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true; \  # ì‹¤ì œ ì‚­ì œ
                 sleep {{ chaos_duration_safe }}; \  # Chaos ìœ ì§€
                 echo \"[RECOVERY] Chaos complete for $svc.\"; \  # ì™„ë£Œ ë¡œê·¸
                 kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;"  # ìê¸° ìì‹  pod ì‚­ì œ
              ]  # args ì¢…ë£Œ
            }]  # containers ì¢…ë£Œ
          }  # spec ì¢…ë£Œ
        }' || true  # ì‹¤íŒ¨ ë¬´ì‹œ
    done  # forë¬¸ ì¢…ë£Œ
  register: external_result  # ì‹¤í–‰ ê²°ê³¼ ì €ì¥
  ignore_errors: yes  # ì˜¤ë¥˜ ë¬´ì‹œ
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7ï¸âƒ£ ë¡œê·¸ ê¸°ë¡ ë° ì¢…ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Append chaos result to log  # Chaos ê²°ê³¼ ë¡œê·¸ ì¶”ê°€
  ansible.builtin.lineinfile:  # lineinfile ëª¨ë“ˆ ì‚¬ìš©
    path: "{{ chaos_log_path_final }}"  # ë¡œê·¸ ê²½ë¡œ
    create: yes  # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
    line: |  # ë¡œê·¸ í•œ ì¤„ ì‘ì„±
      [{{ ansible_date_time.iso8601 }}] PodChaos ns={{ target_namespace }} mode={{ kill_mode }} targets={{ target_pod_names | join(',') }} duration={{ chaos_duration_safe }}s
  become: true  # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ê¸°ë¡

- name: Final message  # ìµœì¢… ê²°ê³¼ ì¶œë ¥
  ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
    msg: |  # ë©€í‹°ë¼ì¸ ì¶œë ¥
      âœ… Pod Chaos Completed
      - Mode: {{ kill_mode }}  # ì‹¤í–‰ ëª¨ë“œ í‘œì‹œ
      - Targets: {{ target_pod_names | join(', ') }}  # ëŒ€ìƒ ëª©ë¡ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # ì§€ì† ì‹œê°„ í‘œì‹œ
      - Log: {{ chaos_log_path_final }}  # ë¡œê·¸ ê²½ë¡œ í‘œì‹œ

