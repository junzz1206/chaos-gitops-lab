# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íŒŒì¼: roles/chaos_pod/tasks/main.yml  # íŒŒì¼ ê²½ë¡œ
# ëª©ì :  
#   - internal: Ansible ë˜ëŠ” CI/CDì—ì„œ ì§ì ‘ Pod ì‚­ì œ (ë‚´ë¶€ ì‹¤í–‰)
#   - external: ë³„ë„ chaos podì´ kubectl delete ì‹¤í–‰ (ì™¸ë¶€ ì‹¤í–‰)
#   - internal ì‹¤íŒ¨ ì‹œ ìë™ fallback (ì•ˆì •ì  ë³µì› êµ¬ì¡°)
#   - Ansible ì‹¤í–‰ ì‹œ pod_kill_targets.ymlì€ external ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©
#   - CI/CD ì‹¤í–‰ ì‹œ TARGET_PODS í™˜ê²½ë³€ìˆ˜ë¡œ ì„œë¹„ìŠ¤ ì§€ì •
#   - ëª¨ë“  chaos podì— ê³µí†µ ë¼ë²¨(app.kubernetes.io/*) ì ìš©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0ï¸âƒ£ Safety Checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Validate namespace  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì „ì„± ê²€ì¦ ì‘ì—… ì •ì˜
  ansible.builtin.assert:  # assert ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ì¡°ê±´ í™•ì¸
    that:  # ê²€ì‚¬í•  ì¡°ê±´ ëª©ë¡ ì •ì˜
      - target_namespace == "app"  # ChaosëŠ” ë°˜ë“œì‹œ app ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ì—ì„œë§Œ ì‹¤í–‰ ê°€ëŠ¥
    fail_msg: "âŒ namespaceê°€ 'app'ì´ ì•„ë‹™ë‹ˆë‹¤. ChaosëŠ” app ë‚´ì—ì„œë§Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤."  # ì‹¤íŒ¨ ì‹œ ì¶œë ¥ ë©”ì‹œì§€
    success_msg: "âœ… namespace í™•ì¸ ì™„ë£Œ"  # ì„±ê³µ ì‹œ ì¶œë ¥ ë©”ì‹œì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ í™˜ê²½ë³€ìˆ˜ ë° ê¸°ë³¸ê°’ ì´ˆê¸°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Initialize chaos configuration  # Chaos ì‹¤í–‰ì— í•„ìš”í•œ ì£¼ìš” ë³€ìˆ˜ ì„¤ì • ë‹¨ê³„
  ansible.builtin.set_fact:  # set_fact ëª¨ë“ˆë¡œ ë³€ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ì§€ì •
    chaos_log_path_final: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"  # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ ê¸°ë³¸ê°’ ì§€ì •
    chaos_duration_safe: "{{ lookup('env','CHAOS_DURATION') | default(chaos_duration | default(15), true) }}"  # Chaos ìœ ì§€ ì‹œê°„(ì´ˆ)
    random_pod_kill_count_safe: "{{ lookup('env','RANDOM_POD_KILL_COUNT') | default(random_pod_kill_count | default(2), true) }}"  # ë¬´ì‘ìœ„ë¡œ ì‚­ì œí•  Pod ê°œìˆ˜
    kill_mode: "{{ lookup('env','KILL_MODE') | default(kill_mode | default('internal'), true) }}"  # ì‹¤í–‰ ëª¨ë“œ ì„¤ì • (internal ë˜ëŠ” external)
    env_target_pods: "{{ lookup('env','TARGET_PODS') | default('', true) }}"  # CI/CD í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬ëœ Pod ëª©ë¡ ë¡œë“œ
  changed_when: false  # ë‹¨ìˆœ ë³€ìˆ˜ ì„¤ì •ì´ë¯€ë¡œ ë³€ê²½ìœ¼ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ

- name: Show configuration summary  # í˜„ì¬ ì„¤ì •ê°’ ì¶œë ¥
  ansible.builtin.debug:  # debug ëª¨ë“ˆë¡œ ë¡œê·¸ ì¶œë ¥
    msg: |  # ì—¬ëŸ¬ ì¤„ ì¶œë ¥ í˜•ì‹
      âš™ï¸ Pod Kill Chaos Configuration  # Chaos ì„¤ì • ìš”ì•½ ì‹œì‘
      - Mode: {{ kill_mode }}  # ì‹¤í–‰ ëª¨ë“œ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # Chaos ìœ ì§€ ì‹œê°„ í‘œì‹œ
      - Namespace: {{ target_namespace }}  # ëŒ€ìƒ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í‘œì‹œ
      - ENV Target Pods: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬ëœ íƒ€ê²Ÿ í‘œì‹œ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ íƒ€ê²Ÿ Pod í•´ì„ (internal / external ë¶„ë¦¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Resolve target pods (Ansible vs CI/CD)  # ì‹¤í–‰ ëª¨ë“œì— ë”°ë¼ íƒ€ê²Ÿ Podì„ ê²°ì •í•˜ëŠ” ë‹¨ê³„
  block:  # ë‚´ë¶€ì— ì—¬ëŸ¬ ì‘ì—…ì„ í¬í•¨í•˜ëŠ” ë¸”ë¡ ì‹œì‘

    # â”€â”€â”€â”€â”€ Internal ëª¨ë“œ â”€â”€â”€â”€â”€
    - name: Load internal targets from ENV only  # internal ëª¨ë“œì—ì„œëŠ” ENV ê¸°ë°˜ë§Œ í—ˆìš©
      when: kill_mode == "internal"  # ì¡°ê±´: internal ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
      block:  # ë‚´ë¶€ ë¸”ë¡ ì‹œì‘
        - name: Load from ENV  # í™˜ê²½ë³€ìˆ˜ì—ì„œ ëŒ€ìƒ Pod ë¡œë“œ
          ansible.builtin.set_fact:  # set_fact ëª¨ë“ˆ ì‚¬ìš©
            target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list if env_target_pods | length > 0 else [] }}"  # ì‰¼í‘œ êµ¬ë¶„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
          changed_when: false  # ë³€ê²½ í‘œì‹œ ì•ˆ í•¨

        - name: Fail if no internal targets specified  # internal ëª¨ë“œì—ì„œ íƒ€ê²Ÿ ëˆ„ë½ ì‹œ ì˜¤ë¥˜ ë°œìƒ
          ansible.builtin.fail:  # fail ëª¨ë“ˆë¡œ ëª…ì‹œì  ì‹¤íŒ¨ ì²˜ë¦¬
            msg: "âŒ internal ëª¨ë“œì—ì„œëŠ” TARGET_PODS í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” CLI ì¸ìë¡œ ëŒ€ìƒ Podì„ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤."  # ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
          when: target_pod_names | length == 0  # íƒ€ê²Ÿ ëª©ë¡ì´ ë¹„ì–´ìˆì„ ê²½ìš° ì‹¤í–‰

        - name: Debug internal targets  # internal ëª¨ë“œì—ì„œ íƒ€ê²Ÿ ì¶œë ¥
          ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
            msg: |  # ì—¬ëŸ¬ ì¤„ ë©”ì‹œì§€ ì¶œë ¥
              ğŸ¯ Internal Pod Kill Targets  # internal ëª¨ë“œ íƒ€ê²Ÿ ìš”ì•½
              - From ENV: {{ env_target_pods if env_target_pods|length > 0 else 'N/A' }}  # í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ íƒ€ê²Ÿ ì¶œë ¥
              - Effective: {{ target_pod_names | default([]) }}  # ìµœì¢… ì ìš©ëœ íƒ€ê²Ÿ ëª©ë¡ ì¶œë ¥

    # â”€â”€â”€â”€â”€ External ëª¨ë“œ â”€â”€â”€â”€â”€
    - name: Determine external targets (CI/CD)  # external ëª¨ë“œì—ì„œ CI/CD í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
      when: kill_mode == "external" and env_target_pods | length > 0  # ì¡°ê±´: external ëª¨ë“œ + í™˜ê²½ë³€ìˆ˜ ì¡´ì¬
      ansible.builtin.set_fact:  # set_fact ëª¨ë“ˆ ì‚¬ìš©
        target_pod_names: "{{ env_target_pods.split(',') | map('trim') | list }}"  # ENV ê°’ ì‰¼í‘œ ë¶„ë¦¬í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
      changed_when: false  # ë³€ê²½ ê°ì§€ ë¹„í™œì„±í™”

    - name: Determine external targets (Ansible local)  # external ëª¨ë“œì—ì„œ Ansible CLI ì‹¤í–‰ ì‹œ fallback ì‚¬ìš©
      when: kill_mode == "external" and env_target_pods | length == 0  # ì¡°ê±´: external ëª¨ë“œ + í™˜ê²½ë³€ìˆ˜ ì—†ìŒ
      block:  # ë‚´ë¶€ ë¸”ë¡ ì‹œì‘
        - name: Include pod_kill_targets.yml (Ansible fallback)  # íŒŒì¼ì—ì„œ fallback íƒ€ê²Ÿ ë¡œë“œ
          ansible.builtin.include_vars:  # include_vars ëª¨ë“ˆë¡œ ë³€ìˆ˜ ë¡œë“œ
            file: "{{ playbook_dir }}/../../pod_kill_targets.yml"  # pod_kill_targets.yml íŒŒì¼ ê²½ë¡œ
            name: pod_targets_fallback  # ë¡œë“œëœ ë³€ìˆ˜ ë„¤ì„ ì§€ì •
        - name: Set external targets from file  # íŒŒì¼ì—ì„œ ë¡œë“œí•œ Pod ëª©ë¡ ì ìš©
          ansible.builtin.set_fact:  # set_fact ëª¨ë“ˆ ì‚¬ìš©
            target_pod_names: "{{ pod_targets_fallback.pod_targets }}"  # fallback ì ìš©
          changed_when: false  # ë³€ê²½ ê°ì§€ ë¹„í™œì„±í™”
        - name: Debug external targets  # external ëª¨ë“œ íƒ€ê²Ÿ ë””ë²„ê·¸ ì¶œë ¥
          ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
            msg: |  # ì—¬ëŸ¬ ì¤„ ì¶œë ¥
              ğŸ¯ External Pod Kill Targets (Ansible)  # external ëª¨ë“œ íƒ€ê²Ÿ ëª©ë¡ ì¶œë ¥
              - From File: {{ pod_targets_fallback.pod_targets | default([]) }}  # íŒŒì¼ ê¸°ë°˜ íƒ€ê²Ÿ ì¶œë ¥

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Disable auto-recovery (ì„ íƒì )
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Disable ReplicaSets if requested  # ReplicaSet ìë™ ë³µêµ¬ ë°©ì§€ ì˜µì…˜
  when: disable_autorecover | default(false)  # disable_autorecover ë³€ìˆ˜ê°€ trueì¼ ë•Œë§Œ ì‹¤í–‰
  ansible.builtin.shell: |  # ì…¸ ëª…ë ¹ ì‹¤í–‰
    echo "[INFO] Disabling ReplicaSets..."  # ë¡œê·¸ ì¶œë ¥
    kubectl get rs -n {{ target_namespace }} -o name | xargs -r -I{} kubectl scale {} -n {{ target_namespace }} --replicas=0  # ëª¨ë“  ReplicaSetì„ 0ìœ¼ë¡œ ì¶•ì†Œ
  ignore_errors: yes  # ì¼ë¶€ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ (ê¶Œí•œ ë˜ëŠ” ReplicaSet ì—†ìŒ ë“±)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Internal Pod Kill
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Kill pods directly (internal)  # internal ëª¨ë“œì—ì„œ ì§ì ‘ Pod ì‚­ì œ ì‹¤í–‰
  when: kill_mode == "internal"  # ì¡°ê±´: internal ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
  ansible.builtin.shell: |  # ì…¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    if [ "{{ target_pod_names | default('') }}" != "" ]; then  # íƒ€ê²Ÿ Pod ì§€ì •ë¨
      PODS="{{ target_pod_names | join(' ') }}"  # ì§€ì •ëœ Pod ì´ë¦„ì„ ê³µë°±ìœ¼ë¡œ ì—°ê²°
    else  # íƒ€ê²Ÿì´ ì—†ì„ ê²½ìš°
      PODS=$(kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name | shuf -n {{ random_pod_kill_count_safe }})  # ë¬´ì‘ìœ„ Pod ì„ íƒ
    fi  # ì¡°ê±´ë¬¸ ì¢…ë£Œ
    echo "[INFO] Deleting pods: $PODS"  # ì‚­ì œ ë¡œê·¸ ì¶œë ¥
    for p in $PODS; do  # ê° Pod ë°˜ë³µë¬¸
      kubectl delete "$p" -n {{ target_namespace }} --grace-period=0 --force || echo "[WARN] Failed to delete $p"  # ê°•ì œ ì‚­ì œ ìˆ˜í–‰ ë° ì‹¤íŒ¨ ì‹œ ê²½ê³ 
    done  # forë¬¸ ì¢…ë£Œ
  register: internal_kill_result  # ì‹¤í–‰ ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ì €ì¥
  ignore_errors: yes  # ì‹¤íŒ¨ ì‹œ ì „ì²´ ì¤‘ë‹¨ ë°©ì§€
  changed_when: true  # ë³€ê²½ ë°œìƒìœ¼ë¡œ ê°„ì£¼

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ Fallback â€” internal ì‹¤íŒ¨ ì‹œ external ì „í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Switch to external if internal fails  # internal ì‹¤íŒ¨ ì‹œ external ëª¨ë“œë¡œ ì „í™˜
  when: kill_mode == "internal" and internal_kill_result.rc != 0  # ì¡°ê±´: internal ì‹¤íŒ¨
  ansible.builtin.set_fact:  # ë³€ìˆ˜ ì„¤ì •
    kill_mode: "external"  # external ëª¨ë“œë¡œ ë³€ê²½
  changed_when: true  # ë³€ê²½ìœ¼ë¡œ ê°„ì£¼

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6ï¸âƒ£ External Mode â€” helper podì„ í†µí•œ ì‚­ì œ (ê³µí†µ ë¼ë²¨ ì ìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Execute external pod kill per service  # external ëª¨ë“œì—ì„œ Chaos pod ì‹¤í–‰
  when: kill_mode == "external"  # ì¡°ê±´: external ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
  ansible.builtin.shell: |  # ì…¸ ëª…ë ¹ ì‹¤í–‰
    for svc in {{ target_pod_names | join(' ') }}; do  # ê° ëŒ€ìƒ ì„œë¹„ìŠ¤ ë°˜ë³µ
      echo "[EXTERNAL] Launching chaos pod for $svc..."  # ì‹œì‘ ë¡œê·¸ ì¶œë ¥
      SUFFIX=$(cat /proc/sys/kernel/random/uuid | cut -c1-6)  # 6ìë¦¬ UUID ìƒì„± (ì¤‘ë³µ ë°©ì§€)
      if [ "$svc" = "frontend" ]; then  # frontend ì„œë¹„ìŠ¤ì¼ ê²½ìš°
        TIER="frontend"  # tier ì„¤ì •
      elif [ "$svc" = "redis-cart" ]; then  # redis-cart ì„œë¹„ìŠ¤ì¼ ê²½ìš°
        TIER="data"  # ë°ì´í„° ê³„ì¸µ
      else  # ë‚˜ë¨¸ì§€ëŠ” backendë¡œ ë¶„ë¥˜
        TIER="backend"  # ê¸°ë³¸ backend
      fi  # ifë¬¸ ì¢…ë£Œ
      LABELS="app=$svc,app.kubernetes.io/name=$svc,app.kubernetes.io/part-of=online-boutique-chaos-lab,app.kubernetes.io/tier=$TIER,app.kubernetes.io/component=podkill-chaos"  # ê³µí†µ ë¼ë²¨ êµ¬ì„±
      kubectl run chaos-podkill-${svc}-${SUFFIX} \  # chaos pod ì‹¤í–‰ (UUID ì ‘ë¯¸ì‚¬ í¬í•¨)
        --image=nicolaka/netshoot:latest --restart=Never -n {{ target_namespace }} \  # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§€ì • ë° 1íšŒì„± pod
        --labels="$LABELS" \  # ë¼ë²¨ ì ìš©
        --overrides='{  # Pod ì •ì˜ ì˜¤ë²„ë¼ì´ë“œ ì‹œì‘
          "spec": {  # ìŠ¤í™ ë¸”ë¡
            "containers": [{  # ì»¨í…Œì´ë„ˆ ë°°ì—´ ì‹œì‘
              "name": "podkill",  # ì»¨í…Œì´ë„ˆ ì´ë¦„
              "image": "nicolaka/netshoot:latest",  # ì´ë¯¸ì§€ ì§€ì •
              "command": ["/bin/sh","-c"],  # ì…¸ ì‹¤í–‰ ëª…ë ¹
              "args": [  # ëª…ë ¹ ì¸ì ë°°ì—´ ì‹œì‘
                "set -eux; \  # ì˜¤ë¥˜ ì‹œ ì¤‘ë‹¨ + ë””ë²„ê·¸ ì¶œë ¥
                 echo \"[CHAOS] Deleting pod(s) for $svc ...\"; \  # ì‹œì‘ ë¡œê·¸
                 kubectl delete pod -n {{ target_namespace }} -l app=$svc --grace-period=0 --force || true; \  # íƒ€ê²Ÿ pod ì‚­ì œ
                 sleep {{ chaos_duration_safe }}; \  # chaos ìœ ì§€ ì‹œê°„ ëŒ€ê¸°
                 echo \"[RECOVERY] Chaos complete for $svc.\"; \  # ì™„ë£Œ ë¡œê·¸ ì¶œë ¥
                 echo \"[SELF-DELETE] Removing chaos pod...\"; \  # ìê¸° ìì‹  ì‚­ì œ ë¡œê·¸ ì¶œë ¥
                 kubectl delete pod $(hostname) -n {{ target_namespace }} --force --grace-period=0 || true;"  # ìê¸° ìì‹  ì‚­ì œ
              ]  # args ì¢…ë£Œ
            }]  # containers ì¢…ë£Œ
          }  # spec ì¢…ë£Œ
        }' || true  # ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
    done  # forë¬¸ ì¢…ë£Œ
  register: external_result  # ê²°ê³¼ ì €ì¥
  ignore_errors: yes  # ì¼ë¶€ ì‹¤íŒ¨ ë¬´ì‹œ
  changed_when: true  # ë³€ê²½ ê°ì§€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7ï¸âƒ£ ë¡œê·¸ ê¸°ë¡ ë° ì¢…ë£Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Append chaos result to log  # Chaos ì‹¤í–‰ ê²°ê³¼ë¥¼ ë¡œê·¸ì— ê¸°ë¡
  ansible.builtin.lineinfile:  # lineinfile ëª¨ë“ˆë¡œ íŒŒì¼ ìˆ˜ì •
    path: "{{ chaos_log_path_final }}"  # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ ì§€ì •
    create: yes  # íŒŒì¼ ì—†ìœ¼ë©´ ìƒì„±
    line: |  # ë¡œê·¸ í•œ ì¤„ ì‘ì„±
      [{{ ansible_date_time.iso8601 }}] PodChaos ns={{ target_namespace }} mode={{ kill_mode }} targets={{ target_pod_names | join(',') }} duration={{ chaos_duration_safe }}s  # ì‹¤í–‰ ê²°ê³¼ì™€ ì‹œê°„ ê¸°ë¡
  become: true  # ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ ì‘ì„±

- name: Final message  # ìµœì¢… ê²°ê³¼ ìš”ì•½ ì¶œë ¥
  ansible.builtin.debug:  # debug ëª¨ë“ˆ ì‚¬ìš©
    msg: |  # ì—¬ëŸ¬ ì¤„ ë©”ì‹œì§€ ì¶œë ¥
      âœ… Pod Chaos Completed  # ì™„ë£Œ ë©”ì‹œì§€
      - Mode: {{ kill_mode }}  # ì‹¤í–‰ ëª¨ë“œ í‘œì‹œ
      - Targets: {{ target_pod_names | join(', ') }}  # íƒ€ê²Ÿ ëª©ë¡ í‘œì‹œ
      - Duration: {{ chaos_duration_safe }}s  # ìœ ì§€ ì‹œê°„ í‘œì‹œ
      - Log: {{ chaos_log_path_final }}  # ë¡œê·¸ íŒŒì¼ ê²½ë¡œ í‘œì‹œ
