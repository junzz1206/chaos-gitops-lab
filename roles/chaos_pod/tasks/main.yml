# Î™©Ï†Å:
#   - ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ ÎÇ¥ ÌäπÏ†ï ÎòêÎäî Î¨¥ÏûëÏúÑ Pod ÏÇ≠Ï†ú (ÎùºÎ≤® Í∏∞Î∞ò)
#   - disable_autorecover=true Ïãú ReplicaSet ÏûêÎèôÎ≥µÍµ¨ Ï∞®Îã®
#   - chaos_log_path_finalÏóê Í≤∞Í≥º Í∏∞Î°ù
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Step 0Ô∏è‚É£: Safety Checks
- name: "Safety Check - ensure target_namespace variable exists"
  ansible.builtin.assert:
    that:
      - target_namespace is defined
    fail_msg: "‚ùå target_namespace Î≥ÄÏàòÍ∞Ä Ï†ïÏùòÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§. Ïòà: -e 'target_namespace=app'"
    success_msg: "‚úÖ target_namespace Î≥ÄÏàò ÌôïÏù∏Îê®: {{ target_namespace }}"

- name: "Safety Check - ensure running in test namespace 'app' by default"
  ansible.builtin.assert:
    that:
      - (target_namespace | default('app')) == "app"
    fail_msg: "‚ö†Ô∏è ÏïàÏ†ÑÏû•Ïπò: target_namespaceÍ∞Ä 'app'Ïù¥ ÏïÑÎãôÎãàÎã§. Chaos ÌÖåÏä§Ìä∏ Ï†Ñ ÌôïÏù∏ ÌïÑÏöî."
    success_msg: "‚úÖ namespace ÏïàÏ†ÑÍ≤ÄÏÇ¨ ÌÜµÍ≥º ({{ target_namespace }})"

# Step 1Ô∏è‚É£: Variable Initialization
- name: "Set defaults for optional variables (safe defaults)"
  ansible.builtin.set_fact:
    chaos_log_path_final: "{{ chaos_log_path | default('/var/log/chaos_test.log') }}"
    random_pod_kill_count_safe: "{{ (random_pod_kill_count | int) if (random_pod_kill_count is defined and (random_pod_kill_count | int) > 0) else 2 }}"
    chaos_duration_safe: "{{ (chaos_duration | int) if (chaos_duration is defined and (chaos_duration | int) > 0) else 10 }}"
  changed_when: false

- name: "Display run parameters"
  ansible.builtin.debug:
    msg: |
      üß® Chaos Pod Kill ÏãúÏûë
      - namespace: {{ target_namespace }}
      - delete_count: {{ random_pod_kill_count_safe }}
      - chaos_duration: {{ chaos_duration_safe }}Ï¥à
      - log_path: {{ chaos_log_path_final }}
      - target_pod_names: {{ target_pod_names | join(', ') if (target_pod_names is defined and target_pod_names | length > 0) else 'ÏóÜÏùå (ÎûúÎç§ ÎåÄÏÉÅ)' }}
      - disable_autorecover: {{ disable_autorecover | default(false) }}

# Step 2Ô∏è‚É£: Disable auto-recover (optional)
- name: "Find ReplicaSets in target namespace"
  when: disable_autorecover | default(false)
  ansible.builtin.shell: |
    kubectl get rs -n {{ target_namespace }} -o jsonpath='{.items[*].metadata.name}'
  register: rs_list_raw
  changed_when: false

- name: "Scale down all ReplicaSets to disable auto recovery"
  when: disable_autorecover | default(false)
  ansible.builtin.shell: |
    for rs in {{ rs_list_raw.stdout }}; do
      echo "Scaling down ReplicaSet: $rs"
      kubectl scale rs "$rs" -n {{ target_namespace }} --replicas=0 || true
    done
  ignore_errors: yes
  changed_when: true

# Step 3Ô∏è‚É£: Resolve actual pods dynamically by label
- name: "Resolve real pod names from labels"
  when: target_pod_names is defined and target_pod_names | length > 0
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} -l app={{ item }} -o jsonpath='{.items[*].metadata.name}'
  loop: "{{ target_pod_names }}"
  register: resolved_pods
  changed_when: false

- name: "Collect resolved pod names"
  when: target_pod_names is defined and target_pod_names | length > 0
  ansible.builtin.set_fact:
    selected_pods: "{{ resolved_pods.results | map(attribute='stdout') | map('split') | sum(start=[]) }}"
  changed_when: false

# Step 4Ô∏è‚É£: If no specific targets, select random running pods
- name: "Get running pods in namespace (random mode)"
  when: target_pod_names is not defined or target_pod_names | length == 0
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name --no-headers
  register: all_pods
  changed_when: false

- name: "Select random pods for chaos"
  when: target_pod_names is not defined or target_pod_names | length == 0
  ansible.builtin.set_fact:
    selected_pods: "{{ (all_pods.stdout_lines | shuffle)[: (random_pod_kill_count_safe | int)] }}"
  changed_when: false

- name: "Debug - show selected pods"
  ansible.builtin.debug:
    msg: "üóëÔ∏è  ÏÇ≠Ï†ú ÎåÄÏÉÅ Pod: {{ selected_pods }}"

# Step 5Ô∏è‚É£: Delete selected pods (forced)
- name: "Delete selected pods (grace-period=0, force)"
  ansible.builtin.shell: |
    set -eux
    for p in {{ selected_pods | join(' ') }}; do
      echo "Deleting pod: $p"
      kubectl delete pod "$p" -n {{ target_namespace }} --grace-period=0 --force || echo "‚ùó kubectl delete failed for $p"
    done
  register: kill_result
  ignore_errors: yes
  changed_when: true

- name: "Write deletion stdout to debug"
  ansible.builtin.debug:
    var: kill_result.stdout_lines

# Step 6Ô∏è‚É£: Wait for chaos_duration
- name: "Pause to allow scheduler to react"
  ansible.builtin.pause:
    seconds: "{{ chaos_duration_safe }}"

# Step 7Ô∏è‚É£: Verify state
- name: "Check Running pods after chaos"
  ansible.builtin.shell: |
    kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running --no-headers | wc -l
  register: recovery_count
  changed_when: false

- name: "Show running pod count after chaos"
  ansible.builtin.debug:
    msg: "üìä Post-chaos Running pod count: {{ recovery_count.stdout }}"

# Step 8Ô∏è‚É£: Re-enable auto recovery
- name: "Re-enable ReplicaSet auto recovery (scale up)"
  when: disable_autorecover | default(false)
  ansible.builtin.shell: |
    for rs in {{ rs_list_raw.stdout }}; do
      echo "Restoring ReplicaSet: $rs"
      kubectl scale rs "$rs" -n {{ target_namespace }} --replicas=1 || true
    done
  ignore_errors: yes
  changed_when: true

# Step 9Ô∏è‚É£: Persist log
- name: "Persist chaos result to log"
  ansible.builtin.lineinfile:
    path: "{{ chaos_log_path_final }}"
    create: true
    line: |
      [{{ ansible_date_time.iso8601 }}] PodChaos: ns={{ target_namespace }} deleted={{ selected_pods | join(',') }} count={{ selected_pods | length }} running_after={{ recovery_count.stdout }}
  become: true
  when: recovery_count is defined

# Step üîü: Summary
- name: "Final debug summary"
  ansible.builtin.debug:
    msg: |
      ‚úÖ Chaos Pod Kill ÏôÑÎ£å.
      - namespace: {{ target_namespace }}
      - deleted_pods: {{ selected_pods | join(', ') }}
      - total_deleted: {{ selected_pods | length }}
      - running_after: {{ recovery_count.stdout }}
