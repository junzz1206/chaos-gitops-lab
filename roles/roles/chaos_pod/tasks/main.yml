# roles/chaos_pod/tasks/main.yml
# 목적: 네임스페이스 내 Running 상태의 임의(무작위) Pod n개를 삭제하고 복구 상태를 확인하여 로그를 남김
# 표준 변수:
#   target_namespace: 실험 대상 네임스페이스 (기본: "app")
#   random_pod_kill_count: 삭제할 무작위 Pod 개수 (기본: 1)
#   chaos_duration: 주입 유지 시간 (예: "10s") -> 삭제 후 대기 시간으로 활용 (선택)
#   chaos_log_path: 로그 파일 경로 (기본: /var/log/chaos_test.log)
# 주의: 모든 kubectl 명령은 컨트롤러(Ansible 실행 호스트)에서 kubeconfig가 설정되어 있어야 함.

- name: "Safety Check - ensure target_namespace variable exists"                    # 작업명: 네임스페이스 변수 존재 확인
  ansible.builtin.assert:                                                          # assert 모듈 사용
    that:                                                                          # 검증 조건 시작
      - target_namespace is defined                                                # target_namespace가 정의되어야 함
    fail_msg: "target_namespace 변수가 정의되어 있지 않습니다. -e 'target_namespace=app' 같이 지정해 주세요."  # 실패 메시지
    success_msg: "target_namespace 변수 확인됨: {{ target_namespace }}"           # 성공 메시지

- name: "Safety Check - ensure running in test namespace 'app' by default"         # 작업명: 기본 네임스페이스 안전 검증
  ansible.builtin.assert:                                                          # assert 모듈 사용
    that:
      - (target_namespace | default('app')) == "app"                               # 기본값 'app'과 비교
    fail_msg: "안전장치: target_namespace가 'app'이 아닙니다. 테스트 전 확인 필요."  # 실패 메시지
    success_msg: "namespace 안전검사 통과 ({{ target_namespace }})"                # 성공 메시지

- name: "Set defaults for optional variables"                                       # 작업명: 선택 변수 기본값 설정
  ansible.builtin.set_fact:                                                        # set_fact로 로컬 기본값 설정
    random_pod_kill_count: "{{ (random_pod_kill_count | default(1)) | int }}"      # random_pod_kill_count 기본 1로 정수화
    chaos_log_path: "/var/log/chaos_test.log"    # 로그 경로 기본값 설정
  changed_when: false                                                               # 변수 설정은 변경 아님

- name: "Display run parameters"                                                    # 작업명: 실행 파라미터 출력
  ansible.builtin.debug:                                                           # debug 모듈로 사람이 읽을 수 있게 출력
    msg: |
      Running Random Pod Kill with parameters:
      - namespace: {{ target_namespace }}
      - delete_count: {{ random_pod_kill_count }}
      - chaos_duration: {{ chaos_duration | default('not set') }}
      - log_path: {{ chaos_log_path }}

- name: "Get running pods in namespace"                                             # 작업명: 네임스페이스의 Running 상태 Pod 목록 조회
  ansible.builtin.shell:                                                           # shell 모듈로 kubectl 실행
    cmd: "kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running -o name --no-headers"
  register: all_pods                                                                 # 결과를 all_pods 변수에 저장
  changed_when: false                                                               # 조회는 변경으로 간주하지 않음

- name: "Abort if no running pods found"                                            # 작업명: Running Pod 없으면 중단
  ansible.builtin.fail:                                                            # fail 모듈로 명확히 실패 처리
    msg: "namespace '{{ target_namespace }}' 내 Running 상태의 Pod가 없습니다. 테스트 중지."
  when: all_pods.stdout == ""                                                       # stdout이 빈 문자열이면 실패

- name: "Prepare list of pods for random selection"                                 # 작업명: Pod 리스트를 배열로 변환
  ansible.builtin.set_fact:                                                        # set_fact로 pod_lines 변수 설정
    pod_lines: "{{ all_pods.stdout_lines | map('trim') | reject('equalto','') | list }}"  # 빈행 제거 후 리스트화
  changed_when: false

- name: "Debug - show candidate pods"                                               # 작업명: 후보 Pod 목록 출력
  ansible.builtin.debug:
    var: pod_lines

- name: "Select random pods to delete"                                              # 작업명: 무작위로 삭제 대상 Pod 선택
  ansible.builtin.set_fact:
    selected_pods: >-
      {{ pod_lines | default([]) | shuffle | slice(0, (random_pod_kill_count | int)) | list }}
  changed_when: false

- name: "Abort if no pods selected (after random selection)"                        # 작업명: 선택 결과가 없으면 중단
  ansible.builtin.fail:
    msg: "무작위 선택 결과 삭제할 Pod이 없습니다. candidate_count={{ pod_lines | length }} selected_count={{ selected_pods | length }}"
  when: selected_pods | length == 0

- name: "Debug - show selected pods to be deleted"                                  # 작업명: 실제 삭제 대상 출력
  ansible.builtin.debug:
    msg: "Selected pods for deletion: {{ selected_pods }}"

- name: "Delete selected pods (forced, grace-period=0)"                             # 작업명: 선택된 Pod들 강제 삭제 루프
  ansible.builtin.shell:
    cmd: |
      set -eux
      for p in {{ selected_pods | join(' ') }}; do
        echo "Deleting pod: $p"
        kubectl delete $p -n {{ target_namespace }} --grace-period=0 --force || echo "kubectl delete returned non-zero for $p"
      done
  register: kill_result                                                              # 삭제 결과 저장
  ignore_errors: yes                                                                # 일부 실패시에도 플레이 계속
  changed_when: true                                                                # 삭제 시 변경으로 표기

- name: "Write deletion stdout to debug"                                             # 작업명: 삭제 명령 출력 간단 표시
  ansible.builtin.debug:
    var: kill_result.stdout_lines

- name: "Pause briefly to allow scheduler to react"                                 # 작업명: 삭제 후 스케줄러 반응 대기
  ansible.builtin.pause:
    seconds: "{{ (chaos_duration | default('10s')) | regex_replace('s$','') | int }}"   # chaos_duration에서 's' 제거 후 초로 사용, 기본 10초

- name: "Check number of Running pods after deletion"                               # 작업명: 삭제 후 Running 상태 Pod 수 조회
  ansible.builtin.shell:
    cmd: "kubectl get pods -n {{ target_namespace }} --field-selector=status.phase=Running --no-headers | wc -l"
  register: recovery_count
  changed_when: false

- name: "Debug - show running pod count after recovery"                             # 작업명: 복구된 Pod 수 출력
  ansible.builtin.debug:
    msg: "Post-chaos Running pod count in {{ target_namespace }}: {{ recovery_count.stdout }}"

- name: "Collect non-running pods (optional) for investigation"                     # 작업명: 비정상 상태 Pod 목록 수집 (디버깅용)
  ansible.builtin.shell:
    cmd: "kubectl get pods -n {{ target_namespace }} --field-selector=status.phase!=Running -o wide --no-headers || true"
  register: non_running_pods
  changed_when: false

- name: "Debug - show non-running pods (if any)"                                     # 작업명: 비정상 Pod 출력
  ansible.builtin.debug:
    var: non_running_pods.stdout_lines

- name: "Persist chaos execution result to log file"                                # 작업명: 결과를 로그 파일에 기록
  ansible.builtin.lineinfile:
    path: "{{ chaos_log_path }}"                                                    # 로그 파일 경로
    create: true                                                                    # 파일이 없으면 생성
    line: |
      [{{ ansible_date_time.iso8601 }}] RandomPodChaos: namespace={{ target_namespace }} deleted={{ selected_pods | join(',') }} deleted_count={{ selected_pods | length }} running_after={{ recovery_count.stdout }} non_running={{ non_running_pods.stdout_lines | default('None') | join(' ; ') }}
  become: true                                                                     # 로그는 루트 권한으로 기록
  when: recovery_count is defined                                                   # recovery_count가 있으면 기록

- name: "Final debug summary"                                                       # 작업명: 요약 출력
  ansible.builtin.debug:
    msg: |
      Random Pod Kill completed.
      - namespace: {{ target_namespace }}
      - deleted: {{ selected_pods | join(',') }}
      - deleted_count: {{ selected_pods | length }}
      - running_after: {{ recovery_count.stdout }}
      - non_running_details: {{ non_running_pods.stdout_lines | default(['None']) }}

