---
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# chaos-experiment.yaml â€” ì‡¼í•‘ëª° í†µí•© ì¹´ì˜¤ìŠ¤ í…ŒìŠ¤íŠ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ’£ Unified Chaos Engineering Experiment for App + DB
  hosts: k3s_master
  become: yes
  vars:
    chaos_duration: 60                # í…ŒìŠ¤íŠ¸ ì§€ì† ì‹œê°„ (ì´ˆ)
    cpu_load: 90                      # CPU ë¶€í•˜ìœ¨ (%)
    network_delay_ms: 1000            # ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì‹œê°„ (ms)
    target_namespace: "default"       # íƒ€ê²Ÿ ë„¤ì„ìŠ¤í˜ì´ìŠ¤

  tasks:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§© APP / REDIS Layer
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: ğŸ’€ 1. cartservice Pod Kill
    include_role:
      name: chaos_kill
    vars:
      target_pod: "cartservice"
      namespace: "{{ target_namespace }}"
    tags: [cartservice, kill]

  - name: ğŸŒ 2. redis-cart Network Latency
    include_role:
      name: chaos_network
    vars:
      target_pod: "redis-cart"
      delay_ms: "{{ network_delay_ms }}"
      duration: "{{ chaos_duration }}"
      namespace: "{{ target_namespace }}"
    tags: [redis, network]

  - name: ğŸ’€ 3. paymentservice Kill
    include_role:
      name: chaos_kill
    vars:
      target_pod: "paymentservice"
      namespace: "{{ target_namespace }}"
    tags: [payment, kill]

  - name: ğŸ”¥ 4. checkoutservice CPU Stress
    include_role:
      name: chaos_cpu
    vars:
      target_pod: "checkoutservice"
      cpu_load: "{{ cpu_load }}"
      duration: "{{ chaos_duration }}"
      namespace: "{{ target_namespace }}"
    tags: [checkout, cpu]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§© RDB / ORDER-HISTORY Layer
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: ğŸ’€ 5. orders-db Pod Kill
    include_role:
      name: chaos_kill
    vars:
      target_pod: "orders-db"
      namespace: "{{ target_namespace }}"
    tags: [ordersdb, kill]

  - name: ğŸŒ 6. orders-db Network Isolation
    include_role:
      name: chaos_network
    vars:
      target_pod: "orders-db"
      delay_ms: 0                     # ì™„ì „ ì°¨ë‹¨ (0ìœ¼ë¡œ ì„¤ì •)
      duration: "{{ chaos_duration }}"
      drop_mode: true                 # tc/qdisc drop ëª¨ë“œ í™œì„±í™”
      namespace: "{{ target_namespace }}"
    tags: [ordersdb, network, isolation]

  - name: ğŸŒ 7. orders-db Network Latency
    include_role:
      name: chaos_network
    vars:
      target_pod: "orders-db"
      delay_ms: "{{ network_delay_ms }}"
      duration: "{{ chaos_duration }}"
      namespace: "{{ target_namespace }}"
    tags: [ordersdb, latency]

  - name: âš™ï¸ 8. orders-db Connection Pool Exhaustion (config stress)
    shell: |
      POD=$(kubectl get pod -n {{ target_namespace }} -l app=orders-db -o name | head -n 1)
      kubectl exec -n {{ target_namespace }} $POD -- psql -U postgres -d orderdb -c "ALTER SYSTEM SET max_connections = 5;"
      kubectl rollout restart statefulset orders-db -n {{ target_namespace }}
    ignore_errors: yes
    tags: [ordersdb, config]

  - name: âœ… Chaos test completed summary
    debug:
      msg: |
        âœ… Chaos experiments finished.
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - cartservice       â†’ Pod Kill
        - redis-cart        â†’ Network Delay
        - paymentservice    â†’ Pod Kill
        - checkoutservice   â†’ CPU Stress
        - orders-db         â†’ Pod Kill + Network + Config
        Duration: {{ chaos_duration }}s
        Namespace: {{ target_namespace }}

