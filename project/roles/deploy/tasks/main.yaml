---
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# deploy: K3s í´ëŸ¬ìŠ¤í„° ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ + Helm í†µí•©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: Ensure K3s is installed
  shell: which k3s
  register: k3s_check
  failed_when: k3s_check.rc != 0

- name: Copy application manifests
  copy:
    src: ../../files/app-manifests/
    dest: /tmp/app-manifests/
    mode: '0644'

- name: Apply manifests to K3s cluster
  shell: |
    kubectl apply -f /tmp/app-manifests/
  args:
    executable: /bin/bash
  ignore_errors: yes

- name: Wait for pods to become ready
  shell: |
    kubectl wait --for=condition=Ready pod --all --timeout=120s -A
  ignore_errors: yes

- name: Display running services
  shell: kubectl get pods -A -o wide
  register: deploy_output

- debug:
    var: deploy_output.stdout


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§© Helm Integration Section
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- name: ğŸš€ Ensure Helm is installed
  ansible.builtin.shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm

- name: ğŸ§± Deploy application using Helm
  ansible.builtin.command: >
    helm upgrade --install my-app ./charts/my-app
    --namespace default
    --create-namespace
  args:
    chdir: "{{ playbook_dir }}/../../"  # charts ë””ë ‰í„°ë¦¬ ìƒëŒ€ ê²½ë¡œ (project ë£¨íŠ¸)
  register: helm_output

- debug:
    msg: |
      ğŸ§© Helm deployment complete!
      {{ helm_output.stdout }}
